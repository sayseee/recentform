<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap" rel="stylesheet">
  <title>Football Tournaments</title>
  <style>
    .rF-4 {
  font-family: "Roboto Flex", sans-serif;
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
  font-variation-settings:
    "slnt" 0,
    "wdth" 100,
    "GRAD" 0,
    "XOPQ" 96,
    "XTRA" 468,
    "YOPQ" 79,
    "YTAS" 750,
    "YTDE" -203,
    "YTFI" 738,
    "YTLC" 514,
    "YTUC" 712;
}
    .rF-5 {
  font-family: "Roboto Flex", sans-serif;
  font-optical-sizing: auto;
  font-weight: 500;
  font-style: normal;
  font-variation-settings:
    "slnt" 0,
    "wdth" 100,
    "GRAD" 0,
    "XOPQ" 96,
    "XTRA" 468,
    "YOPQ" 79,
    "YTAS" 750,
    "YTDE" -203,
    "YTFI" 738,
    "YTLC" 514,
    "YTUC" 712;
}
    .rF-6 {
  font-family: "Roboto Flex", sans-serif;
  font-optical-sizing: auto;
  font-weight: 600;
  font-style: normal;
  font-variation-settings:
    "slnt" 0,
    "wdth" 100,
    "GRAD" 0,
    "XOPQ" 96,
    "XTRA" 468,
    "YOPQ" 79,
    "YTAS" 750,
    "YTDE" -203,
    "YTFI" 738,
    "YTLC" 514,
    "YTUC" 712;
}
:root {
        --color-white20p: rgb(48, 125, 153);
        --color-black1: rgb(3,5,7);
}
    body {
        background-color:rgb(0, 0, 0);
        color:rgb(219, 222, 218);
        font-size: 11px;
        margin: 10px;
        display: flex;
        flex-direction: column; 
        height: 100vh;
        overflow: hidden;
    }
    a {
      text-decoration: none;
      color:rgb(219, 222, 218);
    }
h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
}
li {
  list-style: none;
}
.scrollable {
  overflow-y: auto;
  overflow-x: hidden; 
}

/* Custom scrollbar for WebKit browsers (Chrome, Safari) */
.scrollable::-webkit-scrollbar {
    width: 5px; /* Set scrollbar width to 1px */
    height: 5px; /* Set scrollbar width to 1px */
}

.scrollable::-webkit-scrollbar-track {
  background: var(--color-black1); /* Track color */
}

.scrollable::-webkit-scrollbar-thumb {
  background: var(--color-white20p); /* Thumb color */
  border-radius: 1px; /* Rounded corners for the thumb */
}

.main {
  display: flex;
  background-color: rgb(40, 40, 40);
  border: 1px solid rgb(74, 74, 74);
  flex: 1;
  flex-direction: row;
  height: 100vh;
}

#categories ul, #tournaments ul {
  margin: 0;
  padding: 0;
}

#categories li, #tournaments li {
  margin: 0;
  list-style: none;
} 
#categories  {
  flex: 0.8;
}
.tournaments {
  background-color:rgb(0, 0, 0);
  border-right: 1px solid rgba(40, 40, 40, 0.8);
  border-left: 1px solid rgba(40, 40, 40, 0.8);
  flex: 1.2;
} 
.tournament-details {
  flex: 5.8;
  display: flex;
  flex-direction: column;
}
#tournament-details, #tournament-details ul {
  display: flex;
  align-items: center;
  gap: 10px;
}
#tournament-details div {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  padding: 0 10px;
}
#tournament-details img {
    height: 70px;
}
#categories a {
  color: rgb(128, 128, 128);
  padding: 3px 0 3px 10px;
  display: flex;
  align-items: center;
} 

.tournaments h2 {
  font-size: 12px;
  text-transform: uppercase;
  text-align: center;
} 
#tournaments a {
  color: rgb(223, 189, 106);
  padding: 3px 0 3px 10px;
  display: flex;
  align-items: center;
} 
#categories li:nth-child(even) {
  background-color:rgb(0, 0, 0);
  border-right: 1px solid rgba(40, 40, 40, 0.8);
}
#tournaments li {
  border-bottom: 1px solid rgba(40, 40, 40, 0.8);
  padding-right: 10px;
}
.tournament-data {
  display: flex;
  flex-direction: row;
  align-items: center;
    background-color: white;
    color: rgb(40, 40, 40);
    justify-content: space-between;

}
#rounds, #rounds ul {
  display: flex;
  align-items: center;
}
#rounds {
  display: flex; /* Make the container a flexbox */
  align-items: center; /* Vertically center the content */
  border-bottom: 1px solid #666;
}

#rounds h4 {
    width: 50px;
    margin: 0;
    padding: 12px 10px;
    color: white;
    text-transform: uppercase;
    border-right: 1px solid #666;
    margin-right: 10px;
}

#rounds ul {
  flex-grow: 1; /* Allow the list to grow and fill the remaining space */
  margin: 0; /* Remove default margin */
  padding: 0; /* Remove default padding */
  list-style: none; /* Remove default list styling */
  display: flex; /* Make the list a flex container */
  flex-wrap: nowrap; /* Allow list items to wrap to the next line */
  gap: 1px;
  overflow-x: auto;
  margin-right: 10px;
}

#rounds ul li { 
  text-align: center; /* Center the text inside list items */
}

#rounds ul li a {
  text-decoration: none; /* Remove underline from links */
  color: white; /* Set link text color */
  padding:2px 8px; /* Add padding to links */
  background-color: rgba(255, 255, 255, 0.1); /* Default background color */
  display: block; /* Make links fill the entire list item */
}

#rounds ul li a:hover {
  background-color: rgba(255, 255, 255, 0.2); /* Hover background color */
}

#season-info .stats {
  display: flex; /* Arrange stats in a row */
  gap: 15px; /* Add spacing between stats */
  flex-wrap: wrap; /* Allow wrapping if the container is too small */
}

#season-info .stats div {
  background-color: rgba(255, 255, 255, 0.1); /* Light background for each stat */
  padding: 5px 10px; /* Add padding */
  border-radius: 4px; /* Rounded corners */
  font-size: 14px;
}
  </style>
</head>
<body class="rF-4">
  <div class="main">
    <div id="categories" class="scrollable"></div>  
    <div class="tournaments scrollable">
      <h2><span id="selected-country"></span></h2>
      <div id="tournaments"></div>
    </div>

    <div class="tournament-details scrollable"> 
      <div class="tournament-data">
        <div id="tournament-details"></div>
        <!-- Season Selector Dropdown -->
        <select id="season-select"></select> 
        <!-- Season Info -->
        <div id="season-info"></div>
      </div>  
        
      <div id="tournament-events"></div>
      <!-- groups Info -->
      <div id="groups"></div>
    </div>
</div>

  <script>

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').then((registration) => {
        //console.log('Service Worker registered with scope:', registration.scope);
      }).catch((error) => {
        //console.error('Service Worker registration failed:', error);
      });
    });
  }


  let cachedEvents = null; // Global variable to store cached events

// Fetch and cache scheduled events
function fetchAndCacheScheduledEvents(date) {
  const scheduledEventsUrl = `https://api.sofascore.com/api/v1/sport/football/scheduled-events/${date}`;
  const inverseScheduledEventsUrl = `https://api.sofascore.com/api/v1/sport/football/scheduled-events/${date}/inverse`;

  return Promise.all([
    fetch(scheduledEventsUrl).then(response => response.json()),
    fetch(inverseScheduledEventsUrl).then(response => response.json())
  ])
    .then(([scheduledData, inverseData]) => {
      cachedEvents = [...scheduledData.events, ...inverseData.events]; // Cache the events
      return cachedEvents;
    })
    .catch(error => {
      console.error('Error fetching scheduled events:', error);
      return [];
    });
}

// Fetch and display categories with scheduled events
function fetchCategories() {
  const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format

  // Fetch and cache scheduled events
  fetchAndCacheScheduledEvents(today)
    .then(events => {
      const categoriesWithEvents = new Set(); // Use a Set to store unique category IDs
      const tournamentsWithEvents = new Set(); // Use a Set to store unique tournament IDs

      // Loop through events and collect unique category and tournament IDs
      events.forEach(event => {
        categoriesWithEvents.add(event.tournament.category.id);
        tournamentsWithEvents.add(event.tournament.uniqueTournament.id);
      });

      // Fetch all categories
      fetch('https://www.sofascore.com/api/v1/sport/football/categories')
        .then(response => response.json())
        .then(categoriesData => {
          const categoriesContainer = document.getElementById('categories');
          categoriesContainer.innerHTML = '';

          // Filter categories to only include those with scheduled events
          const filteredCategories = categoriesData.categories.filter(category =>
            categoriesWithEvents.has(category.id)
          );

          // Sort filtered categories by priority (descending) and then alphabetically for priority 0
          const sortedCategories = filteredCategories.sort((a, b) => {
            if (a.priority === 0 && b.priority === 0) {
              return a.name.localeCompare(b.name);
            } else if (a.priority === 0) {
              return 1;
            } else if (b.priority === 0) {
              return -1;
            } else {
              return b.priority - a.priority;
            }
          });

          // Create a <ul> element to hold the category links
          const categoryList = document.createElement('ul');
          categoriesContainer.appendChild(categoryList);

          // Loop through sorted categories and create <li> links
          sortedCategories.forEach((category, index) => {
            const listItem = document.createElement('li');
            const categoryLink = document.createElement('a');
            categoryLink.href = '#'; // Use a placeholder href
            categoryLink.textContent = category.name;
            categoryLink.onclick = (e) => {
              e.preventDefault(); // Prevent the default link behavior
              fetchTournaments(category.id, category.name, tournamentsWithEvents);
            };

            listItem.appendChild(categoryLink);
            categoryList.appendChild(listItem);

            // Auto-click the first category to load its tournaments
            if (index === 0) {
              fetchTournaments(category.id, category.name, tournamentsWithEvents);
            }
          });
        })
        .catch(error => console.error('Error fetching categories:', error));
    })
    .catch(error => console.error('Error fetching scheduled events:', error));
}

// Fetch tournaments for a selected category
function fetchTournaments(categoryId, categoryName, tournamentsWithEvents) {
  document.getElementById('selected-country').textContent = categoryName;

  fetch(`https://www.sofascore.com/api/v1/category/${categoryId}/unique-tournaments`)
    .then(response => response.json())
    .then(data => {
      const tournamentsContainer = document.getElementById('tournaments');
      tournamentsContainer.innerHTML = '';

      // Ensure groups exist in data before accessing them
      if (data.groups && data.groups.length > 0) {
        // Create a <ul> element to hold the tournament links
        const tournamentList = document.createElement('ul');
        tournamentsContainer.appendChild(tournamentList);

        // Filter tournaments to only include those with scheduled events
        const filteredTournaments = data.groups.flatMap(group =>
          group.uniqueTournaments.filter(tournament => 
            tournamentsWithEvents.has(tournament.id)
          ) // <- Closing parenthesis was missing
        );

        // Display the filtered tournaments
        if (filteredTournaments.length > 0) {
          filteredTournaments.forEach((tournament, index) => {
            const listItem = document.createElement('li');
            const tournamentLink = document.createElement('a');
            tournamentLink.href = '#'; // Use a placeholder href
            tournamentLink.textContent = tournament.name;
            tournamentLink.onclick = (e) => {
              e.preventDefault(); // Prevent the default link behavior
              fetchTournamentDetails(tournament.id);
            };

            listItem.appendChild(tournamentLink);
            tournamentList.appendChild(listItem);

            // Auto-click the first tournament to load its details
            if (index === 0) {
              fetchTournamentDetails(tournament.id);
            }
          });
        } else {
          tournamentsContainer.textContent = 'No tournaments with events found.';
        }
      } else {
        tournamentsContainer.textContent = 'No tournaments available for this category.';
      }
    })
    .catch(error => console.error('Error fetching tournaments:', error));
}
// Fetch events for a specific tournament (no need for rounds)
function fetchEventsForTournament(tournamentId, tournamentName) {
  const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
  // No need to check for rounds here, just fetch scheduled events directly
  fetchScheduledEvents(tournamentId, today);
}

// Fetch scheduled events for a specific date (including inverse events)
function fetchScheduledEvents(tournamentId, date) {
  if (cachedEvents) {
    // Use cached events if available
    const filteredEvents = cachedEvents.filter(event =>
      event.tournament.uniqueTournament.id === tournamentId
    );
    displayEventsInTable(filteredEvents, tournamentId, date);
  } else {
    // Fetch and cache events if not already cached
    fetchAndCacheScheduledEvents(date)
      .then(events => {
        const filteredEvents = events.filter(event =>
          event.tournament.uniqueTournament.id === tournamentId
        );
        displayEventsInTable(filteredEvents, tournamentId, date);
      })
      .catch(error => console.error('Error fetching scheduled events:', error));
  }
}
// Display events in a table
function displayEventsInTable(events, tournamentId, date) {
  const eventsContainer = document.getElementById('tournament-events');
  eventsContainer.innerHTML = ''; // Clear previous content

  // Create a table element for the event display
  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr>
        <th>Home</th>
        <th>Away</th>
        <th>1</th>
        <th>X</th>
        <th>2</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  `;
  eventsContainer.appendChild(table);

  // Fetch odds for the events (if needed)
  const oddsUrl = `https://www.sofascore.com/api/v1/sport/football/odds/1/${date}`;
  fetch(oddsUrl)
    .then(response => response.json())
    .then(oddsData => {
      // Loop through events and create table rows
      events.forEach(event => {
        const eventId = event.id;
        const homeTeam = event.homeTeam.shortName;
        const awayTeam = event.awayTeam.shortName;

        // Default values for odds
        let odds1 = '-';
        let oddsX = '-';
        let odds2 = '-';

        // Find the odds for this event (if available) by checking if the eventId exists in the odds data
        const eventOdds = oddsData.odds[eventId];
        if (eventOdds) {
          const choices = eventOdds.choices || [];
          console.log(eventOdds);

          // Find the odds for '1', 'X', and '2'
          odds1 = choices.find(choice => choice.name === '1')?.fractionalValue || '-';
          oddsX = choices.find(choice => choice.name === 'X')?.fractionalValue || '-';
          odds2 = choices.find(choice => choice.name === '2')?.fractionalValue || '-';

          // Convert fractional odds to decimal odds
          odds1 = odds1 !== '-' ? fractionalToDecimal(odds1) : '-';
          oddsX = oddsX !== '-' ? fractionalToDecimal(oddsX) : '-';
          odds2 = odds2 !== '-' ? fractionalToDecimal(odds2) : '-';
        } else {
          console.warn(`No odds found for event ${eventId}`);
        }

        // Create a table row with or without odds
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${homeTeam}</td>
          <td>${awayTeam}</td>
          <td>${odds1}</td>
          <td>${oddsX}</td>
          <td>${odds2}</td>
          <td>${event.homeScore?.current ?? 0} - ${event.awayScore?.current ?? 0} </td>
        `;
        table.querySelector('tbody').appendChild(row);
      });
    })
    .catch(error => console.error('Error fetching odds:', error));
}

// Helper function to convert fractional odds to decimal odds
function fractionalToDecimal(fractional) {
  const [numerator, denominator] = fractional.split('/').map(Number);
  return (numerator / denominator + 1).toFixed(2);
}

// Fetch and display season-specific info (e.g., stats, standings)
function fetchSeasonInfo(tournamentId, tournamentName, seasonId) {
  fetch(`https://www.sofascore.com/api/v1/unique-tournament/${tournamentId}/season/${seasonId}/info`)
    .then(response => response.json())
    .then(data => {
      const seasonInfoContainer = document.getElementById('season-info');
      
      seasonInfoContainer.innerHTML = `  
        <div class="stats">
          <div><strong>G:</strong> ${data.info.goals}</div>
          <div><strong>HW:</strong> ${data.info.homeTeamWins}</div>
          <div><strong>AW:</strong> ${data.info.awayTeamWins}</div>
          <div><strong>D:</strong> ${data.info.draws}</div>
        </div>
      `;
    })
    .catch(error => console.error('Error fetching season info:', error));
}

// Fetch details of a specific tournament
function fetchTournamentDetails(tournamentId) {
  fetch(`https://www.sofascore.com/api/v1/unique-tournament/${tournamentId}`)
    .then(response => response.json())
    .then(data => {
      const tournamentDetailsContainer = document.getElementById('tournament-details');
      const tournament = data.uniqueTournament;

      // Get true values for rounds, groups, playoff series, performance graph
      const hasRounds = tournament.hasRounds ? 'Yes' : 'No';
      const hasGroups = tournament.hasGroups ? 'Yes' : 'No';
      const hasPlayoffSeries = tournament.hasPlayoffSeries ? 'Yes' : 'No';
      const hasPerformanceGraphFeature = tournament.hasPerformanceGraphFeature ? 'Yes' : 'No';

      const tournamentImage = `https://img.sofascore.com/api/v1/unique-tournament/${tournament.id}/image`;
      tournamentDetailsContainer.innerHTML = `        
        <div><img src="${tournamentImage}" alt="${tournament.name} logo"></div>
        <h3>${tournament.name}</h3>        
        <ul>
          <li><strong>Rs:</strong> ${hasRounds}</li>
          <li><strong>Gs:</strong> ${hasGroups}</li>
          <li><strong>PS:</strong> ${hasPlayoffSeries}</li>
          <li><strong>PG:</strong> ${hasPerformanceGraphFeature}</li>
        </ul>
      `; 

      // Fetch and display seasons for the selected tournament
      fetchSeasons(tournamentId, tournament.name);
      
      fetchEventsForTournament(tournamentId, tournament.name); // Fetch events for Premier League (ID: 17)
    })
    .catch(error => console.error('Error fetching tournament details:', error));
}

// Fetch and display seasons for a selected tournament
function fetchSeasons(tournamentId, tournamentName) {
  fetch(`https://www.sofascore.com/api/v1/unique-tournament/${tournamentId}/seasons`)
    .then(response => response.json())
    .then(data => {
      const seasonSelect = document.getElementById('season-select');
      seasonSelect.innerHTML = ''; // Clear previous options

      // Create a default "Select Season" option
      const defaultOption = document.createElement('option');
      defaultOption.textContent = "Season";
      defaultOption.value = "";
      seasonSelect.appendChild(defaultOption);

      // Loop through the seasons and create an option for each one
      data.seasons.forEach((season, index) => {
        const option = document.createElement('option');
        option.value = season.id;
        option.textContent = season.year;
        seasonSelect.appendChild(option);

        // Automatically select the first season and fetch its info
        if (index === 0) {
          option.selected = true;
          fetchSeasonInfo(tournamentId, tournamentName, season.id); // Fetch the first season's info

          // After selecting the first season, fetch rounds for that season
          //fetchRounds(tournamentId, season.id);
        }
      });

      // Add event listener for changing season
      seasonSelect.onchange = () => {
        const selectedSeasonId = seasonSelect.value;
        if (selectedSeasonId) {
          fetchSeasonInfo(tournamentId, tournamentName, selectedSeasonId);
          //fetchRounds(tournamentId, selectedSeasonId);  // Fetch rounds when season changes
        }
      };
    })
    .catch(error => console.error('Error fetching seasons:', error));
}

// Fetch rounds for the tournament and season
function fetchRounds(tournamentId, seasonId) {
  fetch(`https://www.sofascore.com/api/v1/unique-tournament/${tournamentId}/season/${seasonId}/rounds`)
    .then(response => response.json())
    .then(data => {
      const roundsContainer = document.getElementById('rounds');
      roundsContainer.innerHTML = '<h4>Rounds</h4>';
      
      // Check if the rounds property exists and is an array
      if (data.rounds && Array.isArray(data.rounds)) {
        const currentRound = data.currentRound?.round; // Get the current round number

        // Create a <ul> element to hold the round links
        const roundList = document.createElement('ul');
            // Add the class to the list item
            roundList.classList.add('scrollable'); // Correctly adding the class here
        roundsContainer.appendChild(roundList);

        // Loop through rounds and create <li> links
        data.rounds.forEach(round => {
          const listItem = document.createElement('li');
  
          const roundLink = document.createElement('a');
          roundLink.href = '#'; // Use a placeholder href
          roundLink.textContent = `${round.round}`;
          roundLink.onclick = (e) => {
            e.preventDefault(); // Prevent the default link behavior
            fetchEventsForRound(tournamentId, round.round);
          };

          // Highlight the current round
          if (round.round === currentRound) {
            roundLink.style.backgroundColor = '#4CAF50'; // Green background for the current round
            roundLink.style.color = 'white'; // White text for better contrast
            roundLink.style.padding = '2px 8px'; // Add padding for better appearance
          }

          listItem.appendChild(roundLink);
          roundList.appendChild(listItem);
        });
      } else {
        roundsContainer.innerHTML = '<p>No rounds data available.</p>';
      }
    })
    .catch(error => {
      console.error('Error fetching rounds:', error);
      document.getElementById('rounds').innerHTML = '<p>Failed to load rounds.</p>';
    });
}

// Initialize the app
fetchCategories();
</script>
</body>
</html>
