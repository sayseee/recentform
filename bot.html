<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap" rel="stylesheet">
<!-- Add this to the <head> of your HTML to include Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <title>Football Tournaments</title>
  <style>
    .rF-4 {
  font-family: "Roboto Flex", sans-serif;
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
  font-variation-settings:
    "slnt" 0,
    "wdth" 100,
    "GRAD" 0,
    "XOPQ" 96,
    "XTRA" 468,
    "YOPQ" 79,
    "YTAS" 750,
    "YTDE" -203,
    "YTFI" 738,
    "YTLC" 514,
    "YTUC" 712;
}
    .rF-5 {
  font-family: "Roboto Flex", sans-serif;
  font-optical-sizing: auto;
  font-weight: 500;
  font-style: normal;
  font-variation-settings:
    "slnt" 0,
    "wdth" 100,
    "GRAD" 0,
    "XOPQ" 96,
    "XTRA" 468,
    "YOPQ" 79,
    "YTAS" 750,
    "YTDE" -203,
    "YTFI" 738,
    "YTLC" 514,
    "YTUC" 712;
}
    .rF-6 {
  font-family: "Roboto Flex", sans-serif;
  font-optical-sizing: auto;
  font-weight: 600;
  font-style: normal;
  font-variation-settings:
    "slnt" 0,
    "wdth" 100,
    "GRAD" 0,
    "XOPQ" 96,
    "XTRA" 468,
    "YOPQ" 79,
    "YTAS" 750,
    "YTDE" -203,
    "YTFI" 738,
    "YTLC" 514,
    "YTUC" 712;
}
:root {
        --color-white20p: rgb(48, 125, 153);
        --color-black1: rgb(3,5,7);
        --win-color: rgba(27,184,145,.6); /* Wins */
        --draw-color: rgba(229, 156, 3, 0.9);/* Draws */
        --loss-color: rgba(253,29,91,0.5);/* Losses */
}
    body {
        background-color:rgb(0, 0, 0);
        color:rgb(219, 222, 218);
        font-size: 11px;
        margin: 10px;
        display: flex;
        flex-direction: column; 
        height: 100vh;
        overflow: hidden;
    }
    a {
      text-decoration: none;
      color:rgb(219, 222, 218);
    }
h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
}
li {
  list-style: none;
}
.scrollable {
  overflow-y: auto;
  overflow-x: hidden; 
}
.W, .D, .L {
        height: 14px;
        width: 14px;
        color: var(--color-black1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 10px;
    }    

    .W {
        background-color: var(--win-color);
    }
    .D {
        background-color: var(--draw-color);
    }
    .L {
        background-color: var(--loss-color);
    } 
    .fa-spin {
      color: var(--draw-color)
    }
/* Custom scrollbar for WebKit browsers (Chrome, Safari) */
.scrollable::-webkit-scrollbar {
    width: 5px; /* Set scrollbar width to 1px */
    height: 5px; /* Set scrollbar width to 1px */
}

.scrollable::-webkit-scrollbar-track {
  background: var(--color-black1); /* Track color */
}

.scrollable::-webkit-scrollbar-thumb {
  background: var(--color-white20p); /* Thumb color */
  border-radius: 1px; /* Rounded corners for the thumb */
}

.main {
  display: flex;
  background-color: rgb(40, 40, 40);
  border: 1px solid rgb(74, 74, 74);
  flex: 1;
  flex-direction: row;
  height: 100vh;
}

#categories ul, #tournaments ul {
  margin: 0;
  padding: 0;
}

#categories li, #tournaments li {
  margin: 0;
  list-style: none;
} 
#categories  {
  flex: 0.8;
}
.tournaments {
  background-color:rgb(0, 0, 0);
  border-right: 1px solid rgba(40, 40, 40, 0.8);
  border-left: 1px solid rgba(40, 40, 40, 0.8);
  flex: 1;
} 
.tournament-details {
  flex: 6;
  display: flex;
  flex-direction: column;
}
#tournament-details, #tournament-details ul {
  display: flex;
  align-items: center;
  gap: 10px;
}
#tournament-details div {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  padding: 0 10px;
    background-color: white;
}
#tournament-details img {
    height: 45px;
}
#categories a {
  color: rgb(128, 128, 128);
  padding: 3px 0 3px 10px;
  display: flex;
  align-items: center;
} 

.tournaments h2 {
  font-size: 12px;
  text-transform: uppercase;
  text-align: center;
} 
#tournaments a {
  color: rgb(223, 189, 106);
  padding: 3px 0 3px 10px;
  display: flex;
  align-items: center;
} 
#categories li:nth-child(even) {
  background-color:rgb(0, 0, 0);
  border-right: 1px solid rgba(40, 40, 40, 0.8);
}
#tournaments li {
  border-bottom: 1px solid rgba(40, 40, 40, 0.8);
  padding-right: 10px;
}
.tournament-data {
  display: flex;
  flex-direction: row;
  align-items: center;    
    color: white;
    justify-content: space-between;
    border-bottom: 1px solid rgb(48, 125, 153);

}
#rounds, #rounds ul {
  display: flex;
  align-items: center;
}
#rounds {
  display: flex; /* Make the container a flexbox */
  align-items: center; /* Vertically center the content */
  border-bottom: 1px solid #666;
}

#rounds h4 {
    width: 50px;
    margin: 0;
    padding: 12px 10px;
    color: white;
    text-transform: uppercase;
    border-right: 1px solid #666;
    margin-right: 10px;
}

#rounds ul {
  flex-grow: 1; /* Allow the list to grow and fill the remaining space */
  margin: 0; /* Remove default margin */
  padding: 0; /* Remove default padding */
  list-style: none; /* Remove default list styling */
  display: flex; /* Make the list a flex container */
  flex-wrap: nowrap; /* Allow list items to wrap to the next line */
  gap: 1px;
  overflow-x: auto;
  margin-right: 10px;
}

#rounds ul li { 
  text-align: center; /* Center the text inside list items */
}

#rounds ul li a {
  text-decoration: none; /* Remove underline from links */
  color: white; /* Set link text color */
  padding:2px 8px; /* Add padding to links */
  background-color: rgba(255, 255, 255, 0.1); /* Default background color */
  display: block; /* Make links fill the entire list item */
}

#rounds ul li a:hover {
  background-color: rgba(255, 255, 255, 0.2); /* Hover background color */
}

#season-info .stats {
  display: flex; /* Arrange stats in a row */
  gap: 15px; /* Add spacing between stats */
  flex-wrap: wrap; /* Allow wrapping if the container is too small */
}

#season-info .stats div {
  background-color: rgba(255, 255, 255, 0.1); /* Light background for each stat */
  padding: 5px 10px; /* Add padding */
  border-radius: 4px; /* Rounded corners */
  font-size: 14px;
}
#season-select {
  margin-right: 10px;
}
select {
    background-color: #2b3034;
    color: rgb(151, 255, 159);
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
}
.tEs {
  display: flex;
  gap: 5px;
}
.tEs #standings, .tEs #events-analysis {
  width: 50%;
}
table {
    width: 100%;
    border-collapse: collapse;
}
table.events-table {
  font-size: 10.5px;
}
tr.headerTitle th, #overall-standings th {
  font-size: 10px;
  font-weight: bold; 
  color: rgb(255, 255, 255);
  border-bottom: 1px solid rgb(48, 125, 153);
  text-transform: uppercase;
} 

table.events-table tbody tr:nth-child(even), #overall-standings tbody tr:nth-child(even) {
  background-color:rgb(0, 0, 0);
}
table.events-table thead th.score, table.events-table tbody td.score {
  text-align: center;
}
/* Center all columns except the first three (Time, Home, Away) */
.events-table th, .events-table td {
  text-align: center;
}

/* Exclude the first three columns (Time, Home, Away) */
.events-table th:nth-child(1),
.events-table th:nth-child(2),
.events-table th:nth-child(3),
.events-table td:nth-child(1),
.events-table td:nth-child(2),
.events-table td:nth-child(3) {
  text-align: left; /* Or any other alignment you prefer */
}

.events-table td:nth-child(4) {
  border-right: 1px solid transparent;
}

.tabcontent {
  border: 1px solid rgb(74, 74, 74);
  border-top: none;
  border-right: none;
}

#overall-standings th, #overall-standings td {
  text-align: center; /* Center all text */ 
  padding: 3px;
}

#overall-standings td:nth-child(2), #overall-standings th:nth-child(2) {
  text-align: left; /* Align 'Team' column to the left */
} 
.formResult {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2px;
} 

table.events-table td, table.events-table th, #overall-standings tbody td  {
  padding: 5px;
}
#last-tournament-events {
  height: calc(100vh - 60px);
}

.diff_1{background-color:#63D100;color: #fff;}
.diff_2{background-color:#4B9F01;color: #fff;}
.diff_3{background-color:#FF9900;color: #fff;}
.diff_4{background-color:#DE4E45;color: #fff;}
.diff_5{background-color:#990134;color: #fff;}
  </style>
</head>
<body class="rF-4">
  <div class="main">
    <div id="categories" class="scrollable"></div>  
    <div class="tournaments scrollable">
      <h2><span id="selected-country"></span></h2>
      <div id="tournaments"></div>
    </div>

    <div class="tournament-details"> 
      <div class="tournament-data">
        <div id="tournament-details"></div>
        <!-- Season Info -->
        <div id="season-info"></div>
        <!-- Season Selector Dropdown -->
        <select id="season-select"></select> 
      </div>  
        
      <div class="tEs"> 
        <div id="events-analysis">
          <div id="tournament-events"></div>
          <div id="event-details"></div>
          <div id="analysis-data"></div>
        </div>
        <div id="last-tournament-events" class="scrollable"></div>
      </div>
    </div>
</div>

  <script>

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').then((registration) => {
        //console.log('Service Worker registered with scope:', registration.scope);
      }).catch((error) => {
        //console.error('Service Worker registration failed:', error);
      });
    });
  }
  const baseURL = 'https://api.sofascore.com/api/v1';
  // Helper function to convert fractional odds to decimal odds
function fractionalToDecimal(fractional) {
  const [numerator, denominator] = fractional.split('/').map(Number);
  return (numerator / denominator + 1).toFixed(2);
}

let cachedEvents = null; // Global variable to store cached events
let tournamentIds = new Set(); // Global variable to store unique tournament IDs

const scheduledEventsUrl = (date, inverse = false) => 
  `https://api.sofascore.com/api/v1/sport/football/scheduled-events/${date}${inverse ? '/inverse' : ''}`;

// Fetch and cache scheduled events (with optional inverse events)
function fetchAndCacheScheduledEvents(date, includeInverse = false) {
  const urls = [scheduledEventsUrl(date)];
  if (includeInverse) {
    urls.push(scheduledEventsUrl(date, true));
  }

  return Promise.all(urls.map(url => 
    fetch(url)
      .then(response => response.json())
      .then(data => data.events)
      .catch(error => {
        console.error('Error fetching scheduled events:', error);
        return [];
      })
  ))
  .then(results => {
    const allEvents = results.flat();
    cachedEvents = allEvents; // Cache all fetched events

    // Extract and store tournament IDs
    allEvents.forEach(event => {
      const tournamentId = event.tournament.id;
      const uniqueTournamentId = event.tournament.uniqueTournament.id;
      tournamentIds[tournamentId] = uniqueTournamentId;
    });

    return allEvents;
  });
}

// Fetch and display categories with scheduled events
function fetchCategories() {
  const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format

  // Fetch and cache scheduled events
  fetchAndCacheScheduledEvents(today)
    .then(events => {
      const categoriesWithEvents = new Set(); // Use a Set to store unique category IDs
      const tournamentsWithEvents = new Set(); // Use a Set to store unique tournament IDs

      // Loop through events and collect unique category and tournament IDs
      events.forEach(event => {
        categoriesWithEvents.add(event.tournament.category.id);
        tournamentsWithEvents.add(event.tournament.uniqueTournament.id);
      });

      // Check if the number of categories is less than 30
      if (categoriesWithEvents.size < 30) {
        return fetchAndCacheScheduledEvents(today, true)
          .then(inverseEvents => {
            inverseEvents.forEach(event => {
              categoriesWithEvents.add(event.tournament.category.id);
              tournamentsWithEvents.add(event.tournament.uniqueTournament.id);
            });
            return { categoriesWithEvents, tournamentsWithEvents };
          });
      } else {
        return { categoriesWithEvents, tournamentsWithEvents };
      }
    })
    .then(({ categoriesWithEvents, tournamentsWithEvents }) => {
      // Fetch all categories
      fetch('https://www.sofascore.com/api/v1/sport/football/categories')
        .then(response => response.json())
        .then(categoriesData => {
          const categoriesContainer = document.getElementById('categories');
          categoriesContainer.innerHTML = '';

          // Filter categories to only include those with scheduled events
          const filteredCategories = categoriesData.categories.filter(category =>
            categoriesWithEvents.has(category.id)
          );

          // Sort filtered categories by priority (descending) and then alphabetically for priority 0
          const sortedCategories = filteredCategories.sort((a, b) => {
            if (a.priority === 0 && b.priority === 0) {
              return a.name.localeCompare(b.name);
            } else if (a.priority === 0) {
              return 1;
            } else if (b.priority === 0) {
              return -1;
            } else {
              return b.priority - a.priority;
            }
          });

          // Create a <ul> element to hold the category links
          const categoryList = document.createElement('ul');
          categoriesContainer.appendChild(categoryList);

          // Loop through sorted categories and create <li> links
          sortedCategories.forEach((category, index) => {
            const listItem = document.createElement('li');
            const categoryLink = document.createElement('a');
            categoryLink.href = '#'; // Use a placeholder href
            categoryLink.textContent = category.name;
            categoryLink.onclick = (e) => {
              e.preventDefault(); // Prevent the default link behavior
              fetchTournaments(category.id, category.name, tournamentsWithEvents);
            };

            listItem.appendChild(categoryLink);
            categoryList.appendChild(listItem);

            // Auto-click the first category to load its tournaments
            if (index === 0) {
              fetchTournaments(category.id, category.name, tournamentsWithEvents);
            }
          });
        })
        .catch(error => console.error('Error fetching categories:', error));
    })
    .catch(error => console.error('Error fetching scheduled events:', error));
}

function fetchScheduledEvents(uniqueTournamentId, date) {
  if (cachedEvents) {
    // Use cached events if available
    const filteredEvents = cachedEvents.filter(event =>
      event.tournament.uniqueTournament.id === uniqueTournamentId
    );

    // Extract tournamentId and seasonId from the first event in filteredEvents
    const tournamentId = filteredEvents[0]?.tournament?.id;
    const seasonId = filteredEvents[0]?.season?.id;

    if (!tournamentId || !seasonId) {
      console.error('Tournament ID or Season ID not found in filtered events');
      return;
    }
    fetchLastTournamentEvents(tournamentId, seasonId) 
    // Fetch tournament events
    fetchTournamentEvents(tournamentId, seasonId)
      .then(() => { 
        displayEventsInTable(filteredEvents, uniqueTournamentId, date); // Display events
      })
      .catch(error => console.error('Error fetching tournament events:', error));
  } else {
    // Fetch and cache events if not already cached
    fetchAndCacheScheduledEvents(date)
      .then(events => {
        const filteredEvents = events.filter(event =>
          event.tournament.uniqueTournament.id === uniqueTournamentId
        );

        // Extract tournamentId and seasonId from the first event in filteredEvents
        const tournamentId = filteredEvents[0]?.tournament?.id;
        const seasonId = filteredEvents[0]?.season?.id;

        if (!tournamentId || !seasonId) {
          console.error('Tournament ID or Season ID not found in filtered events');
          return;
        }
        fetchLastTournamentEvents(tournamentId, seasonId) 
        // Fetch tournament events
        fetchTournamentEvents(tournamentId, seasonId)
          .then(() => {
            displayEventsInTable(filteredEvents, uniqueTournamentId, date); // Display events
          })
          .catch(error => console.error('Error fetching tournament events:', error));
      })
      .catch(error => console.error('Error fetching scheduled events:', error));
  }
}
function fetchTournamentEvents(tournamentId, seasonId) {
  return fetch(`https://api.sofascore.com/api/v1/tournament/${tournamentId}/season/${seasonId}/events`)
    .then(response => response.json())
    .then(data => {
      return data.events.filter(event => event.status.type === "finished"); // Keep only finished events
    })
    .catch(error => {
      console.error('Error fetching tournament events:', error);
      return [];
    });
}

// Function to analyze historical performance based on odds and display results
function analyzeHistoricalPerformance(tournamentId, seasonId, currentEventOdds) {
  fetchTournamentEvents(tournamentId, seasonId)
    .then(events => {
      const last30Events = events.slice(-30).reverse(); // Get the last 30 finished events
      const analysisDataContainer = document.getElementById('analysis-data');
      analysisDataContainer.innerHTML = ''; // Clear previous content

      // Initialize counters for home, away, and draw results
      let homeWins = 0, awayWins = 0, draws = 0;

      // Loop through the last 30 events
      last30Events.forEach(event => {
        const eventId = event.id;

        // Fetch odds for the event
        fetch(`https://www.sofascore.com/api/v1/event/${eventId}/odds/1/all`)
          .then(response => response.json())
          .then(oddsData => {
            if (!oddsData.markets || oddsData.markets.length === 0) {
              console.warn(`No odds available for event ${eventId}, skipping...`);
              return;
            }

            const market = oddsData.markets.find(m => m.marketName === "Full time");
            if (!market) return;

            const odds1 = market?.choices.find(c => c.name === "1")?.initialFractionalValue || '-';
            const oddsX = market?.choices.find(c => c.name === "X")?.initialFractionalValue || '-';
            const odds2 = market?.choices.find(c => c.name === "2")?.initialFractionalValue || '-';

            // Convert fractional odds to decimal odds
            const decimalOdds1 = fractionalToDecimal(odds1);
            const decimalOddsX = fractionalToDecimal(oddsX);
            const decimalOdds2 = fractionalToDecimal(odds2);

            // Compare the odds with the current event odds
            if (decimalOdds1 === currentEventOdds.odds1) {
              if (event.homeScore.current > event.awayScore.current) homeWins++;
              else if (event.homeScore.current < event.awayScore.current) awayWins++;
              else draws++;
              console.log('home odds:', currentEventOdds.odds1);
            } else if (decimalOdds2 === currentEventOdds.odds2) {
              if (event.homeScore.current > event.awayScore.current) homeWins++;
              else if (event.homeScore.current < event.awayScore.current) awayWins++;
              else draws++;
              console.log('away odds:', currentEventOdds.odds2);
            } else if (decimalOddsX === currentEventOdds.oddsX) {
              if (event.homeScore.current > event.awayScore.current) homeWins++;
              else if (event.homeScore.current < event.awayScore.current) awayWins++;
              else draws++;
              console.log('draw odds:', currentEventOdds.oddsX);
            }

            // Display the analysis results
            analysisDataContainer.innerHTML = `
              <h3>Historical Performance Analysis</h3>
              <p>Home Wins: ${homeWins}</p>
              <p>Away Wins: ${awayWins}</p>
              <p>Draws: ${draws}</p>
            `;
          })
          .catch(error => console.error(`Error fetching odds for event ${eventId}:`, error));
      });
    })
    .catch(error => console.error('Error fetching tournament events:', error));
}

// Function to fetch the last 30 finished events for a tournament and display them with odds and results
function fetchLastTournamentEvents(tournamentId, seasonId) {
  fetchTournamentEvents(tournamentId, seasonId)
    .then(events => {
      const last30Events = events.slice(-30).reverse(); // Get the last 30 finished events
      const eventsContainer = document.getElementById('last-tournament-events');
      eventsContainer.innerHTML = ''; // Clear previous content

      // Create a table element for the event display
      const table = document.createElement('table');
      table.classList.add('events-table');
      table.innerHTML = `
        <thead>
          <tr class="headerTitle">
            <th>Date</th>
            <th>Home</th>
            <th>Away</th>
            <th width="50">1</th>
            <th width="50">X</th>
            <th width="50">2</th>
            <th>Score</th>
            <th>R</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      `;
      eventsContainer.appendChild(table);

      last30Events.forEach(event => {
        const eventId = event.id;
        const homeTeam = event.homeTeam.shortName;
        const awayTeam = event.awayTeam.shortName;
        const eventDate = new Date(event.startTimestamp * 1000).toLocaleDateString();
        const score = `${event.homeScore?.current ?? ''} - ${event.awayScore?.current ?? ''}`;
        const result = event.homeScore.current > event.awayScore.current ? "1" : 
                       event.homeScore.current < event.awayScore.current ? "2" : "X";

        // Fetch odds for the event
        fetch(`https://www.sofascore.com/api/v1/event/${eventId}/odds/1/all`)
          .then(response => response.json())
          .then(oddsData => {
            if (!oddsData.markets || oddsData.markets.length === 0) {
              console.warn(`No odds available for event ${eventId}, skipping...`);
              return;
            }

            const market = oddsData.markets.find(m => m.marketName === "Full time");
            if (!market) return;

            const odds1 = market?.choices.find(c => c.name === "1")?.initialFractionalValue || '-';
            const oddsX = market?.choices.find(c => c.name === "X")?.initialFractionalValue || '-';
            const odds2 = market?.choices.find(c => c.name === "2")?.initialFractionalValue || '-';

            // Convert fractional odds to decimal odds
            const decimalOdds1 = fractionalToDecimal(odds1);
            const decimalOddsX = fractionalToDecimal(oddsX);
            const decimalOdds2 = fractionalToDecimal(odds2);

            const probability1 = (1 / decimalOdds1 * 100).toFixed(0);
            const probabilityX = (1 / decimalOddsX * 100).toFixed(0);
            const probability2 = (1 / decimalOdds2 * 100).toFixed(0);

            // Convert probabilities to numbers
            const prob1 = Number(probability1);
            const prob2 = Number(probability2);

            // Determine difficulty levels separately for home (prob1) and away (prob2)
            let level1, level2;

            // Home side difficulty (prob1)
            if (prob1 <= 15) {
              level1 = 1; // Very Easy
            } else if (prob1 <= 35) {
              level1 = 2; // Easy
            } else if (prob1 <= 57) {
              level1 = 3; // Medium
            } else if (prob1 <= 79) {
              level1 = 4; // Hard
            } else {
              level1 = 5; // Very Hard
            }

            // Away side difficulty (prob2)
            if (prob2 <= 15) {
              level2 = 1; // Very Easy
            } else if (prob2 <= 35) {
              level2 = 2; // Easy
            } else if (prob2 <= 57) {
              level2 = 3; // Medium
            } else if (prob2 <= 79) {
              level2 = 4; // Hard
            } else {
              level2 = 5; // Very Hard
            }

            // Create a table row with the event data
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${eventDate}</td>
              <td>${homeTeam}</td>
              <td>${awayTeam}</td>
              <td class="diff_${level1}">${decimalOdds1} - ${probability1}</td>
              <td>${decimalOddsX} - ${probabilityX}</td>
              <td class="diff_${level2}">${decimalOdds2} - ${probability2}</td>
              <td>${score}</td>
              <td>${result}</td>
            `;
            table.querySelector('tbody').appendChild(row);

          })
          .catch(error => console.error(`Error fetching odds for event ${eventId}:`, error));
      });
    })
    .catch(error => console.error('Error fetching tournament events:', error));
}

// Function to display events in a table and trigger analysis
function displayEventsInTable(events, tournamentId, date) {
  const eventsContainer = document.getElementById('tournament-events');
  eventsContainer.innerHTML = ''; // Clear previous content

  // Create a table element for the event display
  const table = document.createElement('table');
  table.classList.add('events-table');
  table.innerHTML = `
    <thead>
      <tr class="headerTitle">
        <th>Time</th>
        <th>Home</th>
        <th>Away</th>
        <th width="60">1</th>
        <th width="60">X</th>
        <th width="60">2</th>
        <th class="score">Score</th>
        <th class="status">S</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  `;
  eventsContainer.appendChild(table);

  // Fetch odds for the events (if needed)
  const oddsUrl = `https://www.sofascore.com/api/v1/sport/football/odds/1/${date}`;
  fetch(oddsUrl)
    .then(response => response.json())
    .then(oddsData => {
      // Loop through events and create table rows
      events.forEach((event, index) => {
        const eventId = event.id;
        const homeTeam = event.homeTeam.shortName;
        const awayTeam = event.awayTeam.shortName;
        const eventDate = new Date(event.startTimestamp * 1000);
        const startTime = eventDate.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\d{4}/, '') + ' ' + 
                  eventDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

        // Default values for odds
        let odds1 = '-';
        let oddsX = '-';
        let odds2 = '-';

        // Find the odds for this event (if available) by checking if the eventId exists in the odds data
        const eventOdds = oddsData.odds[eventId];
        if (eventOdds) {
          const choices = eventOdds.choices || []; 

          // Find the odds for '1', 'X', and '2'
          odds1 = choices.find(choice => choice.name === '1')?.initialFractionalValue || '-';
          oddsX = choices.find(choice => choice.name === 'X')?.initialFractionalValue || '-';
          odds2 = choices.find(choice => choice.name === '2')?.initialFractionalValue || '-';

          // Convert fractional odds to decimal odds
          odds1 = odds1 !== '-' ? fractionalToDecimal(odds1) : '-';
          oddsX = oddsX !== '-' ? fractionalToDecimal(oddsX) : '-';
          odds2 = odds2 !== '-' ? fractionalToDecimal(odds2) : '-';

          // Trigger analysis for the current event odds
          analyzeHistoricalPerformance(event.tournament.id, event.season.id, { odds1, oddsX, odds2 });
        } else {
          console.warn(`No odds found for event ${eventId}`);
        }

         // Determine event status with shorthand
        let status = "NS"; // Default to "Not Started" shorthand
        let statusIcon = "";
        if (event.status?.type === "finished") {
            status = "FT"; // Full Time
            statusIcon = "✔"; // Full Time checkmark
        } else if (event.status?.type === "cancelled") {
            status = "CC"; // Cancelled
            statusIcon = "✘"; // Cancelled cross
        } else if (event.status?.type === "postponed") {
            status = "PP"; // Postponed
            statusIcon = "⏸"; // Postponed pause icon
        } else if (event.status?.type === "notstarted") {
            status = "NS"; // Not Started
            statusIcon = '<i class="fas fa-clock"></i>'; // Clock icon for Not Started
        } else if (event.status?.type === "inprogress") {
            status = "IP"; // In Progress
            statusIcon = '<i class="fas fa-sync-alt fa-spin"></i>'; // Spinning sync icon for In Progress
        }
        // Create a table row with or without odds
        const probability1 = (1 / odds1 * 100).toFixed(0);
        const probabilityX = (1 / oddsX * 100).toFixed(0);
        const probability2 = (1 / odds2 * 100).toFixed(0);

        
            // Convert probabilities to numbers
            const prob1 = Number(probability1);
            const prob2 = Number(probability2);

            // Determine difficulty levels separately for home (prob1) and away (prob2)
            let level1, level2;

            // Home side difficulty (prob1)
            if (prob1 <= 15) {
              level1 = 1; // Very Easy
            } else if (prob1 <= 35) {
              level1 = 2; // Easy
            } else if (prob1 <= 57) {
              level1 = 3; // Medium
            } else if (prob1 <= 79) {
              level1 = 4; // Hard
            } else {
              level1 = 5; // Very Hard
            }

            // Away side difficulty (prob2)
            if (prob2 <= 15) {
              level2 = 1; // Very Easy
            } else if (prob2 <= 35) {
              level2 = 2; // Easy
            } else if (prob2 <= 57) {
              level2 = 3; // Medium
            } else if (prob2 <= 79) {
              level2 = 4; // Hard
            } else {
              level2 = 5; // Very Hard
            }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td width="100">${startTime}</td>
          <td width="140" class="${event.homeTeam.id}">${homeTeam}</td>
          <td width="140" class="${event.awayTeam.id}">${awayTeam}</td>
          <td class="diff_${level1}">${odds1} - ${probability1}</td>
          <td width="50">${oddsX} - ${probabilityX}</td>
          <td class="diff_${level2}">${odds2} - ${probability2}</td>
          <td class="score" width="40">${event.homeScore?.current ?? ''} - ${event.awayScore?.current ?? ''} </td>
          <td class="status" width="10">${statusIcon}</td> <!-- Added status here -->
        `;
        
        // Add an onclick event to analyze odds of the clicked event
        row.onclick = () => {
          fetchEventDetails(eventId);
          const currentEventOdds = { odds1: odds1, oddsX: oddsX, odds2: odds2 };
          console.log('Clicked event odds:', currentEventOdds);
          analyzeHistoricalPerformance(event.tournament.id, event.season.id, currentEventOdds);
        };

        table.querySelector('tbody').appendChild(row);

        // Load analysis for the first event on initial load
        if (index === 0) {
          fetchEventDetails(eventId);
          console.log(eventId);
          const currentEventOdds = { odds1: decimalOdds1, oddsX: decimalOddsX, odds2: decimalOdds2 };
          analyzeHistoricalPerformance(event.tournament.id, event.season.id, currentEventOdds);
        }
      });
    })
    .catch(error => console.error('Error fetching odds:', error));
}

function fetchEventDetails(eventId) {
  const eventDetailsContainer = document.getElementById('event-details');
  eventDetailsContainer.innerHTML = '<p>Loading event details...</p>'; // Show loading text

  // Fetch event details
  fetch(`https://www.sofascore.com/api/v1/event/${eventId}`)
    .then(response => response.json())
    .then(eventData => {
      if (!eventData || !eventData.event) {
        eventDetailsContainer.innerHTML = '<p>Event details not available.</p>';
        return;
      }

      const event = eventData.event;
      const uniqueH2hContainer = `h2h-container-${event.id}`; // Unique ID for the event's info container
      const homeTeam = event.homeTeam.shortName || event.homeTeam.name;
      const awayTeam = event.awayTeam.shortName || event.awayTeam.name;
      const eventDate = new Date(event.startTimestamp * 1000).toLocaleString();
      const score = event.homeScore?.current !== undefined && event.awayScore?.current !== undefined
        ? `${event.homeScore.current} - ${event.awayScore.current}`
        : 'Not available';

      // Display event details
      eventDetailsContainer.innerHTML = `
        <h3>Event Details</h3>
        <p><strong>Date:</strong> ${eventDate}</p>
        <p><strong>Home Team:</strong> ${homeTeam}</p>
        <p><strong>Away Team:</strong> ${awayTeam}</p>
        <p><strong>Score:</strong> ${score}</p>
        <div id="home-odds-${event.id}">
        <div id="away-odds-${event.id}">
        <div class="team-manager-h2h" id="${uniqueH2hContainer}"></div>
      `; 
      
      renderWinningOdds(event.id);
      fetchHeadToHead(event.id, uniqueH2hContainer); 
    })    
    .catch(error => {
      console.error('Error fetching event details:', error);
      eventDetailsContainer.innerHTML = '<p>Error loading event details.</p>';
    });
}


const fetchWinningOdds = async (eventId) => {
    try {
        const winningOddsResponse = await fetch(`${baseURL}/event/${eventId}/provider/1/winning-odds`);
        if (!winningOddsResponse.ok) {
            throw new Error(`Failed to fetch winning odds: ${winningOddsResponse.statusText}`);
        }
        
        const oddsData = await winningOddsResponse.json();
        return oddsData;
    } catch (error) {
        console.error("Error fetching winning odds data:", error);
    }
};

const renderWinningOdds = async (eventId) => {
    try {
        const oddsData = await fetchWinningOdds(eventId);
        if (oddsData) {
            const { home, away } = oddsData;

            const getStyledSpan = (expected, actual) => `
                <span style="background-color: ${actual > expected ? '#e59c0350' : '#a4a9b350'};">${expected}</span>
                <span style="background-color: ${actual > expected ? '#e59c03' : '#a4a9b3'};">${actual}</span>
            `;

            document.getElementById(`home-odds-${eventId}`).innerHTML = getStyledSpan(home.expected, home.actual);
            document.getElementById(`away-odds-${eventId}`).innerHTML = getStyledSpan(away.expected, away.actual);
        }
    } catch (error) {
        console.error(`Failed to fetch or render odds for event ${eventId}:`, error);
    }
};
 

const fetchHeadToHead = async (eventId, h2hContainerId) => {
    try {
        const response = await fetch(`${baseURL}/event/${eventId}/h2h`);
        if (!response.ok) throw new Error(`Failed to fetch H2H data: ${response.statusText}`);
        
        const h2hData = await response.json();
        const { teamDuel, managerDuel } = h2hData;

        // Render team duel data if available
        const teamDuelHTML = teamDuel ? renderTeamDuelStats(teamDuel) : '<div></div>';

        // Render manager duel data if available
        const managerDuelHTML = managerDuel ? renderManagerDuelStats(managerDuel) : '<div></div>';

        // Insert the HTML into the H2H container
        document.getElementById(h2hContainerId).innerHTML = teamDuelHTML + managerDuelHTML;
    } catch (error) {
        console.error("Error fetching head-to-head data:", error);
    }
};

const renderTeamDuelStats = (teamDuel) => {
    const { homeWins, awayWins, draws } = teamDuel;
    const totalGames = homeWins + awayWins + draws;

    const homeWinPercentage = ((homeWins / totalGames) * 100).toFixed(0);
    const drawPercentage = ((draws / totalGames) * 100).toFixed(0);
    const awayWinPercentage = ((awayWins / totalGames) * 100).toFixed(0);

    return `
    <div>
        <h4 style="text-align:center;margin-top: 10px;">Head 2 Head (${totalGames})</h4>
        <div>
            <p><strong>${homeWinPercentage}%</strong></p>
            <p><strong>${drawPercentage}%</strong></p>
            <p><strong>${awayWinPercentage}%</strong></p>
        </div>
    </div>
    `;
};

const renderManagerDuelStats = (managerDuel) => { 
    const { homeWins, awayWins, draws } = managerDuel;
    const totalGames = homeWins + awayWins + draws;

    const homeWinPercentage = ((homeWins / totalGames) * 100).toFixed(0);
    const drawPercentage = ((draws / totalGames) * 100).toFixed(0);
    const awayWinPercentage = ((awayWins / totalGames) * 100).toFixed(0);

    return `
    <div>
        <span>Manager Duel (${totalGames})</span>
        <div>
            <p><strong>${homeWinPercentage}%</strong></p>
            <p><strong>${drawPercentage}%</strong></p>
            <p><strong>${awayWinPercentage}%</strong></p>
        </div>
    </div>
    `; 
};


function fetchTournaments(categoryId, categoryName, tournamentsWithEvents) {
  const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format

  // Fetch tournaments for the category
  fetch(`https://www.sofascore.com/api/v1/category/${categoryId}/tournaments`)
    .then(response => response.json())
    .then(tournamentsData => {
      const tournamentsContainer = document.getElementById('tournaments');
      tournamentsContainer.innerHTML = '';

      // Filter tournaments to only include those with scheduled events
      const filteredTournaments = tournamentsData.tournaments.filter(tournament =>
        tournamentsWithEvents.has(tournament.uniqueTournament.id)
      );

      // Create a <ul> element to hold the tournament links
      const tournamentList = document.createElement('ul');
      tournamentsContainer.appendChild(tournamentList);

      // Loop through filtered tournaments and create <li> links
      filteredTournaments.forEach((tournament, index) => {
        const listItem = document.createElement('li');
        const tournamentLink = document.createElement('a');
        tournamentLink.href = '#'; // Use a placeholder href
        tournamentLink.textContent = tournament.name;
        tournamentLink.onclick = (e) => {
          e.preventDefault(); // Prevent the default link behavior
          const seasonId = tournament.season.id; // Get the season ID
          fetchScheduledEvents(tournament.uniqueTournament.id, today);
        };

        listItem.appendChild(tournamentLink);
        tournamentList.appendChild(listItem);

        // Auto-click the first tournament to load its events
        if (index === 0) {
          const seasonId = tournament.season.id; // Get the season ID
          fetchScheduledEvents(tournament.uniqueTournament.id, today);
        }
      });
    })
    .catch(error => console.error('Error fetching tournaments:', error));
}

function fetchSeasonInfo(uniqueTournamentId, tournamentName, seasonId) {
  fetch(`https://www.sofascore.com/api/v1/unique-tournament/${uniqueTournamentId}/season/${seasonId}/info`)
    .then(response => response.json())
    .then(data => {
      const seasonInfoContainer = document.getElementById('season-info');
      
      // Calculate total matches
      const totalMatches = data.info.homeTeamWins + data.info.awayTeamWins + data.info.draws;
      
      // Calculate percentages
      const homeWinPercentage = ((data.info.homeTeamWins / totalMatches) * 100).toFixed(0);
      const awayWinPercentage = ((data.info.awayTeamWins / totalMatches) * 100).toFixed(0);
      const drawPercentage = ((data.info.draws / totalMatches) * 100).toFixed(0);
      
      // Display the stats with percentages
      seasonInfoContainer.innerHTML = `  
        <div class="stats">
          <div><strong>G:</strong> ${data.info.goals}</div>
          <div><strong>HW:</strong> ${data.info.homeTeamWins} (${homeWinPercentage}%)</div>
          <div><strong>AW:</strong> ${data.info.awayTeamWins} (${awayWinPercentage}%)</div>
          <div><strong>D:</strong> ${data.info.draws} (${drawPercentage}%)</div>
        </div>
      `;

      // Find the tournamentId for the given uniqueTournamentId
      const tournamentId = Object.keys(tournamentIds).find(
        key => tournamentIds[key] === uniqueTournamentId
      );

      if (tournamentId) {
        // Fetch and display tournament events for the selected season
        fetchTournamentEvents(tournamentId, seasonId);
      } else {
        console.error('Tournament ID not found for uniqueTournamentId:', uniqueTournamentId);
      }
    })
    .catch(error => console.error('Error fetching season info:', error));
}

function fetchTournamentDetails(uniqueTournamentId) { 
  fetch(`https://www.sofascore.com/api/v1/unique-tournament/${uniqueTournamentId}`)
    .then(response => response.json())
    .then(data => {
      const tournamentDetailsContainer = document.getElementById('tournament-details');
      const uniqueTournament = data.uniqueTournament;

      // Display tournament details
      const tournamentImage = `https://img.sofascore.com/api/v1/unique-tournament/${uniqueTournament.id}/image`;
      tournamentDetailsContainer.innerHTML = `        
        <div><img src="${tournamentImage}" alt="${uniqueTournament.name} logo"></div>
        <h3>${uniqueTournament.name}</h3>        
        <ul>
          <li><strong>Rs:</strong> ${uniqueTournament.hasRounds ? 'Yes' : 'No'}</li>
          <li><strong>Gs:</strong> ${uniqueTournament.hasGroups ? 'Yes' : 'No'}</li>
          <li><strong>PS:</strong> ${uniqueTournament.hasPlayoffSeries ? 'Yes' : 'No'}</li>
          <li><strong>PG:</strong> ${uniqueTournament.hasPerformanceGraphFeature ? 'Yes' : 'No'}</li>
        </ul>
      `; 

      // Fetch and display seasons for the selected tournament
      fetchSeasons(uniqueTournament.id, uniqueTournament.name);
  
      // Fetch events for the tournament
      fetchEventsForTournament(uniqueTournament.id, uniqueTournament.name);
    })
    .catch(error => console.error('Error fetching tournament details:', error));
}

// Fetch and display seasons for a selected tournament
function fetchSeasons(uniqueTournamentId, tournamentName) {
  fetch(`https://www.sofascore.com/api/v1/unique-tournament/${uniqueTournamentId}/seasons`)
    .then(response => response.json())
    .then(data => {
      const seasonSelect = document.getElementById('season-select');
      seasonSelect.innerHTML = ''; // Clear previous options

      // Create a default "Select Season" option
      const defaultOption = document.createElement('option');
      defaultOption.textContent = "Season";
      defaultOption.value = "";
      seasonSelect.appendChild(defaultOption);

      // Loop through the seasons and create an option for each one
      data.seasons.forEach((season, index) => {
        const option = document.createElement('option');
        option.value = season.id;
        option.textContent = season.year;
        seasonSelect.appendChild(option);

        // Automatically select the first season and fetch its info
        if (index === 0) {
          option.selected = true;
          fetchSeasonInfo(uniqueTournamentId, tournamentName, season.id); // Fetch the first season's info
        }
      });

      // Add event listener for changing season
      seasonSelect.onchange = () => {
        const selectedSeasonId = seasonSelect.value;
        if (selectedSeasonId) {
          fetchSeasonInfo(uniqueTournamentId, tournamentName, selectedSeasonId);
        }
      };
    })
    .catch(error => console.error('Error fetching seasons:', error));
}

// Fetch rounds for the tournament and season
function fetchRounds(tournamentId, seasonId) {
  fetch(`https://www.sofascore.com/api/v1/unique-tournament/${tournamentId}/season/${seasonId}/rounds`)
    .then(response => response.json())
    .then(data => {
      const roundsContainer = document.getElementById('rounds');
      roundsContainer.innerHTML = '<h4>Rounds</h4>';
      
      // Check if the rounds property exists and is an array
      if (data.rounds && Array.isArray(data.rounds)) {
        const currentRound = data.currentRound?.round; // Get the current round number

        // Create a <ul> element to hold the round links
        const roundList = document.createElement('ul');
            // Add the class to the list item
            roundList.classList.add('scrollable'); // Correctly adding the class here
        roundsContainer.appendChild(roundList);

        // Loop through rounds and create <li> links
        data.rounds.forEach(round => {
          const listItem = document.createElement('li');
  
          const roundLink = document.createElement('a');
          roundLink.href = '#'; // Use a placeholder href
          roundLink.textContent = `${round.round}`;
          roundLink.onclick = (e) => {
            e.preventDefault(); // Prevent the default link behavior
            fetchEventsForRound(tournamentId, round.round);
          };

          // Highlight the current round
          if (round.round === currentRound) {
            roundLink.style.backgroundColor = '#4CAF50'; // Green background for the current round
            roundLink.style.color = 'white'; // White text for better contrast
            roundLink.style.padding = '2px 8px'; // Add padding for better appearance
          }

          listItem.appendChild(roundLink);
          roundList.appendChild(listItem);
        });
      } else {
        roundsContainer.innerHTML = '<p>No rounds data available.</p>';
      }
    })
    .catch(error => {
      console.error('Error fetching rounds:', error);
      document.getElementById('rounds').innerHTML = '<p>Failed to load rounds.</p>';
    });
}

// Fetch tournaments for a selected category
function fetchTournaments(categoryId, categoryName, tournamentsWithEvents) {
  document.getElementById('selected-country').textContent = categoryName;

  fetch(`https://www.sofascore.com/api/v1/category/${categoryId}/unique-tournaments`)
    .then(response => response.json())
    .then(data => {
      const tournamentsContainer = document.getElementById('tournaments');
      tournamentsContainer.innerHTML = '';

      // Ensure groups exist in data before accessing them
      if (data.groups && data.groups.length > 0) {
        // Create a <ul> element to hold the tournament links
        const tournamentList = document.createElement('ul');
        tournamentsContainer.appendChild(tournamentList);

        // Filter tournaments to only include those with scheduled events
        const filteredTournaments = data.groups.flatMap(group =>
          group.uniqueTournaments.filter(tournament => 
            tournamentsWithEvents.has(tournament.id)
          ) // <- Closing parenthesis was missing
        );

        // Display the filtered tournaments
        if (filteredTournaments.length > 0) {
          filteredTournaments.forEach((tournament, index) => {
            const listItem = document.createElement('li');
            const tournamentLink = document.createElement('a');
            tournamentLink.href = '#'; // Use a placeholder href
            tournamentLink.textContent = tournament.name;
            tournamentLink.onclick = (e) => {
              e.preventDefault(); // Prevent the default link behavior
              fetchTournamentDetails(tournament.id);
            };

            listItem.appendChild(tournamentLink);
            tournamentList.appendChild(listItem);

            // Auto-click the first tournament to load its details
            if (index === 0) {
              fetchTournamentDetails(tournament.id);
            }
          });
        } else {
          tournamentsContainer.textContent = 'No tournaments with events found.';
        }
      } else {
        tournamentsContainer.textContent = 'No tournaments available for this category.';
      }
    })
    .catch(error => console.error('Error fetching tournaments:', error));
}
// Fetch events for a specific tournament (no need for rounds)
function fetchEventsForTournament(tournamentId, tournamentName) {
  const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
  // No need to check for rounds here, just fetch scheduled events directly
  fetchScheduledEvents(tournamentId, today);
} 
// Initialize the app
fetchCategories();
</script>
</body>
</html>