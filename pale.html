<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Live Soccer Scores, Results, Betting Odds | FUTBOL</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<link rel="manifest" href="manifest.json">
        <style>
:root {     
    --color-dark-bg: #1F1F24;       /* Dark background for navigation */
    --color-light-gray-bg: #eaecf1; /* Light gray background for sections */
    --color-primary-blue: #007AFF;  /* Primary blue used in buttons and highlights */
    --color-secondary-blue: #82B1FF;/* Light blue used in progress circles */
    --color-dark-gray-text: #0d0c22;/* Dark gray text */
    --color-medium-gray-text: #666666; /* Medium gray text */
    --color-light-gray-text: #B2B2B2; /* Light gray text */
    --color-white: #FFFFFF;         /* White for text and backgrounds */
    --win-color: #01a06f; /* Wins */
    --draw-color: #cfd4d9;/* Draws */
    --loss-color: #ea4038;/* Losses */ 
    --color-support-1: #f5f6f8;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", Tahoma, Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Open Sans", sans-serif;
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
  font-variation-settings:
    "wdth" 100;
    font-size: 12px; 
    line-height: 1.5; 
    text-align: left;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: var(--color-light-gray-bg);
    color: var(--color-dark-gray-text);
    -webkit-font-smoothing: antialiased;
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
}
h4 {
    margin: 0;
    font-weight: 700;
    /*background: #e4ecf5;*/
    padding: 3px 0;
    border-top: 1px solid #e6e7eb; 
}
.W, .D, .L {   
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    border-radius: 2px;
    width: 16px !important;
    height: 15px !important;
    padding-top:1px;
    display: inline-flex;
    font-weight: 600;
    color: white;
    font-size: 11px;
    line-height: 2;
} 
.W, .win, .pos {
    background-color: var(--win-color);
}
.D, .draw {
    background-color: var(--draw-color);
}
.L, .loss, .neg {
    background-color: var(--loss-color);
}
/* Constants */
.flex {
    display: flex;
}
._F_r{
    flex-direction: row !important;
}
._F_c{
    flex-direction: column !important;
}
._F_ac {
    align-items: center;
}
._F_jc {
    justify-content: space-between;
}
.gT5 {
    gap: 5px;
}
.gT10 {
    gap: 10px;
}
.gT20 {
    gap: 20px;
}
._F1 {
    flex: 1;
}
._F2 {
    flex: 2;
}
._F3 {
    flex: 3;
}
a { 
    text-decoration: none;
}
a:hover { 
    text-decoration: none;
}
#superheader {
    color: #dcdde0;
    display: flex;
    align-items: center;
    justify-content: space-around;
}
 
.filter-bar>div { 
    justify-content: flex-end;
    display: flex;
    align-items: center;
    padding: 15px 0;
}

.date-filter, .time-filter {
    display: flex;
    align-items: center;
    gap: 10px; /* Space between elements */
}

.date-filter span, .time-filter span { 
    margin-right: 5px; /* Space between label and input */
}

input[type="date"], select {
    background-color: #2b3034;
    color: #747e8a;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
}

button#filter-btn {
    background-color: #007bff; /* Blue button similar to common design */
    color: white;
    border: none;
    padding: 5px 15px;
    border-radius: 4px;
    cursor: pointer;
}

button#filter-btn:hover {
    background-color: #0056b3; /* Darker blue on hover */
}

.bottom-nav {
    width: 100%; 
    border-top: 1px solid #ababab; /* Divider similar to the image */
    padding-top: 10px;
}

.bottom-nav i {
    margin-bottom: 3px;
}

.filters {
    display: flex;
    justify-content: center;
}

.filters__group {
    list-style: none;
    display: flex;
    gap: 23px; /* Space between navigation items */
    padding: 0;
    margin: 0;
}

.filters__group li { 
    min-width: 50px;
}

.filters__group li a {
    text-decoration: none;
    color: #ccc; 
    padding: 5px 10px;
    width: 100%;
    display: block;
    text-align: center;
    display: inline-flex;
    flex-direction: column;
    justify-content: center;
    font-weight: 400;
}

.filters__group li a.active, .filters__group li a:hover {
    color: #007bff;
    border-radius: 25px;
    font-weight: 400;
} 

.filter-bar button {
    background-color: var(--color-support-4);
    color: var(--color-tabs-secondary-fill-base);
    font-weight: bold;
    padding: 5px 8px;
    cursor: pointer;
}
.filter-bar input[type=date], .filter-bar input[type=select], button, .filter-bar select {
    height: 30px;
    border: 0;
    background-color: transparent;
    color: var(--color-support-1);
    padding: 0 4px;
    border-radius: 4px;
}
.calendar__navigation  {
    font-size: 22px;
    line-height: 0;
    width: 30px;
    background-color: rgba(3, 2, 41);
    border-radius: 4px;
    margin: 0 10px;
    cursor: pointer;
}
.calendar__datepicker {
    font-size: 13px;
    flex: 1;
    background-color: rgba(3, 2, 41);
    margin: 0 ;
    font-weight: 500;
}
/* Top Bar */
.top-bar {  
    display: flex;
    justify-content: space-evenly;
    width: 100%;  
    flex-direction: column;
}
/* Top Bar */
.top-bar>div:first-child {  
    display: flex;
    justify-content: space-between;  
    flex-direction: row;
    background-color: rgba(3, 2, 41);
}
/* Top Bar */
.top-bar>div:last-child {  
    display: flex;
    justify-content: space-between;
    flex-direction: row;
    background-color: rgba(3, 2, 41, 0.85);
    padding: 4px 0 6px;
}

.top-bar h1 {
    font-size: 1.4em;
    display: flex;
    align-items: center;
}

.top-bar h1::before {
    content: "âš½"; /* Ball icon for illustration */
    margin-right: 5px;
}

.top-bar-icons {
    display: flex;
    gap: 10px;
}

.top-bar-icons i {
    font-size: 1.2em;
    cursor: pointer;
}

        /* Date Bar */
        .date-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: #102531;
            font-size: 0.9em;
            border-bottom: 1px solid #1C3548;
        }

        .date-bar div {
            text-align: center;
            cursor: pointer;
        }

/* Categories container */
main { 
    position: relative;
    z-index: 2;
}
.crossline {
    z-index: 1;
    height: 10px;
    display: block;
}
/* Categories container */
.categories {
    overflow-y: auto;
    z-index: 1;
    position: relative;
    top: 0;  
        height: 100%;
} 

.categories::-webkit-scrollbar, .tab-content::-webkit-scrollbar, .sideRight::-webkit-scrollbar {
    width: 0; /* Set the width of the scrollbar */
}

.categories::-webkit-scrollbar-track, .tab-content::-webkit-scrollbar-track, .sideRight::-webkit-scrollbar-track {
    background: transparent; /* Color of the track */
}

.categories::-webkit-scrollbar-thumb, .tab-content::-webkit-scrollbar-thumb, .sideRight::-webkit-scrollbar-thumb {
    background: var(--color-support-3); /* Color of the thumb */
    border-radius: 1px; 
    height: 40px;
}
.categories h3 {
    font-size: 0.75rem; 
}
.category-header {
    padding: 10px; 
    font-weight: 700; 
    background-color: var(--color-support-3); 
}
.tournament h3 {
    margin: 0;
    padding: 10px 5px 10px 10px;
    background-color: var(--color-white); 
}
.tournament h3:not(:last-child) {
    border-bottom: 1px solid var(--color-light-gray-bg);
}
.tournament h3 img {
    margin-right: 5px;
}

.tournament ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    justify-content: space-between;
    flex-direction: column;
    gap: 5px;
}
.events-container {  
        flex-direction: column;
        gap: 5px;
        background-color: transparent; 
}
    .events-container li { 
    display: flex;
    align-items: center;
    background-color: var(--color-white); 
    border-radius: 8px;
    width: 97.5%;
    margin: 0 auto;
    margin-top: 5px;background: #fff;
    box-shadow: 0 1px 2px 1px rgba(64, 60, 67, .16); 
}

.events-container  li:not(:first-child) a {
    border-top: var(--color-support-3) 1px solid;   
} 
.events-container li .match-card {
    background: none;
    border: none;
    cursor: pointer;
    font-weight: normal;
    transition: all 0.3s ease;
    text-decoration: none;
    display: flex;
    width: 100%;
    flex-direction: column; 
} 

.events-container li:not(:first-child) a { 
    border-radius: 8px;  
}
.events-container li:first-child .match-card { 
    border-bottom-left-radius: 0;  
    border-bottom-right-radius: 0;  
}
.events-container li:nth-child(odd) {
    display: flex;
    align-items: center; 
}
.tournament .match-card {
    text-decoration: none;
    display: flex;
    justify-content: space-between;
}
.tournament h3 {
    background-color: var(--color-white);
    color: var(--color-medium-gray-text);
    font-weight: normal;
    cursor: pointer;
} 
.tournament.show h3 {  
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;  
    background-color: rgba(3, 2, 41, 0.05);
} 
.tournament.show {  
    border-bottom: 1px solid var(--color-light-gray-bg);
} 
.tournament .catName {
    color: var(--color-dark-bg);
    font-weight: 600;
    text-transform: uppercase; 
    margin-right: 5px;
    font-size: 0.6949rem; 

}
/* Add this to your CSS file or inside a <style> tag in the HTML */
    .tournament ul {
    display: none; /* Hide the event list by default */
    transition: display 0.3s ease-in-out; /* Optional: add a smooth transition effect */
}

.tournament.show ul {
    display: flex; /* Show the event list when parent has 'show' class */
    gap: 5px;
}
 

.match-info-container {
    display: flex;
    align-items: center;
    padding: 10px 10px 0;
}

.team-info {
    flex: 2;
    text-align: center;
    display: inline-flex;
    align-items: stretch;
} 

.team {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
}

.team-logo {
    width: 30px;
    height: 30px;
    margin-bottom: 5px;
}

.team-name { 
    font-weight: 700;
}

.match-details {
    text-align: center;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.match-date,
.match-time { 
    margin-bottom: 5px;
}
.detailScore__wrapper {
    display: flex;
    justify-content: space-between;
    font-size: 20px;
    font-weight: 600;
    margin: 0 15px;
}
.match-status {
    margin-top: 0;
    font-size: 11px;
    display: inline-flex;
    align-items: center;
    font-weight: normal;
    justify-content: center;
}
.match-status.live { 
    border-radius: 25px;
    padding: 5px 0;
    font-weight: 600;
    color: #F44336; 
}
.team-forms, .team-wins {
    display: flex;
    flex-direction: row;
    justify-content: space-around;
}
.team-wins {
    text-align: center;
    padding: 10px 0;
    background-color: #f8f9fb;
    border-top: 1px solid var(--color-light-gray-bg);
}
.team-stats {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    margin: 0 10px 20px;
}
.team-stats>div {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
}
.team-stats>div span {
    flex: 1;
    text-align: center;
    padding: 3px 0;
}
.title-team-stats {
    font-weight: 600;
    background-color: var(--color-light-gray-text);
}
.title-team-stats span:not(:first-child){
    border-left: 1px solid var(--color-support-1);
}
.team-forms span.scores {
    margin-left: 5px;
    float: right;
}
.home-team-forms, .away-team-forms, .teams-context, .home-team-wins, .away-team-wins, .teams-wins-context {
    display: flex;
    flex-direction: column; 
    gap: 5px;
}

.home-team-forms>div, .away-team-forms>div {
    display: flex; 
    gap: 2px; 
}
.team-events {
    display: flex;
    flex-direction: column;
    margin: 0 10px;
}
.team-events table {
    width: 100%;
    border-collapse: collapse; 
}
.team-events table th, .team-events table td, .h2h-event table th {
    border: 1px solid #eaecf1;
    padding: 2px 4px;
}
.h2h-event table td {
    border: 0; 
}
.h2h-event table tr:not(:last-child) {
    border-bottom: 1px solid #eaecf1; 
}
.team-events table th:nth-child(3), .team-events table td:nth-child(3) {
    text-align: center;
}
.tableOdds {
    display: flex;
    flex-direction: row;
    text-align: right;
    justify-content: space-between;
    background-color: var(--color-light-gray-bg);
    padding: 5px;
}
.tableOdds span {
    flex: 1; 
    text-align: center;
    font-weight: 600;
}
.tableOdds span:nth-child(2) {
    border-left: 1px solid #c4c7c9;
    border-right: 1px solid #c4c7c9;
}
.team-events .tableOdds span.won {
    font-weight: 700;
}
.team-events strong {
    font-weight: 500;
}
.teams-context {
    text-align: center;
}
.match-odds { 
    display: flex;
    justify-content: space-between;
    margin: 0 10px 0;
}
.statsC {
    background-color: #F0F2F4;
    border-top: 1px solid #ebecf1;
    padding: 10px 0;
}
.h2h-event { 
    display: flex;
    justify-content: space-around; 
    margin: 10px;
    border-radius: 25px;
    flex-direction: column; 
}

.h2h-event .event { 
    display: flex;
    justify-content: space-between; 
}
.h2h-event .event span {
    flex: 1;
}
.h2h-event .event span.home-team, .h2h-event .event span.away-team { 
    flex: 2;
}

.h2h-event .event .event-score { 
    text-align: center;
}

.match-odds * {
    flex: 1;
    text-align: center;
    font-weight: 600;
    align-items: center;
    display: flex;
    justify-content: center;
} 

.match-odds span.odds {
    border-top: 1px solid #e6e7eb;
    border-bottom: 1px solid #e6e7eb;
    position: relative;
    min-height: 22px;
} 

.match-odds>span:first-child, .match-odds>span:last-child { 
    text-align: center;
    font-weight: 600;
    display: flex;
    position: relative;
}

.match-odds>span:first-child div, .match-odds>span:last-child div { 
    display: flex;
    min-height: 25px;
}

.match-odds>div:first-child span, .match-odds>div:last-child span {
    display: inline-flex;
    padding: 3px 5px;
    opacity: .85;
    flex: 1 !important;
    width: 20px;
    justify-content: center;
}

.match-odds>div:first-child {
    border-right: 1px solid #e6e7eb;
}

.match-odds>div:last-child {
    border-left: 1px solid #e6e7eb;
}

.match-odds span:nth-child(3) { 
    flex: 1;
    border-left: 1px solid #e6e7eb;
    border-right: 1px solid #e6e7eb;
    align-items: center;
    display: inline-flex;
    justify-content: center; 
}
.match-odds>span:first-child span:nth-child(2), .match-odds>span:last-child span:nth-child(2) {  
    flex: 1;
    border-left: 0;
    border-right: 0
}
.logo {
    /* Add logo styling here */
    font-size: 16px;
    font-weight: 700;
}

.icons {
    display: flex;
    align-items: center;
    margin-right: 10px;
}

.icon {
    cursor: pointer;
    margin-right: 5px;
}

.filter-bar {
    display: flex;
    align-items: center;
}

.hidden {
    display: none;
}

.date-filter,
.time-filter {
    margin-right: 10px;
}
.logo-icons {    
    display: flex;
    justify-content: space-between;
    width: 100%;
    margin-top: 20px;
}

.stats-container {
    background-color: #091c3d;
    display: flex;
    background-color: transparent;
    gap: 11px;
    justify-content: space-evenly;
    margin-top: 5px;
}

.stat-title {
    display: flex;
    font-weight: 600;
    color: #9f9f9f; 
    line-height: 1.8;
}

.pregame-form .stat-title {
    display: flex;
    font-weight: 600;
    color: #9f9f9f;
    gap: 5px;
    line-height: 1.8;
}

.stat-title .value { 
    color:#091c3d !important;
}

.stat-value {  
  font-weight: 500; 
}
 
.trend-arrow {
    font-size: 12px; 
}

.trend-arrow.down { 
    color: #FB0000; 
}

.trend-arrow.up {
  color: #00AB00; /* Green color for up arrow */
}
.stat-card.up {
    border-bottom: 3px solid #00AB00;
}
.stat-card.down {
    border-bottom: 3px solid #FB0000;
}
.league-average { 
  color: #ccc;
  margin-top: 5px;
}
/* Scrollable Content */
.content {
    flex: 1;
    overflow-y: auto;
}

.content p {
    margin: 10px 0;
    line-height: 1.5;
}

/* Bottom Navigation Bar */
.bottom-nav {
    display: flex;
    justify-content: space-around;
    padding: 5px 0;
    background-color: #030229;
    border-top: 1px solid #1C3548;
}

.bottom-nav div {
    text-align: center;
    cursor: pointer;
    color: #fff;
}

.bottom-nav div.active {
    color: #F44336; /* Red color to indicate active section */
}
.stat-league {  
    display: flex;
    flex-direction: row;
    padding: 5px 0;
    align-items: center;
    background: white;
    border-bottom: 1px solid #eaecf1;
    gap: 5px;
    justify-content: space-evenly;
}
.stat-league span { 
    color: #091c3d !important;
}
.teams-form {
    display: flex;
    flex-direction: row;
    width: 100%;
    margin: 0 auto;
    align-items: center;
}
.teams-form .homes-team-form, .teams-form .aways-team-form {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.teams-form .homes-team-form .pregameForm, .teams-form .aways-team-form .pregameForm, .pregameForm {
    flex: 1;
    display: flex;
    flex-direction: row;
    justify-content: center;
    gap: 5px;
    margin: 10px 0 0;
}
.team-forms .homes-team-form .data, .team-forms .aways-team-form .data {
    position: absolute;
    top: -10px;
} 
.teams-form .homes-team-form>div, .teams-form .aways-team-form>div {  
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.manager-info {
    display: flex;
    flex-direction: column;
}
.teams-form .homes-team-form>div { 
    margin-left: auto; 
}
.teams-form .aways-team-form>div { 
    margin-right: auto;  
}
.home-bar,
.away-bar {
    position: relative;
}
.home-bar .team-cent,
.away-bar .team-cent {
    font-size: 10px;
}
.home-bar .team-cent {  
    margin-left: auto;
    font-weight: 600;
    position: absolute;
    left: -3px;         
}
.away-bar .team-cent {
    font-weight: 600;
    position: absolute;
    left: -3px;
}
.bar-wrapper {
    margin-top: 15px;
}
.team-info .home-bar .bar { 
    background-color: #93c0e6; 
}
.team-info .away-bar .bar { 
    background-color: #3d65ad; 
}
.stats-conversion {
    display: flex;
    align-items: center;
} 
.stats-conversion span {
    flex: 1;
    font-size: 18px;
    font-weight: 700;
    margin: 0 0 5px;
    text-align: center;
}
.stats-conversionspan:first-child {
    color: rgb(8, 98, 114);
}
.stats-conversion span:first-child small {
    color: rgba(8, 98, 114, 0.65);
}
.stats-conversion span:last-child {
    color: rgba(11, 179, 42);
}
.stats-conversion span:last-child small {
    color: rgba(11, 179, 42, 0.65);
}
.teams-form.manager {
    background-color: #F0F2F4;
    border-top: 1px solid #ebecf1;
    padding: 10px 0;
}
.box.animate { 
    width: 10px;
    height: 10px;
    position: relative;
    margin-top: 5px;
}
.box.animate::before {
    content: "";
    display: block;
    position: absolute;
    top: 0px;
    left: 0px;
    width: calc(100% - 1px);
    height: 50%;
    border-top: 1px solid rgb(217, 175, 0);
    border-left: 1px solid rgb(217, 175, 0);
    transform: translate3d(0px, 0px, 0px);
    animation: 660ms ease-in-out 0s 1 normal none running kCNzYT;
    z-index: 1;
}
.box.animate::after {
    content: "";
    display: block;
    position: absolute;
    bottom: 0px;
    right: 0px;
    width: calc(100% - 1px);
    height: 50%;
    transform: translate3d(0px, 0px, 0px);
    animation-timeline: auto;
    animation-range-start: normal;
    animation-range-end: normal;
    z-index: 1;
    border-right: 1px solid rgb(217, 175, 0);
    border-bottom: 1px solid rgb(217, 175, 0);
    animation: 660ms ease-in-out 0s 1 normal none running llWbcW;
}
.box.animate > .sideBox-inner {
    position: relative;
    width: 10px;
    height: 10px;
    background-size: 100% 200%;
    animation-timeline: auto;
    animation-range-start: normal;
    animation-range-end: normal;
    transform: translate3d(0px, 0px, 0px);
    z-index: 0;
    animation: 330ms ease-in-out 330ms 1 normal forwards running fwrfeI, 330ms ease-in 0ms 1 normal running bIXSM;
}
.team-manager-h2h {
    display: flex;
    flex-direction: column;
    align-items: center; 
}
.team-manager-h2h>div {
    display: flex;
    flex-direction: column;
    text-align: center;
    width: 100%;
}
.team-manager-h2h>div span {
    font-weight: 800;
}
.team-manager-h2h>div>div {
    display: flex;
    -webkit-box-pack: justify;
    justify-content: space-evenly;
}
.team-manager-h2h>div>div p {
    text-align: center;
    font-size: 15px;
    margin: 5px;
}
.team-manager-h2h>div>div p:first-child {
    color: #0bb32a;
}
.team-manager-h2h>div>div p:last-child {
    color: #374df5;
}
.team-manager-h2h>div>div p:nth-child(2) {
    color: #a4a9b3;
} 
.search-icon {
    position: relative;
    width: 20px;
    height: 20px;
    margin-left: 10px;
    cursor: pointer;
}

.circle {
    width: 8px;
    height: 8px;
    border: 3px solid #007AFF;
    border-radius: 50%;
    position: absolute;
    top: 0;
    left: 0;
}

.handle { 
    width: 10px;
    height: 3px;
    background-color: #007AFF;
    position: absolute;
    bottom: 8px;
    right: -2px;
    transform: rotate(45deg);
    transform-origin: top left;
} 
.ppg .homes-team-form span { 
    color: #93c0e6;
    display: inline-block;
    font-size:20px;
    font-weight: 700;
    margin: 0;
}
.ppg .aways-team-form span { 
    color: #3d65ad;
    display: inline-block;
    font-size:20px;
    font-weight: 700;
    margin: 0;
}
.ppg span small {   
    font-size:12px;
    font-weight: 600; 
}
.overall-stats * {
    display: flex;
    justify-content: center;
    flex: 1;
}
.overall-stats div span { 
    flex: 1;
    font-weight: 700;
}
.overall-stats div span:nth-child(2) { 
    flex: 2;
    font-weight: 400;
    color: #8d8989;
}
.overall-stats-wrapper { 
    display: flex;
}
.overall-stats-wrapper>div:first-child { 
    flex: 2;
    padding-bottom: 10px;
    background: #eef4f9;
    margin-top: 10px;
}
hr { 
    border-top: 1px solid #e6e7eb;
}
.icon {  
    height: 11px;
    left: 7px;
    position: absolute;
    top: 6px;
    width: 11px;
}

.increase { 
    background-image: url(icons/up.svg);
    background-repeat: no-repeat;
    transform: rotate(90deg);
}

.decrease { 
    background-image: url(icons/down.svg);
    background-repeat: no-repeat;
    transform: rotate(-90deg);
}
#stats-container div, .stats-container div {
    flex: 1;
    width: 50%;
    margin: 0 0 0 5px;
}

.stat-card {  
    display: flex;
    align-items: center;
    position: relative;
    display: -ms-flexbox;
    -webkit-box-orient: vertical;
    -webkit-box-direction: normal;
    -ms-flex-direction: column;
    flex-direction: column;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    background: #FFF;
    border-radius: 2px;
    -webkit-box-shadow: 0 1px 2px 1px rgba(64, 60, 67, .16);
    box-shadow: 0 1px 2px 1px rgba(64, 60, 67, .16);
    padding: 3px;
    min-width: 20%;
} 

.stats-container div table {
    width: 100%;
    border-collapse: collapse;
}
.stats-container div table th {
    min-width: 13px;
    text-align: center;
    font-weight: 600;
}
.stats-container tr td {
    text-align: center;
}
.stats-container tr td:first-child {
    text-align: left;
    padding-left: 2px;
    font-weight: 700;
} 
.stats-container .home-team-stats table tbody tr:last-child, .stats-container .away-team-stats table tbody tr:last-child {
    background-color:#93c0e630;
    font-weight: 500;
}
.homes-team-stats {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    flex: 1;
    gap: 5px;
    padding: 0 0 10px;
}
     </style>
    </head>
    <body> 
    <header id="superheader">

        <div class="top-bar">
            <div> 
        <!-- Filter Container -->
         <h1>Soccer</h1>
        <div class="filter-bar">
            <div> 
                <select id="time-range">
                    <option value="">Select Time</option>
                    <option value="3">3 Hours</option>
                    <option value="6">6 Hours</option>
                    <option value="12">12 Hours</option>
                </select> 
                <div class="search-icon" id="filter-btn">
                    <div class="circle"></div>
                    <div class="handle"></div>
                  </div>
            </div> 
        </div>
        </div>
        
            <div>
                <button class="calendar__navigation calendar__navigation--yesterday" title="Previous day">&#8249;</button>
                <button id="calendarMenu" aria-expanded="false" class="calendar__datepicker">
                    <i class="fas fa-calendar-alt" aria-hidden="true" style="margin-right: 5px;"></i>
                    <span id="current-day"></span> <!-- Current date dynamically displayed here -->
                </button>                
                <ul aria-labelledby="calendarMenu" class="calendar__days" id="date-list" hidden>
                    <!-- Dates will be appended here dynamically -->
                </ul>
                <button class="calendar__navigation calendar__navigation--tomorrow" title="Next day">&#8250;</button>
            </div>
        </div>
    </header> 
        <main class="content">            
            <div id="categories-container" class="categories"></div>
        
        <div id="details-container"></div> 
        </main>
        <div class="bottom-nav">
            <nav class="filters">
                <ul class="filters__group">
                    <li>
                        <a href="#all-games" data-status="all" class="active">
                            <i class="fas fa-landmark" aria-hidden="true"></i> <!-- Stadium icon -->
                            All Games
                        </a>
                    </li>
                    <li>
                        <a href="#live-games" data-status="live">
                            <i class="fas fa-broadcast-tower" aria-hidden="true"></i> <!-- Live icon -->
                            Live
                        </a>
                    </li>
                    <li>
                        <a href="#finished-games" data-status="finished">
                            <i class="fas fa-flag-checkered" aria-hidden="true"></i> <!-- Finished (Results) icon -->
                            Results
                        </a>
                    </li>
                    <li>
                        <a href="#scheduled-games" data-status="scheduled">
                            <i class="fas fa-clock" aria-hidden="true"></i> <!-- Clock icon for Upcoming -->
                            Upcoming
                        </a>
                    </li>
                </ul>
            </nav>
        </div> 
        <script>
 if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then((registration) => {
        //console.log('Service Worker registered with scope:', registration.scope);
      }).catch((error) => {
        //console.error('Service Worker registration failed:', error);
      });
    });
  }
 

function toggleFilter(filterClass) {
    // Hide all filters first
    document.querySelectorAll('.date-filter, .time-filter').forEach(function (filter) {
        filter.classList.add('hidden');
    });
    document.getElementById('filter-btn').classList.add('hidden');

    // Show the selected filter
    const selectedFilter = document.querySelector(`.${filterClass}`);
    if (selectedFilter) {
        selectedFilter.classList.toggle('hidden');
    }

    // Show the filter button if any filter is visible
    if (!document.querySelector('.date-filter').classList.contains('hidden') ||
        !document.querySelector('.time-filter').classList.contains('hidden')) {
        document.getElementById('filter-btn').classList.remove('hidden');
    }
}

        const baseURL = 'https://api.sofascore.com/api/v1';

const fetchJson = async (url) => {
    try {
        const response = await fetch(url);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Error ${response.status}: ${errorData.message}`);
        }
        return response.json();
    } catch (error) {
        console.error('Fetch error:', error.message);
        return null;
    }
};

const filterEventsByTime = (events, hours) => {
    const now = new Date().getTime();
    const timeRange = hours * 60 * 60 * 1000; // Convert hours to milliseconds

    return events.filter(event => {
        const eventTime = new Date(event.startTimestamp * 1000).getTime();
        return eventTime >= now && eventTime <= now + timeRange;
    });
};

const displayCategories = async (date, hours, status) => {
    const topTournamentsUrl = `${baseURL}/config/top-unique-tournaments/UG/football`;
    const scheduledEventsUrl = `${baseURL}/sport/football/scheduled-events/${date}`;
    const scheduledEventsUrl2 = `${baseURL}/sport/football/scheduled-events/${date}/inverse`;
    const oddsResponseUrl = `${baseURL}/sport/football/odds/1/${date}`;

    try {
        const topTournamentsData = await fetch(topTournamentsUrl).then(response => response.json());
        const scheduledEventsData = await fetch(scheduledEventsUrl).then(response => response.json());

        let allEvents = [...scheduledEventsData.events];

        // Check if the number of unique tournaments is less than 20 and add inverse events if true
        const uniqueTournamentIds = new Set(
            scheduledEventsData.events.map(event => event.tournament.uniqueTournament.id)
        );

        if (uniqueTournamentIds.size < 20) {
            const inverseScheduledEventsData = await fetch(scheduledEventsUrl2).then(response => response.json());
            allEvents = [...allEvents, ...inverseScheduledEventsData.events];
        }


        const oddsData = await fetch(oddsResponseUrl).then(response => response.json());
        const odds = oddsData?.odds || {};

        // Filter by date range for the selected day
        const startDate = new Date(date).setHours(0, 0, 0);
        const endDate = new Date(date).setHours(23, 59, 59);

        let filteredEvents = allEvents.filter(event => {
            const eventTime = new Date(event.startTimestamp * 1000).getTime();
            return eventTime >= startDate && eventTime <= endDate;
        });

        // If hours are specified, filter further by time range
        if (hours) {
            const timeRangeStart = new Date(date).setHours(0, 0, 0);
            const timeRangeEnd = new Date(date).setHours(hours, 59, 59);

            filteredEvents = filteredEvents.filter(event => {
                const eventTime = new Date(event.startTimestamp * 1000).getTime();
                return eventTime >= timeRangeStart && eventTime <= timeRangeEnd;
            });
        }

        // Filter by event status
        if (status) {
            filteredEvents = filteredEvents.filter(event => {
                switch (status) {
                    case 'live':
                        return event.status.type === 'inprogress';
                    case 'finished':
                        return event.status.type === 'finished';
                    case 'scheduled':
                        return event.status.type === 'notstarted';
                    default:
                        return true;
                }
            });
        }

        // Filter to only include events with available odds
        filteredEvents = filteredEvents.filter(event => odds[event.id]);

        const topTournaments = topTournamentsData.uniqueTournaments || [];
        const topTournamentIds = new Set(topTournaments.map(tournament => tournament.id));

        const topTournamentsMap = new Map();
        const otherCategoriesMap = new Map();

        // Organize filtered events by categories and tournaments
        filteredEvents.forEach(event => {
            const categoryName = event.tournament.category.name;
            const tournamentId = event.tournament.uniqueTournament.id;
            const tournamentName = event.tournament.name;

            const targetMap = topTournamentIds.has(tournamentId) ? topTournamentsMap : otherCategoriesMap;

            if (!targetMap.has(categoryName)) {
                targetMap.set(categoryName, new Map());
            }

            const tournaments = targetMap.get(categoryName);
            if (!tournaments.has(tournamentName)) {
                tournaments.set(tournamentName, {
                    id: tournamentId,
                    events: []
                });
            }

            tournaments.get(tournamentName).events.push(event);
        });

        // Render the categories
        const container = document.getElementById('categories-container');
        container.innerHTML = '';

        topTournamentsMap.forEach((tournaments, categoryName) => {
            const categoryItem = createCategorySection(tournaments, categoryName, odds);
            container.appendChild(categoryItem);
        });

        otherCategoriesMap.forEach((tournaments, categoryName) => {
            const categoryItem = createCategorySection(tournaments, categoryName, odds);
            container.appendChild(categoryItem);
        });
    } catch (error) {
        console.error('Error displaying categories:', error);
    }
};


const leagueStatsCache = {}; // Cache object for league stats
const createCategorySection = (tournaments, categoryName, odds) => {
    const categoryItem = document.createElement('div');
    categoryItem.classList.add('category');

    const tournamentsContainer = document.createElement('div');
    tournamentsContainer.classList.add('tournaments-container');

    tournaments.forEach((tournament, tournamentName) => {
        const tournamentSection = document.createElement('div');
        tournamentSection.classList.add('tournament');
        
        const tournamentHeader = document.createElement('h3');
        tournamentHeader.classList.add('flex', '_F_ac');
        const tournamentImage = `${baseURL}/unique-tournament/${tournament.id}/image`;
        tournamentHeader.innerHTML = `
            <img class="tourn" src="${tournamentImage}" alt="${tournamentName}" width="20" height="20" loading="lazy" />
            <span class="catName">${categoryName} </span> ${tournamentName}
        `;
        tournamentSection.appendChild(tournamentHeader);

        // League stats container
        const leagueStatsContainer = document.createElement('div');
        leagueStatsContainer.classList.add('league-stats-container');
        leagueStatsContainer.style.display = 'none'; // Hidden by default
        tournamentSection.appendChild(leagueStatsContainer);

        const eventsContainer = document.createElement('div');
        eventsContainer.classList.add('events-container');
        eventsContainer.style.display = 'none'; // Hidden by default
        tournamentSection.appendChild(eventsContainer);

        tournamentHeader.addEventListener('click', async () => {
            tournamentSection.classList.toggle('show');
            const isEventsVisible = eventsContainer.style.display === 'none';
            eventsContainer.style.display = isEventsVisible ? 'flex' : 'none';
            leagueStatsContainer.style.display = isEventsVisible ? 'block' : 'none';

            let seasonId, uniqueTournamentId;
            if (tournament.events && tournament.events.length > 0) {
                const event = tournament.events[0];
                seasonId = event.season?.id;
                uniqueTournamentId = event.tournament.id;
                tournamentIds = event.tournament.uniqueTournament.id;
                //console.log(seasonId);
                //console.log(uniqueTournamentId);
                //console.log(tournamentIds);
            }

            if (!leagueStatsCache[tournament.id]) {
                // Fetch league stats and tournament info only once
                const [overallStats, tournamentInfo] = await Promise.all([
                    calculateStatistics(null, uniqueTournamentId, seasonId),
                    fetchTournamentInfo(tournamentIds, seasonId)
                ]);

                leagueStatsCache[tournament.id] = { leagueStats: overallStats.leagueStats, tournamentInfo };
            }

            const { leagueStats, tournamentInfo } = leagueStatsCache[tournament.id];
            if (leagueStatsContainer.innerHTML === '') {
                displayLeagueStats(leagueStats, tournamentInfo, leagueStatsContainer);
            }

            if (eventsContainer.children.length === 0) {
                loadEvents(tournament.events, odds, eventsContainer, leagueStats);
            }
        }); 

        tournamentsContainer.appendChild(tournamentSection);
    });

    categoryItem.appendChild(tournamentsContainer);
    return categoryItem;
    
    const updateScores = async () => {
            try {
                const updatedScores = await fetchJson(`${baseURL}/sport/football/events/live`);

                // Check if updatedScores contains a list of events under a specific property
                if (!updatedScores || !Array.isArray(updatedScores.events)) {
                    console.error('Updated scores does not contain a list of events:', updatedScores);
                    return;
                }

                updatedScores.events.forEach(updatedEvent => {
                    const event = filteredEvents.find(event => event.id === updatedEvent.id);
                    if (event) {
                        const homeScoreElement = document.getElementById(`homeScore-${event.id}`);
                        const awayScoreElement = document.getElementById(`awayScore-${event.id}`);
                        if (homeScoreElement) {
                            homeScoreElement.textContent = updatedEvent.homeScore?.current ?? '';
                        }
                        if (awayScoreElement) {
                            awayScoreElement.textContent = updatedEvent.awayScore?.current ?? '';
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating scores:', error);
            }
        };

            setInterval(updateScores, 5000);
};

const displayLeagueStats = (leagueStats, tournamentInfo, container) => {
    // Calculate total matches
    const totalMatches = tournamentInfo.homeTeamWins + tournamentInfo.awayTeamWins + tournamentInfo.draws;

    // Calculate averages and percentages 
    const homeWinsPercentage = totalMatches > 0 ? ((tournamentInfo.homeTeamWins / totalMatches) * 100).toFixed(0) : '0';
    const awayWinsPercentage = totalMatches > 0 ? ((tournamentInfo.awayTeamWins / totalMatches) * 100).toFixed(0) : '0';
    const drawsPercentage = totalMatches > 0 ? ((tournamentInfo.draws / totalMatches) * 100).toFixed(0) : '0';

    container.innerHTML = `
        <div class="stat-league">
            <div class="stat-title">1:<span>${homeWinsPercentage}%</span></div>
            <div class="stat-title">X:<span>${drawsPercentage}%</span></div> 
            <div class="stat-title">2:<span>${awayWinsPercentage}%</span></div>
            <div class="stat-title">AG:<span>${leagueStats.goalsScored}</span></div>
            <div class="stat-title">BTS:<span>${leagueStats.BTTS}%</span></div>
            <div class="stat-title">+1.5:<span>${leagueStats.over1_5}%</span></div>
            <!-- <div class="stat-title">+2.5:<span>${leagueStats.over2_5}%</span></div>-->
        </div> 
    `;
};


// Render form percentage as a separate component
const renderFormPercentage = (containerId, formPercentage) => {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = `
        <div class="team-cent">${formPercentage}%</div>
        <div class="bar-wrapper" style="width:8px;height:60%;background-color:#ededed;display:flex;align-items:flex-end"">
            <div class="bar" style="width:8px;height:${formPercentage}%;"></div>
        </div>
    `;
};

// Render pregame form with stats and form display
const renderPregameForm = ({ name, avgRating, value, position, containerId }) => {
    const container = document.getElementById(containerId);
    const formDisplayId = `${containerId}-form-display`;

    const displayValue = value !== undefined && value !== null ? value : "-";
    const displayPosition = position !== undefined && position !== null ? position : "-";

    container.innerHTML = `
        <div class="stat-title" style="margin-top:10px;">
            #: <span class="value">${displayPosition}</span> 
            Pts: <span class="value">${displayValue}</span> 
            ${avgRating ? `<div class="box animate" cursor="default"><div class="sideBox-inner"></div></div> <strong class="value">${avgRating}</strong>` : ""}
        </div>
        <p><span id="${formDisplayId}"></span></p>
    `;
 
};

const fetchWinningOdds = async (eventId) => {
    try {
        const winningOddsResponse = await fetch(`${baseURL}/event/${eventId}/provider/1/winning-odds`);
        if (!winningOddsResponse.ok) {
            throw new Error(`Failed to fetch winning odds: ${winningOddsResponse.statusText}`);
        }
        
        const oddsData = await winningOddsResponse.json();
        return oddsData;
    } catch (error) {
        console.error("Error fetching winning odds data:", error);
    }
};

const renderWinningOdds = async (eventId) => {
    try {
        const oddsData = await fetchWinningOdds(eventId);
        if (oddsData) {
            const { home, away } = oddsData;

            const getStyledSpan = (expected, actual) => `
                <span style="background-color: ${actual > expected ? '#e59c0350' : '#a4a9b350'};">${expected}</span>
                <span style="background-color: ${actual > expected ? '#e59c03' : '#a4a9b3'};">${actual}</span>
            `;

            document.getElementById(`home-odds-${eventId}`).innerHTML = getStyledSpan(home.expected, home.actual);
            document.getElementById(`away-odds-${eventId}`).innerHTML = getStyledSpan(away.expected, away.actual);
        }
    } catch (error) {
        console.error(`Failed to fetch or render odds for event ${eventId}:`, error);
    }
};
 
// Calculate form percentage based on the form array
const calculateFormPercentage = (form) => {
    const expectedPoints = 3 * form.length; 
    const actualPoints = form.reduce((points, result) => {
        switch (result) {
            case "W": return points + 3;
            case "D": return points + 1;
            default: return points;
        }
    }, 0);
    return ((actualPoints / expectedPoints) * 100).toFixed(0);
};
 

// Display form history (Win, Draw, Loss) with icons and styles
const renderFormDisplay = (form, formDisplayId) => {
    const formDisplay = document.getElementById(formDisplayId);
    formDisplay.innerHTML = '';
    form.forEach(result => {
        const span = document.createElement('span');
        
        if (result === "W") {
            span.innerHTML = "<span class='W'>W</span>"; // FontAwesome check mark
        } else if (result === "L") {
            span.innerHTML = "<span class='L'>L</span>"; // Cross for Loss
        } else if (result === "D") {
            span.innerHTML = "<span class='D'>D</span>"; // Dash for Draw
        }
        
        span.classList.add(result); // Add class based on result type
        span.style.marginRight = "5px";
        formDisplay.appendChild(span);
    });
};

// Separate function to update the PPG in a targeted div
const renderManagerInfo = (manager, managerId) => {
    const managerContainerId = document.getElementById(managerId);
    if (manager && managerContainerId) {
        const { name, shortName, preferredFormation, performance = {} } = manager; 

        // Update the PPG value in the targeted div
        managerContainerId.innerHTML = `
            <div><strong>Manager: </strong>${shortName || name}<span><br /><strong> Formation: </strong>${preferredFormation || ""}</div>`;
    }
};


// Render manager details with performance stats
const renderManagerData = (manager, containerId) => {
    const container = document.getElementById(containerId);
    if (manager && container) {
        const { name, shortName, preferredFormation, performance = {} } = manager;
        const { total = 0, wins = 0, draws = 0, losses = 0, totalPoints = 0 } = performance;

        const winPercentage = total ? ((wins / total) * 100).toFixed(0) : 0;
        const drawPercentage = total ? ((draws / total) * 100).toFixed(0) : 0;
        const lossPercentage = total ? ((losses / total) * 100).toFixed(0) : 0; 
        const pointsPerGame = total ? (totalPoints / total).toFixed(2) : 0;

        container.innerHTML = ` 
                <td>${total}</td>
                <td>${pointsPerGame}</td>
                <td>${winPercentage}</td>
                <td>${drawPercentage}</td>
                <td>${lossPercentage}</td> 
        `;
    } else {
        container.innerHTML = "<p>Manager data not available</p>";
    }
};
 
// Separate function to update the PPG in a targeted div
const updatePPG = (manager, ppgContainerId) => {
    const ppgContainer = document.getElementById(ppgContainerId);
    if (manager && ppgContainer) {
        const { performance = {} } = manager;
        const { total = 0, totalPoints = 0 } = performance;
        const pointsPerGame = total ? (totalPoints / total).toFixed(2) : 0;

        // Update the PPG value in the targeted div
        ppgContainer.innerHTML = `<span>${pointsPerGame}</span>`;
    }
};



const updateCurrentTeamPPG = (managerData, events, ppgContainerId) => {
    const { managedTeamMap } = managerData;
    const ppgContainer = document.getElementById(ppgContainerId);
    if (!ppgContainer || !managedTeamMap) return;
    const statsContainer = document.getElementById(statsContainerId);
    if (!statsContainer || !managedTeamMap) return;

    const mostRecentEventId = Math.max(...Object.keys(managedTeamMap));
    const teamId = managedTeamMap[mostRecentEventId];

    const relevantEvents = Object.keys(managedTeamMap)
        .filter(eventId => managedTeamMap[eventId] === teamId)
        .map(id => parseInt(id));

    let totalGames = 0, totalPoints = 0;

    let total = relevantEvents.length;
    let wins = 0, draws = 0, losses = 0;


    relevantEvents.forEach(eventId => {
        const event = events.find(e => e.id === eventId);
        if (event && event.status.type === "finished") {
            totalGames++;
            const { winnerCode } = event;
            if ((winnerCode === 1 && event.homeTeam.id === teamId) || 
                (winnerCode === 2 && event.awayTeam.id === teamId)) {
                    wins++;
            } else if (winnerCode === 0) {
                draws++;
            } else {
                losses++;
            }
        }
    });

    // Calculate percentages
    const winPercentage = total ? ((wins / total) * 100).toFixed(0) : 0;
    const drawPercentage = total ? ((draws / total) * 100).toFixed(0) : 0;
    const lossPercentage = total ? ((losses / total) * 100).toFixed(0) : 0;

    const pointsPerGame = totalGames ? (totalPoints / totalGames).toFixed(2) : 0;
    ppgContainer.innerHTML = `<span>Current Team PPG: ${pointsPerGame}</span>`;
    
    // Update the stats container
    statsContainer.innerHTML = `
        <span><strong>TM: </strong> ${total}</span>
        <span><strong>W: </strong> ${winPercentage}%</span>
        <span><strong>D: </strong> ${drawPercentage}%</span>
        <span><strong>L: </strong> ${lossPercentage}%</span>
    `;

};



// Fetch pregame form and manager data
const fetchPregameForm = async (eventId, teamId, homeContainerId, awayContainerId, managerContainerId, ppgContainerId, managerInfoId) => {
    try {
        const teamResponse = await fetch(`${baseURL}/team/${teamId}`);
        if (!teamResponse.ok) throw new Error(`Failed to fetch team data: ${teamResponse.statusText}`);
        
        const teamData = await teamResponse.json();
        const { team } = teamData;
        const { manager } = team;

        const formResponse = await fetch(`${baseURL}/event/${eventId}/pregame-form`);
        if (!formResponse.ok) throw new Error(`Failed to fetch pregame form data: ${formResponse.statusText}`);
        
        const formData = await formResponse.json();
        const { homeTeam, awayTeam } = formData;

        if (homeTeam) {
            const { avgRating, form = [], value, position } = homeTeam;
            const formPercentage = calculateFormPercentage(form);

            renderFormPercentage(`home-team-form-${eventId}`, formPercentage);
            renderPregameForm({ name: "Home Team", avgRating, value, position, containerId: homeContainerId });
        }

        if (awayTeam) {
            const { avgRating, form = [], value, position } = awayTeam;
            const formPercentage = calculateFormPercentage(form);

            renderFormPercentage(`away-team-form-${eventId}`, formPercentage);
            renderPregameForm({ name: "Away Team", avgRating, value, position, containerId: awayContainerId });
        }

        if (manager) {
            fetchManagerData(manager.id, managerContainerId, ppgContainerId, managerInfoId);
        }

    } catch (error) {
        console.error("Error fetching pregame form or manager data:", error);
    }
};



const fetchManagerData = async (managerId, managerContainerId, ppgContainerId, managerInfoId) => {
    try {
        const response = await fetch(`${baseURL}/manager/${managerId}`);
        if (!response.ok) throw new Error(`Failed to fetch manager data: ${response.statusText}`);

        const managerData = await response.json();
        renderManagerInfo(managerData.manager, managerInfoId);
        renderManagerData(managerData.manager, managerContainerId);

        // Update the overall PPG using the existing function
        updatePPG(managerData.manager, ppgContainerId);

        // Fetch events for current team PPG calculation
        const eventsResponse = await fetch(`${baseURL}/manager/${managerId}/events/last/0`);
        if (!eventsResponse.ok) throw new Error(`Failed to fetch events: ${eventsResponse.statusText}`);

        const eventsData = await eventsResponse.json();

        // Update PPG for the current managed team
        //updateCurrentTeamPPG(managerData, eventsData.events, currentPpgContainerId);
    } catch (error) {
        console.error("Error fetching manager data:", error);
    }
};


const fetchHeadToHead = async (eventId, h2hContainerId) => {
    try {
        const response = await fetch(`${baseURL}/event/${eventId}/h2h`);
        if (!response.ok) throw new Error(`Failed to fetch H2H data: ${response.statusText}`);
        
        const h2hData = await response.json();
        const { teamDuel, managerDuel } = h2hData;

        // Render team duel data if available
        const teamDuelHTML = teamDuel ? renderTeamDuelStats(teamDuel) : '<div></div>';

        // Render manager duel data if available
        const managerDuelHTML = managerDuel ? renderManagerDuelStats(managerDuel) : '<div></div>';

        // Insert the HTML into the H2H container
        document.getElementById(h2hContainerId).innerHTML = teamDuelHTML + managerDuelHTML;
    } catch (error) {
        console.error("Error fetching head-to-head data:", error);
    }
};

const renderTeamDuelStats = (teamDuel) => { 
    const { homeWins, awayWins, draws } = teamDuel;
    return `
    <div>
        <h4 style="text-align:center;margin-top: 10px;">Head 2 Head</h4>
        <div>
            <p><strong>${homeWins}</strong></p>
            <p><strong>${draws}</strong></p>
            <p><strong>${awayWins}</strong></p>
        </div>
    </div>
    `;
};

const renderManagerDuelStats = (managerDuel) => { 
    const { homeWins, awayWins, draws } = managerDuel;
    return `
    <div>
        <span>Manager Duel</span>
        <div>
            <p><strong>${homeWins}</strong></p>
            <p><strong>${draws}</strong></p>
            <p><strong>${awayWins}</strong></p>
        </div>
    </div>
    `; 
};

/* 
const fetchTeamOverallStats = async (teamId, uniqueTournamentId, seasonId, containerId) => {
    try {
        const response = await fetch(`${baseURL}/team/${teamId}/unique-tournament/${uniqueTournamentId}/season/${seasonId}/statistics/overall`);
        if (!response.ok) throw new Error(`Failed to fetch team stats: ${response.statusText}`);
        
        const statsData = await response.json();
        const { statistics } = statsData;

        renderTeamStats(statistics, containerId);

    } catch (error) {
        console.error("Error fetching team stats:", error);
    }
};
 */

// Function to fetch team stats for home and away teams
const fetchTeamOverallStats = async (homeTeamId, awayTeamId, uniqueTournamentId, seasonId, containerId, conversionContainerId, goalGameDiffContainerId, columnType = 'center') => {
    try {
        // Fetch stats for the home team
        const homeResponse = await fetch(`${baseURL}/team/${homeTeamId}/unique-tournament/${uniqueTournamentId}/season/${seasonId}/statistics/overall`);
        if (!homeResponse.ok) throw new Error(`Failed to fetch home team stats: ${homeResponse.statusText}`);
        const homeStats = await homeResponse.json();
        
        // Fetch stats for the away team
        const awayResponse = await fetch(`${baseURL}/team/${awayTeamId}/unique-tournament/${uniqueTournamentId}/season/${seasonId}/statistics/overall`);
        if (!awayResponse.ok) throw new Error(`Failed to fetch away team stats: ${awayResponse.statusText}`);
        const awayStats = await awayResponse.json();
        
        // Extract the statistics for both teams
        const homeStatsData = homeStats.statistics;
        const awayStatsData = awayStats.statistics;
        
        // Call the render function based on column type
        if (columnType === 'center') {
            renderStats(homeStatsData, awayStatsData, containerId);
            goalConversionConceedStats(homeStatsData, awayStatsData, conversionContainerId);
            goalGameDiff(homeStatsData, awayStatsData, goalGameDiffContainerId);
        }  
    } catch (error) {
        console.error("Error fetching team stats:", error);
    }
};

const goalConversionConceedStats = (homeStats, awayStats, containerId) => {
    const container = document.getElementById(containerId);

    // Helper functions to safely calculate and return blank for invalid values
    const safeCalcPercentage = (value) => (isNaN(value) || value === '' || value === Infinity) ? '' : `${value}`;
    const safeCalc = (value) => (isNaN(value) || value === '' || value === Infinity) ? '' : value;

    // Calculate goals conversion rate
    const goalsConversionHomeRate = safeCalcPercentage(
        Math.round((homeStats.goalsScored / homeStats.shots) * 100)
    );
    const goalsConversionAwayRate = safeCalcPercentage(
        Math.round((awayStats.goalsScored / awayStats.shots) * 100)
    );

    // Calculate goals conceded rate
    const goalsConceedHomeRate = safeCalcPercentage(
        Math.round((homeStats.goalsConceded / homeStats.shotsAgainst) * 100)
    );
    const goalsConceedAwayRate = safeCalcPercentage(
        Math.round((awayStats.goalsConceded / awayStats.shotsAgainst) * 100)
    );

    // Safely calculate the sums of the rates
    const goalsConversionSum = safeCalc(Number(goalsConversionHomeRate) + Number(goalsConversionAwayRate));
    const goalsConceedSum = safeCalc(Number(goalsConceedHomeRate) + Number(goalsConceedAwayRate));

    // Ensure the calculated ratings are valid percentages or blank
    const homeConversionRating = goalsConversionSum
        ? Math.round((Number(goalsConversionHomeRate) / goalsConversionSum) * 100)
        : '-';
    const homeConceedRating = goalsConceedSum
        ? Math.round((Number(goalsConceedHomeRate) / goalsConceedSum) * 100)
        : '-';
    const awayConversionRating = goalsConversionSum
        ? Math.round((Number(goalsConversionAwayRate) / goalsConversionSum) * 100)
        : '-';
    const awayConceedRating = goalsConceedSum
        ? Math.round((Number(goalsConceedAwayRate) / goalsConceedSum) * 100)
        : '-';

    // Clear previous stats
    container.innerHTML = '';

    // Build stats HTML, leaving values blank if any are invalid
    const statsHTML = `
        <span>${homeConversionRating || ''}
            <small>/${homeConceedRating || ''}</small>
        </span>
        <span style="font-size:12px;font-weight:400;color:#9f9f9f;">
            Score/Conceed%
        </span>
        <span>${awayConversionRating || ''}
            <small>/${awayConceedRating || ''}</small>
        </span>
    `;

    // Insert the stats into the container
    container.innerHTML = statsHTML;
};

 
const goalGameDiff = (homeStats, awayStats, containerId) => {
    const container = document.getElementById(containerId);

    // Calculate goals conversion rate
    const goalsScoreHomeDiff = homeStats.goalsScored - homeStats.matches;

    const goalsScoreAwayDiff = awayStats.goalsScored - awayStats.matches;

    // Calculate goals conversion rate
    const goalsConceedHomeDiff = homeStats.matches - homeStats.goalsConceded;

    const goalsConceedAwayDiff = awayStats.matches - awayStats.goalsConceded;
 
    // Build stats HTML, leaving values blank if any are invalid
    const statsHTML = `
        <span>${goalsScoreHomeDiff || 0}
            <small>/${goalsConceedHomeDiff || 0}</small>
        </span>
        <span style="font-size:12px;font-weight:400;color:#9f9f9f;">
            Score/Conceed Diff
        </span>
        <span>${goalsScoreAwayDiff || 0}
            <small>/${goalsConceedAwayDiff || 0}</small>
        </span>
    `;
    // Insert the stats into the container
    container.innerHTML = statsHTML;

}


const renderStats = (homeStats, awayStats, containerId) => {
    const container = document.getElementById(containerId);

// Helper to safely calculate percentages
const safeCalcPercentage = (value) => (isNaN(value) || value === '' ? '' : `${Math.round(value)}%`);

// Helper to safely calculate and return blank if invalid
const safeCalc = (value) => (isNaN(value) || value === '' ? '' : value);

// Helper to color-code spans based on values
const getColoredSpan = (homeValue, awayValue, statType = '') => {
    let homeColor = '', awayColor = '';

    if (homeValue === awayValue) {
        // No coloring if values are the same
        homeColor = '';
        awayColor = '';
    } else if (statType === 'Shots Against') {
        // Lower is better for Shots Against
        homeColor = homeValue < awayValue ? 'green' : 'red';
        awayColor = awayValue < homeValue ? 'green' : 'red';
    } else if (statType === 'Shots For') {
        // Do not color Shots For
        homeColor = homeValue > awayValue ? 'green' : 'red';
        awayColor = awayValue > homeValue ? 'green' : 'red';
    } else {
        // Higher is better for other stats
        homeColor = homeValue > awayValue ? 'green' : 'red';
        awayColor = awayValue > homeValue ? 'green' : 'red';
    }

    const homeSpan = `<span class="home-value" style="color: ${homeColor};">${homeValue || ''}</span>`;
    const awaySpan = `<span class="away-value" style="color: ${awayColor};">${awayValue || ''}</span>`;
    return { homeSpan, awaySpan };
};

// Helper to add stats conditionally
const addStat = (statsList, homeValue, awayValue, label, statType = '') => {
    if (homeValue || awayValue) {
        const { homeSpan, awaySpan } = getColoredSpan(homeValue, awayValue, statType);
        statsList.push(`
            <div>
                ${homeSpan}
                <span>${label}</span>
                ${awaySpan}
            </div>
        `);
    }
};
    // Calculating Stats
    const attackStats = [];
    const defenseStats = [];
    const successfulDribblesHomePercentage = homeStats.dribbleAttempts
        ? safeCalcPercentage(Math.round((homeStats.successfulDribbles / homeStats.dribbleAttempts) * 100))
        : '';
    const successfulDribblesAwayPercentage = awayStats.dribbleAttempts
        ? safeCalcPercentage(Math.round((awayStats.successfulDribbles / awayStats.dribbleAttempts) * 100))
        : '';
    const averageGoalsHomeScored = homeStats.matches
        ? safeCalc((homeStats.goalsScored / homeStats.matches).toFixed(2))
        : '';
    const averageGoalsAwayScored = awayStats.matches
        ? safeCalc((awayStats.goalsScored / awayStats.matches).toFixed(2))
        : '';
    const averageGoalsHomeConceded = homeStats.matches
        ? safeCalc((homeStats.goalsConceded / homeStats.matches).toFixed(2))
        : '';
    const averageGoalsAwayConceded = awayStats.matches
        ? safeCalc((awayStats.goalsConceded / awayStats.matches).toFixed(2))
        : '';
    const homeAssists = safeCalc(homeStats.assists);
    const awayAssists = safeCalc(awayStats.assists);
    const cornersHomePerGame = homeStats.matches
        ? safeCalc((homeStats.corners / homeStats.matches).toFixed(2))
        : '';
    const cornersAwayPerGame = awayStats.matches
        ? safeCalc((awayStats.corners / awayStats.matches).toFixed(2))
        : '';
    const shotsHomePerGame = homeStats.matches
        ? safeCalc((homeStats.shots / homeStats.matches).toFixed(2))
        : '';
    const shotsAwayPerGame = awayStats.matches
        ? safeCalc((awayStats.shots / awayStats.matches).toFixed(2))
        : '';
    const roundedAccurateHomePassesPercentage = safeCalcPercentage(homeStats.accuratePassesPercentage);
    const roundedAccurateAwayPassesPercentage = safeCalcPercentage(awayStats.accuratePassesPercentage);
    const averageHomeBallPossession = safeCalcPercentage(homeStats.averageBallPossession);
    const averageAwayBallPossession = safeCalcPercentage(awayStats.averageBallPossession);
    const averageHomeShotsAgainst = homeStats.matches
        ? safeCalc((homeStats.shotsAgainst / homeStats.matches).toFixed(1))
        : '';
    const averageAwayShotsAgainst = awayStats.matches
        ? safeCalc((awayStats.shotsAgainst / awayStats.matches).toFixed(1))
        : '';
    const homeCleanSheets = safeCalc(homeStats.cleanSheets);
    const awayCleanSheets = safeCalc(awayStats.cleanSheets);

    // Add attack stats
    addStat(attackStats, homeStats.matches, awayStats.matches, 'Games Played');
    addStat(attackStats, averageGoalsHomeScored, averageGoalsAwayScored, 'Av Goals Scored');
    addStat(attackStats, homeAssists, awayAssists, 'Assists');
    addStat(attackStats, averageHomeBallPossession, averageAwayBallPossession, 'Possession%');
    addStat(attackStats, roundedAccurateHomePassesPercentage, roundedAccurateAwayPassesPercentage, 'Passes%');
    addStat(attackStats, successfulDribblesHomePercentage, successfulDribblesAwayPercentage, 'Dribbles%');
    addStat(attackStats, cornersHomePerGame, cornersAwayPerGame, 'Corners Per Game');

    // Add defense stats
    addStat(defenseStats, averageGoalsHomeConceded, averageGoalsAwayConceded, 'Av Goals Conceded', 'Shots Against'); 
    addStat(defenseStats, homeCleanSheets, awayCleanSheets, 'Clean Sheets');

    // Clear the container and render new stats
    container.innerHTML = '';
    const statsHTML = `
        <h4 style="text-align:center;">Overall Team Statistics</h4>
        <div class="team-stat overall-stats">
            ${attackStats.join('')}
            <hr />
            ${defenseStats.join('')}
        </div>
    `;
    container.innerHTML = statsHTML;
};

const renderTeamStats = (statistics, containerId) => {
    const container = document.getElementById(containerId);

    const {
        goalsScored,
        goalsConceded,
        assists,
        corners,
        successfulDribbles,
        dribbleAttempts,
        shotsAgainst,
        accuratePassesPercentage,
        averageBallPossession,
        matches
    } = statistics;

    // Round all values to 0 decimal places
    const successfulDribblesPercentage = Math.round((successfulDribbles / dribbleAttempts) * 100);
    const averageGoalsScored = (goalsScored / matches).toFixed(2);
    const averageGoalsConceded = (goalsConceded / matches).toFixed(2);
    const cornersPerGame = (corners / matches).toFixed(2);
    const averageShotsAgainst = (shotsAgainst / matches).toFixed(1);
    const roundedAccuratePassesPercentage = Math.round(accuratePassesPercentage);
    const roundedAverageBallPossession = Math.round(averageBallPossession);

    const statsHTML = ` 
        <div> 
            <span class="stat-title">Matches : <span class="value">${matches}</span></span>
        <div class="stat-title">
            <span><strong>GF:</strong> <span class="value">${averageGoalsScored || 0}</span></span>
            <span><strong>GA:</strong> <span class="value">${averageGoalsConceded || 0}</span></span>
            <span><strong>AST:</strong> <span class="value">${Math.round(assists) || 0}</span></span>
            <span><strong>Cr:</strong> <span class="value">${cornersPerGame || 0}</span></span>
        </div>
        <div> 
        <div class="stat-title">
            <span><strong>SA:</strong> <span class="value">${averageShotsAgainst || 0}</span></span>
            <span><strong>Dr:</strong> <span class="value">${successfulDribblesPercentage || 0}</span></span>
            <span><strong>Pa:</strong> <span class="value">${roundedAccuratePassesPercentage || 0}</span></span>
            <span><strong>Po:</strong> <span class="value">${roundedAverageBallPossession || 0}</span></span>
        </div>
    </div>
    `;

    container.innerHTML = statsHTML;
};

// Function to refresh match time div when the match starts
const scheduleMatchStartRefresh = (event) => {
    const matchStartTime = event.startTimestamp * 1000; // Convert to milliseconds
    const currentTime = Date.now(); // Current time in milliseconds
    const timeUntilStart = matchStartTime - currentTime;

    if (timeUntilStart > 0) {
        // Schedule the update at the match start time
        setTimeout(() => {
            const matchTimeElement = document.querySelector(`.match-time[data-event-id="${event.id}"]`);
            if (matchTimeElement) {
                matchTimeElement.innerHTML = `<span class="live-status">Live</span>`;
                startLiveTimer(event); // Start the live timer
            }
        }, timeUntilStart);
    }
};

// Utility function to fetch events data and filter for finished events excluding the current match
const fetchEventsData = async (tournamentId, seasonId, currentMatchId) => {
        const eventsUrl = `${baseURL}/tournament/${tournamentId}/season/${seasonId}/events`;
        const eventsData = await fetchJson(eventsUrl);

        // Check if eventsData exists and contains events
        if (!eventsData || !eventsData.events) return [];

        // Filter only finished events and exclude the current match
        const finishedEvents = eventsData.events.reverse().filter(event => 
            event.status.type === 'finished' && event.id !== currentMatchId
        );

        return finishedEvents;
    };

 

const calculateTeamPerformance = async (teamId, type, tournamentId, seasonId, currentMatchId) => {
    const events = await fetchEventsData(tournamentId, seasonId, currentMatchId);

    if (events.length === 0) return null;

    let gamesPlayed = 0;
    let wins = 0;
    let draws = 0;
    let losses = 0;
    let goalsScored = 0;
    let goalsConceded = 0;

    let points = 0;
    
    const filteredEvents = events.filter((event) => {
    if (type === 'overall') {
        return event.homeTeam.id === teamId || event.awayTeam.id === teamId;
        }
        return type === 'home' ? event.homeTeam.id === teamId : event.awayTeam.id === teamId;
    });

    const lastEvents = filteredEvents.slice(0, 5); // Return only the last 15 games 
    const form = lastEvents 
        .map((event) => {
            gamesPlayed++;

            const isHome = event.homeTeam.id === teamId;
            const teamScore = isHome ? event.homeScore.current : event.awayScore.current;
            const opponentScore = isHome ? event.awayScore.current : event.homeScore.current;

            goalsScored += teamScore;
            goalsConceded += opponentScore;

            if (event.winnerCode === 3) {
                points += 1; // Draw
                draws++;
            } else if (
                (event.winnerCode === 1 && isHome) ||
                (event.winnerCode === 2 && !isHome)
            ) {
                wins++;
                points += 3; // Win
            } else {
                losses++;
            }

        })
        .join('');

    const goalDifference = goalsScored - goalsConceded;

    return {
        points,
        gamesPlayed,
        wins,
        draws,
        losses,
        goalsScored,
        goalsConceded,
        goalDifference
    };
};


const getEventStats = async (homeTeamId, awayTeamId, tournamentId, seasonId, currentMatchId) => {
    const homeStatsOverall = await calculateTeamPerformance(homeTeamId, 'overall', tournamentId, seasonId, currentMatchId);
    const homeStatsHome = await calculateTeamPerformance(homeTeamId, 'home', tournamentId, seasonId, currentMatchId);
    const awayStatsOverall = await calculateTeamPerformance(awayTeamId, 'overall', tournamentId, seasonId, currentMatchId);
    const awayStatsAway = await calculateTeamPerformance(awayTeamId, 'away', tournamentId, seasonId, currentMatchId);

    renderStatsTable(homeStatsOverall, homeStatsHome, awayStatsOverall, awayStatsAway, currentMatchId);
};


const renderStatsTable = (homeStatsOverall, homeStatsHome, awayStatsOverall, awayStatsAway, eventId) => {
    const targetDiv = document.getElementById(`form-table-container-${eventId}`);
    if (!targetDiv) {
        console.error(`Container with ID form-table-container-${eventId} not found in the DOM.`);
        return;
    }

    const tableHTML = `
        <h4 style="text-align:center;margin-top:10px;">Form Comparison</h4>
        <div class="stats-container">
            <!-- Home Team Stats -->
            <div class="home-team-stats">
                <h4>Home Team</h4>
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>GP</th>
                            <th>W</th>
                            <th>D</th>
                            <th>L</th>
                            <th>GF</th>
                            <th>GA</th>
                            <th>GD</th>
                            <th>PTS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>H</td>
                            <td>${homeStatsHome.gamesPlayed}</td>
                            <td>${homeStatsHome.wins}</td>
                            <td>${homeStatsHome.draws}</td>
                            <td>${homeStatsHome.losses}</td>
                            <td>${homeStatsHome.goalsScored}</td>
                            <td>${homeStatsHome.goalsConceded}</td>
                            <td>${homeStatsHome.goalDifference}</td>
                            <td>${homeStatsHome.points}</td>
                        </tr>
                        <tr>
                            <td>O</td>
                            <td>${homeStatsOverall.gamesPlayed}</td>
                            <td>${homeStatsOverall.wins}</td>
                            <td>${homeStatsOverall.draws}</td>
                            <td>${homeStatsOverall.losses}</td>
                            <td>${homeStatsOverall.goalsScored}</td>
                            <td>${homeStatsOverall.goalsConceded}</td>
                            <td>${homeStatsOverall.goalDifference}</td>
                            <td>${homeStatsOverall.points}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Away Team Stats -->
            <div class="away-team-stats">
                <h4>Away Team</h4>
                <table >
                    <thead>
                        <tr>
                            <th></th>
                            <th>GP</th>
                            <th>W</th>
                            <th>D</th>
                            <th>L</th>
                            <th>GF</th>
                            <th>GA</th>
                            <th>GD</th>
                            <th>PTS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>A</td>
                            <td>${awayStatsAway.gamesPlayed}</td>
                            <td>${awayStatsAway.wins}</td>
                            <td>${awayStatsAway.draws}</td>
                            <td>${awayStatsAway.losses}</td>
                            <td>${awayStatsAway.goalsScored}</td>
                            <td>${awayStatsAway.goalsConceded}</td>
                            <td>${awayStatsAway.goalDifference}</td>
                            <td>${awayStatsAway.points}</td>
                        </tr>
                        <tr>
                            <td>O</td>
                            <td>${awayStatsOverall.gamesPlayed}</td>
                            <td>${awayStatsOverall.wins}</td>
                            <td>${awayStatsOverall.draws}</td>
                            <td>${awayStatsOverall.losses}</td>
                            <td>${awayStatsOverall.goalsScored}</td>
                            <td>${awayStatsOverall.goalsConceded}</td>
                            <td>${awayStatsOverall.goalDifference}</td>
                            <td>${awayStatsOverall.points}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;

    targetDiv.innerHTML = tableHTML;
};


// Utility function to generate increase/decrease icon
function getOddsChangeIcon(initialValue, currentValue) {
    if (initialValue && currentValue) {
        const initialDecimal = parseFloat(fractionalToDecimal(initialValue));
        const currentDecimal = parseFloat(fractionalToDecimal(currentValue));
        
        if (currentDecimal > initialDecimal) {
            return `<span class="icon increase"></span>`; // Green Up Icon
        } else if (currentDecimal < initialDecimal) {
            return `<span class="icon decrease"></span>`; // Red Down Icon
        }
    }
    return ''; // No icon if values are the same or missing
}


// Function to load events into a container
const loadEvents = async (events, odds, eventsContainer, leagueStats) => {
    for (const event of events) {
        const eventListItem = document.createElement('li');
        const eventLink = document.createElement('div');
        const uniqueEventId = `eventInfo-${event.id}`; // Unique ID for the event's info container
        const uniqueH2hContainer = `h2h-container-${event.id}`; // Unique ID for the event's info container
        eventLink.className = 'match-card';
        eventLink.dataset.eventId = event.id;

        const homeTeamId = event.homeTeam.id;
        const awayTeamId = event.awayTeam.id;
        const currentMatchId = event.id;
        const tournamentId = event.tournament.id;
        const uniqueTournamentId = event.tournament.uniqueTournament.id;
        const seasonId = event.season.id;
        // Fetch last 15 games for each team
        const homeTeamLastEvents = await fetchLastEvents(event.homeTeam.id, event.id, event.tournament.uniqueTournament.id);
        const awayTeamLastEvents = await fetchLastEvents(event.awayTeam.id, event.id, event.tournament.uniqueTournament.id);
 
        // Extract last 5 home/away games form
        const homeTeamHomeForm = getHomeAwayForm(homeTeamLastEvents, 'home', event.homeTeam.id);
        const awayTeamAwayForm = getHomeAwayForm(awayTeamLastEvents, 'away', event.awayTeam.id);

        const homeTeamPoints = getLastFiveGamesForm(homeTeamLastEvents, event.homeTeam.id, event.id);
        const awayTeamPoints = getLastFiveGamesForm(awayTeamLastEvents, event.awayTeam.id, event.id);

        const homeTeamForm = ((homeTeamPoints / 15) * 100).toFixed(0);
        const awayTeamForm = ((awayTeamPoints / 15) * 100).toFixed(0);
        // Fetch last 5 games with odds for each team
        const homeTeamLastFiveGames = await getLastFiveGames(homeTeamLastEvents, 'home', event.homeTeam.id);
        const awayTeamLastFiveGames = await getLastFiveGames(awayTeamLastEvents, 'away', event.awayTeam.id);
 
        // Calculate home and away win statistics
        const homeTeamStats = calculateWinStats(homeTeamLastEvents, event.homeTeam.id);
        const awayTeamStats = calculateWinStats(awayTeamLastEvents, event.awayTeam.id);
        
        // Fetch last 15 games for each team
        const homeTeamWonEvents = await fetchWonEvents(event.homeTeam.id, event.id, homeTeamStats.Wins);
        const awayTeamWonEvents = await fetchWonEvents(event.awayTeam.id, event.id, awayTeamStats.Wins);

        // Calculate home and away win statistics
        const homeTeamWonStats = calculateWinStats(homeTeamWonEvents, event.homeTeam.id);
        const awayTeamWonStats = calculateWinStats(awayTeamWonEvents, event.awayTeam.id);

        
        const homeStats = await calculateStatistics(homeTeamId, tournamentId, seasonId, event.id);
        const awayStats = await calculateStatistics(awayTeamId, tournamentId, seasonId, event.id);
        const overallStats = await calculateStatistics(null, tournamentId, seasonId, event.id);   

        const combinedStats = {
            goalsScored: ((parseFloat(homeStats.teamStats.goalsScored) + parseFloat(awayStats.teamStats.goalsScored))).toFixed(2),
            BTTS: ((parseFloat(homeStats.teamStats.BTTS) + parseFloat(awayStats.teamStats.BTTS)) / 2),
            over1_5: ((parseFloat(homeStats.teamStats.over1_5) + parseFloat(awayStats.teamStats.over1_5)) / 2),
            over2_5: ((parseFloat(homeStats.teamStats.over2_5) + parseFloat(awayStats.teamStats.over2_5)) / 2)
        };
  
        // Get odds data 
        const oddsData = odds[event.id] || {};
        const homeOddsData = oddsData.choices?.find(choice => choice.name === '1');
        const drawOddsData = oddsData.choices?.find(choice => choice.name === 'X');
        const awayOddsData = oddsData.choices?.find(choice => choice.name === '2');

        const homeInitialFractional = homeOddsData?.initialFractionalValue;
        const homeCurrentFractional = homeOddsData?.fractionalValue;

        const drawInitialFractional = drawOddsData?.initialFractionalValue;
        const drawCurrentFractional = drawOddsData?.fractionalValue;

        const awayInitialFractional = awayOddsData?.initialFractionalValue;
        const awayCurrentFractional = awayOddsData?.fractionalValue;
        // Generate odds values with icons
        const homeOdds = homeInitialFractional ? fractionalToDecimal(homeCurrentFractional) : '-';
        const homeIcon = getOddsChangeIcon(homeInitialFractional, homeCurrentFractional);

        const drawOdds = drawInitialFractional ? fractionalToDecimal(drawCurrentFractional) : '-';
        const drawIcon = getOddsChangeIcon(drawInitialFractional, drawCurrentFractional);

        const awayOdds = awayInitialFractional ? fractionalToDecimal(awayCurrentFractional) : '-';
        const awayIcon = getOddsChangeIcon(awayInitialFractional, awayCurrentFractional);


        const homeScore = event.homeScore?.current ?? '';
        const awayScore = event.awayScore?.current ?? ''; 

        const homeTeamName = homeScore > awayScore ? `<strong>${event.homeTeam.shortName}</strong>` : event.homeTeam.shortName;
        const awayTeamName = awayScore > homeScore ? `<strong>${event.awayTeam.shortName}</strong>` : event.awayTeam.shortName;
        const tolerance = 0.01; 

        eventLink.innerHTML = `
            <div class="match-info-container">
                <div class="team-info">
                    <div class="team">
                        <img src="${baseURL}/team/${event.homeTeam.id}/image" width="20" height="20" alt="${event.homeTeam.shortName}" loading="lazy" class="team-logo">
                        <span class="team-name">${homeTeamName}</span>                        
                        <div id="homeForm-${event.id}" class="pregameForm">${homeTeamPoints.form}</div>  
                        <div class="stat-title" style="margin-top:10px;display:flex;gap:5px;">
                            GF: <span class="value">${homeTeamPoints.goalsFor}</span> 
                            GA: <span class="value">${homeTeamPoints.goalsAgainst}</span> 
                            GD: <span class="value">${homeTeamPoints.goalDifference}</span> 
                        </div> 
                   </div>
                   <div id="home-team-form-${event.id}" class="home-bar"></div> 
                </div>
                <div class="match-details">
                    ${event.status.type === 'inprogress' 
                        ? `<div class="detailScore__wrapper">
                            <span class="score" id="homeScores-${event.id}">${homeScore}</span>
                            -
                            <span class="score" id="awayScores-${event.id}">${awayScore}</span>
                          </div>` 
                        : event.status.type === 'finished' 
                            ? `<div class="detailScore__wrapper">
                                <span class="score" id="homeScores-${event.id}">${homeScore}</span> 
                                -
                                <span class="score" id="awayScores-${event.id}">${awayScore}</span>
                              </div>` 
                            : `
                                 <div class="match-time">${new Date(event.startTimestamp * 1000).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</div>
                            `} 

                            <div class="match-status ${event.status.type === 'inprogress' ? 'live' : 'default'}">
                                <span id="live-timer-${event.id}"></span>
                            </div> 
                </div>
                <div class="team-info">
                   <div id="away-team-form-${event.id}" class="away-bar"></div>
                    <div class="team">
                        <img src="${baseURL}/team/${event.awayTeam.id}/image" width="20" height="20" alt="${event.awayTeam.shortName}" loading="lazy" class="team-logo">
                        <span class="team-name">${awayTeamName}</span>
                        <div id="awayForm-${event.id}" class="pregameForm">${awayTeamPoints.form}</div>   
                        <div class="stat-title" style="margin-top:10px;display:flex;gap:5px;">
                            GF: <span class="value">${awayTeamPoints.goalsFor}</span> 
                            GA: <span class="value">${awayTeamPoints.goalsAgainst}</span> 
                            GD: <span class="value">${awayTeamPoints.goalDifference}</span> 
                        </div>
                     </div>
                </div>
            </div>
                <div class="teams-form">
                    <div class="homes-team-form"> 
                        <div id="homePregameForm-${event.id}" class="pregame-form"></div>  
                    </div>
                    <div style="flex:0.5;text-align:center;">
                    <div class="stat-title" style="justify-content:center;align-items:center;gap:5px;">TG <span class="value">${combinedStats.goalsScored}</span>
                    </div>
                    </div>
                    <div class="aways-team-form"> 
                        <div id="awayPregameForm-${event.id}" class="pregame-form"></div>  
                    </div>
                </div>
                <h4 style="text-align:center;">H2H last 3 years</h4>
            <div class="h2h-event" id="${uniqueEventId}"></div>
      
                <h4 style="text-align:center; margin-top:10px;">Conversion Rate</h4>
                <div id="stats-conversion-${event.id}" class="stats-conversion"></div> 
                <div id="goal-game-diff-${event.id}" class="stats-conversion"></div>

                <div class="teams-form" style="gap:10px;">
                    <div class="homes-team-stats"> 
                    <div class="stat-card ${homeStats.teamStats.goalsScored}">
                        <div class="stat-value">
                            <span class="team-value">${homeStats.teamStats.goalsScored}</span> 
                        </div>
                        <div class="stat-title">GS</div>                    
                    </div> 
                    <div class="stat-card ${homeStats.teamStats.BTTS}">
                        <div class="stat-value">
                            <span class="team-value">${homeStats.teamStats.BTTS}</span> 
                        </div>
                        <div class="stat-title">Yes</div>                    
                    </div> 
                    <div class="stat-card ${homeStats.teamStats.over1_5}">
                        <div class="stat-value">
                            <span class="team-value">${homeStats.teamStats.over1_5}</span> 
                        </div>
                        <div class="stat-title">+1.5</div>                    
                    </div> 
                    <div class="stat-card ${homeStats.teamStats.over2_5}">
                        <div class="stat-value">
                            <span class="team-value">${homeStats.teamStats.over2_5}</span> 
                        </div>
                        <div class="stat-title">+2.5</div>                    
                    </div> 
                    </div>
                    <div class="homes-team-stats"> 
                    <div class="stat-card ${awayStats.teamStats.goalsScored}">
                        <div class="stat-value">
                            <span class="team-value">${awayStats.teamStats.goalsScored}</span> 
                        </div>
                        <div class="stat-title">GS</div>                    
                    </div> 
                    <div class="stat-card ${awayStats.teamStats.BTTS}">
                        <div class="stat-value">
                            <span class="team-value">${awayStats.teamStats.BTTS}</span> 
                        </div>
                        <div class="stat-title">Yes</div>                    
                    </div> 
                    <div class="stat-card ${awayStats.teamStats.over1_5}">
                        <div class="stat-value">
                            <span class="team-value">${awayStats.teamStats.over1_5}</span> 
                        </div>
                        <div class="stat-title">+1.5</div>                    
                    </div> 
                    <div class="stat-card ${awayStats.teamStats.over2_5}">
                        <div class="stat-value">
                            <span class="team-value">${awayStats.teamStats.over2_5}</span> 
                        </div>
                        <div class="stat-title">+2.5</div>                    
                    </div> 
                    </div>
                </div>
                    ${event.status.type === 'inprogress' 
                        ? `
                <h4 style="text-align:center; margin-top:10px;">Prematch Odds</h4>
                    <div class="match-odds">
                        <div id="home-odds-${event.id}"></div><span class="odds"><span>${homeIcon} ${fractionalToDecimal(homeInitialFractional)}</span></span>
                        <span class="odds">${drawIcon} ${fractionalToDecimal(drawInitialFractional)}</span>
                        <span class="odds"><span>${awayIcon} ${fractionalToDecimal(awayInitialFractional)}</span></span><div id="away-odds-${event.id}"></div>
                    </div> 
                <h4 style="text-align:center; margin-top:10px;">Live Odds</h4>
                    <div class="match-odds">
                        <div id="home-odds-${event.id}"></div><span class="odds"><span>${homeIcon} ${homeOdds}</span></span>
                        <span class="odds">${drawIcon} ${drawOdds}</span>
                        <span class="odds"><span>${awayIcon} ${awayOdds}</span></span><div id="away-odds-${event.id}"></div>
                    </div>  
                        ` 
                        : `
                    <div class="match-odds">
                        <div id="home-odds-${event.id}"></div><span class="odds"><span>${homeIcon} ${homeOdds}</span></span>
                        <span class="odds">${drawIcon} ${drawOdds}</span>
                        <span class="odds"><span>${awayIcon} ${awayOdds}</span></span><div id="away-odds-${event.id}"></div>
                    </div>   
                `} 

                <h4 style="text-align:center; margin-top:10px;">Tactics & Performance</h4>
                <div class="teams-form manager">
                    <div class="homes-team-form">  
                        <div id="homeManagerInfo-${event.id}" class="manager-info"></div>
                    </div>
                    <div class="aways-team-form">  
                        <div id="awayManagerInfo-${event.id}" class="manager-info"></div> 
                    </div>
                </div>
                <table style="text-align:center;">
                    <thead> 
                        <tr>                       
                            <th><strong>MP</strong></th>
                            <th><strong>P/G</strong></th>
                            <th><strong>W</strong></th>
                            <th><strong>D</strong></th>
                            <th><strong>L</strong></th>
                        </tr>
                    </thead>
                    <tbody class="homes-team-form">  
                        <tr id="homeManager-${event.id}"></tr>   
                        <tr id="awayManager-${event.id}"></tr> 
                    </tbody>
                </table>

                <div id="form-table-container-${event.id}"></div>
                
            <div class="overall-stats-wrapper">
                <div id="stats-container-${event.id}"></div>
                <div class="team-manager-h2h" id="${uniqueH2hContainer}" style="width:40%;"></div> 
            </div>
                  `;
            
        // Fetch and display most recent H2H event for the current event
        fetchAndDisplayMostRecentH2HEvent(event.customId, event.id, uniqueEventId);  
        fetchHeadToHead(event.id, uniqueH2hContainer);  // Pass the correct ID to fetchHeadToHead 
        eventListItem.appendChild(eventLink); 

        eventsContainer.appendChild(eventListItem);
             // Fetch stats once the container exists
             await getEventStats(event.homeTeam.id, event.awayTeam.id, event.tournament.id, event.season.id, event.id);
   
        // Example usage:
        renderWinningOdds(event.id);
        fetchPregameForm(
            event.id,
            homeTeamId,
            `homePregameForm-${event.id}`,
            `awayPregameForm-${event.id}`,
            `homeManager-${event.id}`,
            `homePPG-${event.id}`,
            `homeManagerInfo-${event.id}`
        );

        fetchPregameForm(
            event.id,
            awayTeamId,
            `homePregameForm-${event.id}`,
            `awayPregameForm-${event.id}`,
            `awayManager-${event.id}`,
            `awayPPG-${event.id}`,
            `awayManagerInfo-${event.id}`
        );


        // Example usage
       // fetchTeamOverallStats(homeTeamId, event.tournament.uniqueTournament.id, seasonId, `home-team-stats-container-${event.id}`);
        //fetchTeamOverallStats(awayTeamId, event.tournament.uniqueTournament.id, seasonId, `away-team-stats-container-${event.id}`);
        // Fetch stats for home and away teams
        fetchTeamOverallStats(homeTeamId, awayTeamId, uniqueTournamentId, seasonId, `stats-container-${event.id}`, `stats-conversion-${event.id}`, `goal-game-diff-${event.id}`, 'center');
    
        // Schedule the match time refresh
        scheduleMatchStartRefresh(event);
        // Start the live timer if the match is in progress
        if (event.status.type === 'inprogress') {
            startLiveTimer(event);
        } else if (event.status.description === 'Ended') {
            const timerElement = document.getElementById(`live-timer-${event.id}`);
            timerElement.innerHTML = 'FT';
        }

    // Function to refresh scores
    const refreshScores = async () => {
        try {
            const updatedEventDetails = await fetchJson(`${baseURL}/event/${event.id}`);
            if (!updatedEventDetails) return;
            const updatedEventData = updatedEventDetails.event;

            const homeScoreElement = document.getElementById(`homeScores-${event.id}`);
            const awayScoreElement = document.getElementById(`awayScores-${event.id}`);
            if (homeScoreElement) {
                homeScoreElement.textContent = updatedEventData.homeScore?.current ?? '';
            }
            if (awayScoreElement) {
                awayScoreElement.textContent = updatedEventData.awayScore?.current ?? '';
            }

        } catch (error) {
            console.error('Error refreshing scores:', error);
        }
    };

    // Refresh scores every 5 seconds
    const scoreUpdateInterval = setInterval(refreshScores, 5000);

    // Clear interval when navigating away from the event details
    const clearUpdateInterval = () => {
        clearInterval(scoreUpdateInterval);
    };
    
}
};


const formatTime = (time) => {
        return time < 10 ? `0${time}` : time; // Add leading zero if less than 10
    };

    const calculateElapsedTime = (event) => {
        const now = Math.floor(Date.now() / 1000);
        let elapsedSeconds = now - event.time.currentPeriodStartTimestamp;
            //console.log(event.time.currentPeriodStartTimestamp);
        // Check for match status descriptions
        if (event.status.description === 'Halftime') {
            return "HT"; // Display Halftime when it's halftime
        } else if (event.status.description === 'Ended') {
            return "Ended"; // Display Ended when the match has ended
        } else if (event.status.description === '1st half') {
            if (elapsedSeconds < 2700) {
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                return `${formatTime(minutes)}:${formatTime(seconds)}`; // Format as MM:SS
            }
            return "HT"; // Full time for 1st half
        } else if (event.status.description === '2nd half') {
            if (elapsedSeconds < 5400) {
                const minutes = Math.floor((elapsedSeconds + 2700) / 60); // Add 2700 seconds for the 1st half
                const seconds = (elapsedSeconds + 2700) % 60;
                return `${formatTime(minutes)}:${formatTime(seconds)}`; // Format as MM:SS
            }
            return "FT"; // Full time for 2nd half
        } 
        return "00:00"; // Default if not in progress
    };

    const startLiveTimer = (event) => {
        const timerElement = document.getElementById(`live-timer-${event.id}`);
        const interval = setInterval(() => {
            if (event.status.type === 'inprogress') {
                const elapsedTime = calculateElapsedTime(event);
                timerElement.innerHTML = `${elapsedTime}`;
            } else {
                clearInterval(interval); // Stop the timer if the game is finished
                timerElement.innerHTML = calculateElapsedTime(event); // Display the final state (FT)
            }
        }, 1000); // Update every second
    };


const calculateGameResult = (game, teamId) => {
    if (game.winnerCode === 3) {
        return 'D'; // Draw
    } else if (
        (game.winnerCode === 1 && game.homeTeam.id === teamId) ||
        (game.winnerCode === 2 && game.awayTeam.id === teamId)
    ) {
        return 'W'; // Win
    } else {
        return 'L'; // Loss
    }
};
const generateGamesHtml = (games, teamId) => {
    return `
        <table border="1" style="width: 100%; border-collapse: collapse;">
            <tbody>
                ${games.map((game) => {
                    const result = calculateGameResult(game, teamId);
                    const resultText = game.winnerCode === 3 ? 'D' : 
                        (game.winnerCode === 1 && game.homeTeam.id === teamId) || 
                        (game.winnerCode === 2 && game.awayTeam.id === teamId) ? 'W' : 'L';

                    return `
                        <tr>
                            <td class="tableDate">${new Date(game.startTimestamp * 1000).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit'}).replace('/', '.').replace('/', '.')}</td>
                            <td style="min-width:130px;">${game.homeTeam.shortName}<br />${game.awayTeam.shortName}</td>
                            <td class="${resultText}">${game.homeScore.current} - ${game.awayScore.current}</td>
                            <td>
                                <div class="tableOdds">
                                    <span class="${game.homeOddsClass}">${fractionalToDecimal(game.homeOdds)}</span>
                                    <span class="${game.drawOddsClass}">${fractionalToDecimal(game.drawOdds)}</span>
                                    <span class="${game.awayOddsClass}">${fractionalToDecimal(game.awayOdds)}</span>
                                </div>
                            </td> 
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
};


 

// Function to get last 5 games with odds
const getLastFiveGames = async (events, type, teamId) => {
    const finishedEvents = events.filter((event) => event.status.type === 'finished');
    const filteredEvents = finishedEvents.filter((event) => event.homeTeam.id === teamId || event.awayTeam.id === teamId
    );
    //.filter((event) => event.homeTeam.id === teamId || event.awayTeam.id === teamId
    //);
    const lastFiveFinishedEvents = filteredEvents.slice(0, 5);

    const oddsPromises = lastFiveFinishedEvents.map(async (event) => {
        const eventId = event.id;
        try {
            const oddsResponse = await fetch(`https://www.sofascore.com/api/v1/event/${eventId}/odds/1/all`);
            const oddsData = await oddsResponse.json();

            // Extract odds values
            const homeOdds = oddsData.markets[0]?.choices.find((choice) => choice.name === '1')?.fractionalValue || '-';
            const drawOdds = oddsData.markets[0]?.choices.find((choice) => choice.name === 'X')?.fractionalValue || '-';
            const awayOdds = oddsData.markets[0]?.choices.find((choice) => choice.name === '2')?.fractionalValue || '-';

            // Find the winning choice and determine the class for each odd
            const winningChoice = oddsData.markets[0]?.choices.find(choice => choice.winning === true);
            const winningClass = (oddsValue) => (winningChoice?.fractionalValue === oddsValue ? 'won' : '');

            return {
                ...event,
                homeOdds,
                drawOdds,
                awayOdds,
                homeOddsClass: winningClass(homeOdds),
                drawOddsClass: winningClass(drawOdds),
                awayOddsClass: winningClass(awayOdds),
            };
        } catch (error) {
            console.error(`Failed to fetch odds for event ${eventId}`, error);
            return {
                ...event,
                homeOdds: '-',
                drawOdds: '-',
                awayOdds: '-',
                homeOddsClass: '',
                drawOddsClass: '',
                awayOddsClass: '',
            };
        }
    });

    return await Promise.all(oddsPromises);
};
 
// Function to fetch odds for an event
const fetchOddsForEvent = async (eventId) => {
    try {
        const oddsResponse = await fetch(`https://www.sofascore.com/api/v1/event/${eventId}/odds/1/all`);
        const oddsData = await oddsResponse.json();

        // Extract odds values
        const homeOdds = oddsData.markets[0]?.choices.find((choice) => choice.name === '1')?.fractionalValue || '-';
        const drawOdds = oddsData.markets[0]?.choices.find((choice) => choice.name === 'X')?.fractionalValue || '-';
        const awayOdds = oddsData.markets[0]?.choices.find((choice) => choice.name === '2')?.fractionalValue || '-';

        return {
            homeOdds,
            drawOdds,
            awayOdds
        };
    } catch (error) {
        console.error(`Failed to fetch odds for event ${eventId}`, error);
        return {
            homeOdds: '-',
            drawOdds: '-',
            awayOdds: '-'
        };
    }
};

const fetchAndDisplayMostRecentH2HEvent = async (customId, currentMatchId, elementId) => {
    const url = `${baseURL}/event/${customId}/h2h/events`;
    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data && data.events) {
            const currentDate = new Date();
            const threeYearsAgoDate = new Date();
            threeYearsAgoDate.setFullYear(currentDate.getFullYear() - 2);

            // Filter events to include only those from the last 2 years and exclude the current match
            const filteredEvents = data.events
                .filter(event => event.status && event.status.type === 'finished' && event.id !== currentMatchId)
                .filter(event => new Date(event.startTimestamp * 1000) >= threeYearsAgoDate)
                .sort((a, b) => b.startTimestamp - a.startTimestamp)
                .slice(0, 5); // Limit to 5 events

            if (filteredEvents.length > 0) {
                // Fetch odds for all filtered events
                const eventsWithOdds = await Promise.all(filteredEvents.map(async (event) => {
                    const odds = await fetchOddsForEvent(event.id);
                    return {
                        ...event,
                        ...odds
                    };
                }));

                // Create HTML for the table with all filtered events with odds
                const eventsHtml = `
                    <table border="0" style="width: 100%; border-collapse: collapse;"> 
                        <tbody>
                            ${eventsWithOdds.map(event => {
                                const homeTeam = event.homeTeam.nameCode;
                                const awayTeam = event.awayTeam.nameCode;
                                const homeScore = event.homeScore.current;
                                const awayScore = event.awayScore.current;
                                const eventDate = new Date(event.startTimestamp * 1000).toLocaleDateString('en-GB', { month: '2-digit', year: '2-digit' })
                                    .replace('/', '.').replace('/', '.');

                                return `
                                    <tr>
                                        <td class="tableDate">${eventDate}</td>
                                        <td style="min-width:130px;">${homeTeam} - ${awayTeam}</td>
                                        <td>${homeScore} - ${awayScore}</td>
                                        <td>
                                            <div class="tableOdds" style="min-width:120px;">
                                                <span class="home-odds">${fractionalToDecimal(event.homeOdds)}</span>
                                                <span class="draw-odds">${fractionalToDecimal(event.drawOdds)}</span>
                                                <span class="away-odds">${fractionalToDecimal(event.awayOdds)}</span>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            // Combine stats and table HTML
                document.getElementById(elementId).innerHTML = statsHtml + eventsHtml;
            } else {
                document.getElementById(elementId).innerHTML = "No recent head-to-head matches found.";
            }
        }
    } catch (error) {
        console.error('Error fetching H2H events:', error);
        document.getElementById(elementId).innerHTML = "Error loading data.";
    }
};
const fetchLastEvents = async (teamId, currentMatchId, uniqueTournamentId) => {
    const response = await fetch(`${baseURL}/team/${teamId}/events/last/0`);
    const data = await response.json();
    const events = data.events.reverse(); // Reverse to get the most recent events first
    // Remove the current event from the list
    const lastEvents = events.filter(event => event.id !== currentMatchId && event.tournament?.uniqueTournament?.id === uniqueTournamentId && event.status.type === 'finished');
    const filteredEvents = lastEvents.slice(0, 5); // Return only the last 15 games 

    return filteredEvents;
};

const fetchTournamentInfo = async (uniqueTournamentId, seasonId) => {
    const url = `${baseURL}/unique-tournament/${uniqueTournamentId}/season/${seasonId}/info`;
    const data = await fetchJson(url);
    //console.log(data);
    return data.info || {};
};

const calculateStatistics = async (teamId, tournamentId, seasonId, currentMatchId) => {
    const finishedEvents = await fetchEventsData(tournamentId, seasonId, currentMatchId);

    if (finishedEvents.length === 0) return null;

    // Initialize variables for calculating team and league stats
    let teamGoalsScored = 0, teamGoalsConceded = 0, teamMatches = 0;
    let teamBTTS = 0, teamOver1_5 = 0, teamOver2_5 = 0;

    let leagueGoals = 0, leagueMatches = 0, leagueBTTS = 0;
    let leagueOver1_5 = 0, leagueOver2_5 = 0;

    finishedEvents.forEach(event => {
        // Check if the event is the current match; if so, skip it
        if (event.id === currentMatchId) return;

        const isHome = event.homeTeam.id === teamId;
        const teamScore = isHome ? event.homeScore.current : event.awayScore.current;
        const opponentScore = isHome ? event.awayScore.current : event.homeScore.current;
        const totalGoals = event.homeScore.current + event.awayScore.current;

        // If teamId is provided, calculate team-specific stats
        if (teamId && (event.homeTeam.id === teamId || event.awayTeam.id === teamId)) {
            teamGoalsScored += teamScore;
            teamGoalsConceded += opponentScore;
            teamMatches += 1;
            if (teamScore > 0 && opponentScore > 0) teamBTTS += 1;
            if (totalGoals > 1.5) teamOver1_5 += 1;
            if (totalGoals > 2.5) teamOver2_5 += 1;
        }

        // Calculate league-wide stats for every event
        leagueGoals += totalGoals;
        leagueMatches += 1;
        if (event.homeScore.current > 0 && event.awayScore.current > 0) leagueBTTS += 1;
        if (totalGoals > 1.5) leagueOver1_5 += 1;
        if (totalGoals > 2.5) leagueOver2_5 += 1;
    });

    // Calculate averages for the team, if team-specific data is being calculated
    const teamStats = teamId ? {
        goalsScored: (teamMatches > 0) ? (teamGoalsScored / teamMatches).toFixed(2) : 0,
        BTTS: (teamMatches > 0) ? ((teamBTTS / teamMatches) * 100).toFixed(0) : 0,
        over1_5: (teamMatches > 0) ? ((teamOver1_5 / teamMatches) * 100).toFixed(0) : 0,
        over2_5: (teamMatches > 0) ? ((teamOver2_5 / teamMatches) * 100).toFixed(0) : 0
    } : null;

    // Calculate league-wide averages
    const leagueStats = {
        goalsScored: (leagueMatches > 0) ? (leagueGoals / leagueMatches).toFixed(2) : 0,
        BTTS: (leagueMatches > 0) ? ((leagueBTTS / leagueMatches) * 100).toFixed(0) : 0,
        over1_5: (leagueMatches > 0) ? ((leagueOver1_5 / leagueMatches) * 100).toFixed(0) : 0,
        over2_5: (leagueMatches > 0) ? ((leagueOver2_5 / leagueMatches) * 100).toFixed(0) : 0
    };

    return { teamStats, leagueStats };
};



const fetchWonEvents = async (teamId, currentMatchId, Wins) => {
    const response = await fetch(`${baseURL}/team/${teamId}/events/last/0`);
    const data = await response.json();
    const events = data.events.reverse(); // Reverse to get the most recent events first
    // Remove the current event from the list
    const lastEvents = events.filter(event => event.id !== currentMatchId && event.status.type === 'finished');
    const filteredEvents = lastEvents.slice(0, Wins); // Return only the last 15 games 

    return filteredEvents;
};


const calculateWinStats = (events, teamId) => {
    let NotWins = 0;
    let Wins = 0;
    let Draws = 0;
    let Lost = 0;
    let totalEvents = 0;
    let goalsScoredWins = 0;
    let goalsConcededWins = 0;
    let goalsScoredNotWins = 0;
    let goalsConcededNotWins = 0;
    let btts = 0;
    let over15 = 0;
    let over25 = 0;

    events.forEach((event) => { 
        const homeScore = event.homeScore.current ?? 0; // Default to 0 if undefined
        const awayScore = event.awayScore.current ?? 0; // Default to 0 if undefined

        if (event.winnerCode === 3) {
            // Event is a draw
            NotWins++;
            totalEvents++;
            Draws++;

            // Check if the team is home or away
            if (event.homeTeam.id === teamId) {
                goalsScoredNotWins += homeScore;
                goalsConcededNotWins += awayScore;
            } else if (event.awayTeam.id === teamId) {
                goalsScoredNotWins += awayScore;
                goalsConcededNotWins += homeScore;
            }
        } else if (
            (event.winnerCode === 1 && event.homeTeam.id === teamId) || // Home win
            (event.winnerCode === 2 && event.awayTeam.id === teamId)    // Away win
        ) {
            // Event is a win
            Wins++;
            totalEvents++;

            // Check if the team is home or away
            if (event.homeTeam.id === teamId) {
                goalsScoredWins += homeScore;
                goalsConcededWins += awayScore;
            } else if (event.awayTeam.id === teamId) {
                goalsScoredWins += awayScore;
                goalsConcededWins += homeScore;
            }
        } else {
            // Event is a loss
            NotWins++;
            totalEvents++;
            Lost++;

            // Check if the team is home or away
            if (event.homeTeam.id === teamId) {
                goalsScoredNotWins += homeScore;
                goalsConcededNotWins += awayScore;
            } else if (event.awayTeam.id === teamId) {
                goalsScoredNotWins += awayScore;
                goalsConcededNotWins += homeScore;
            }
        } 

        // BTTS Calculation
        if (homeScore > 0 && awayScore > 0) btts++;

        // Over Goals Calculations
        if ((homeScore + awayScore) > 1.5) over15++;
        if ((homeScore + awayScore) > 2.5) over25++; 

    });

    return {
        Wins,
        NotWins,
        Draws,
        Lost,
        totalEvents,
        goalsScoredWins,
        goalsConcededWins,
        goalsScoredNotWins,
        goalsConcededNotWins,
        btts,
        over15,
        over25,
    };
};

const getTotalGoals = (events, teamId) => {
    const finishedEvents = events.filter((event) => event.status.type === 'finished');
    const lastFiveFinishedEvents = finishedEvents.slice(0, 5);

    let totalGoalsFor = 0;
    let totalGoalsAgainst = 0;

    lastFiveFinishedEvents.forEach((event) => {
        const homeScore = event.homeScore.current ?? 0; // Default to 0 if undefined
        const awayScore = event.awayScore.current ?? 0; // Default to 0 if undefined

        if (event.homeTeam.id === teamId) {
            totalGoalsFor += homeScore;
            totalGoalsAgainst += awayScore;
        } else {
            totalGoalsFor += awayScore;
            totalGoalsAgainst += homeScore;
        }
    });

    return {
        totalGoalsFor,
        totalGoalsAgainst
    };
};


const getHomeAwayForm = (events, type, teamId) => {
    const finishedEvents = events.filter((event) => event.status.type === 'finished');
    const filteredEvents = finishedEvents.filter((event) =>
        type === 'home' ? event.homeTeam.id === teamId : event.awayTeam.id === teamId
    );
    const lastFiveFilteredEvents = filteredEvents.slice(0, 5);

    const form = lastFiveFilteredEvents
        .reverse()
        .map((event) => {
            let result = '';
            if (event.winnerCode === 3) {
                result = '<span class="D">D</span>'; // Draw
            } else if (
                (event.winnerCode === 1 && event.homeTeam.id === teamId) ||
                (event.winnerCode === 2 && event.awayTeam.id === teamId)
            ) {
                result = '<span class="W">W</span>'; // Win
            } else {
                result = '<span class="L">L</span>'; // Loss
            }
            return result;
        })
        .join('');

    const { totalGoalsFor, totalGoalsAgainst } = getTotalGoals(filteredEvents, teamId);

    return {
        form,
        totalGoalsFor,
        totalGoalsAgainst
    };
};
const getLastFiveGamesForm = (events, teamId, currentMatchId) => {
    // Filter finished matches excluding the current match
    const finishedEvents = events.filter((event) => event.status.type === 'finished' && event.id !== currentMatchId);
    
    // Sort events by date (latest first) and get the last 5 matches
    const lastFiveFinishedEvents = finishedEvents
        .sort((a, b) => new Date(b.startTimestamp) - new Date(a.startTimestamp))
        .slice(0, 5);
    
    let points = 0;
    let goalsFor = 0;
    let goalsAgainst = 0;

    const form = lastFiveFinishedEvents
        .reverse() // Show form in chronological order
        .map((event) => { 
            const homeScore = event.homeScore.current ?? 0; // Default to 0 if undefined
            const awayScore = event.awayScore.current ?? 0; // Default to 0 if undefined

            if (event.homeTeam.id === teamId) {
                goalsFor += homeScore;
                goalsAgainst += awayScore;
            } else if (event.awayTeam.id === teamId) {
                goalsFor += awayScore;
                goalsAgainst += homeScore;
            }

            let result = '';
            if (event.winnerCode === 3) {
                points += 1; // Draw
                result = '<span class="D">D</span>';
            } else if (
                (event.winnerCode === 1 && event.homeTeam.id === teamId) ||
                (event.winnerCode === 2 && event.awayTeam.id === teamId)
            ) { 
                points += 3; // Win
                result = '<span class="W">W</span>';
            } else { 
                result = '<span class="L">L</span>'; // Loss
            }
            return result;
        })
        .join('');

    const goalDifference = goalsFor - goalsAgainst;

    return {
        form,
        points,
        goalsFor,
        goalsAgainst,
        goalDifference
    };
};

     

        const fetchEventDetails = async (eventId) => { 
            await displayEventDetails(eventId);
        };
        
        const displayEventDetails = async (eventId) => {
                        // Function to fetch and display event details
                        const fetchAndDisplayDetails = async () => {
                            try {
                                const eventDetails = await fetchJson(`${baseURL}/event/${eventId}`);
                                if (!eventDetails) return;
                                const eventData = eventDetails.event;
                                const eventContainer = document.getElementById('details-container');

                                eventContainer.innerHTML = `
                                    <div class="duelParticipant"> 
                                        <div class="match-time">
                                            <span>${new Date(eventData.startTimestamp * 1000).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }).replace(',', ' ').replace('/', ' ')}</span>
                                        </div>
                                        <div class="team duelParticipant__home">
                                            <img src="${baseURL}/team/${eventData.homeTeam.id}/image" width="20" height="20" alt="${eventData.homeTeam.shortName}" loading="lazy" class="team-logo">
                                            <div class="team-name">${eventData.homeTeam.shortName}</div>
                                        </div>

                                        <div class="duelParticipant__score score">
                                            <div class="detailScore__matchInfo">
                                                <div class="detailScore__wrapper" id="${eventData.status.type}">
                                                    <span class="score" id="homeScores-${eventData.id}">${eventData.homeScore?.current ?? ''}</span>
                                                    <span class="detailScore__divider">-</span>
                                                    <span class="score" id="awayScores-${eventData.id}">${eventData.awayScore?.current ?? ''}</span>
                                                </div>
                                                <div class="detailScore__status">
                                                    <span class="${eventData.status.type === 'inprogress' ? 'live' : '_detailStatus'}">
                                                        ${eventData.status.type === 'inprogress' ? 'Live' : eventData.status.type === 'finished' ? 'FINISHED' : new Date(eventData.startTimestamp * 1000).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}    
                                                    </span>
                                                </div>
                                            </div> 
                                        </div>
                                        <div class="team duelParticipant__away">
                                            <img src="${baseURL}/team/${eventData.awayTeam.id}/image" width="20" height="20" alt="${eventData.awayTeam.shortName}" loading="lazy" class="team-logo">
                                            <div class="team-name">${eventData.awayTeam.shortName}</div>
                                        </div>
                                    </div>                    
                                    <div id="next-match" class="flex _F_r _F_jc">
                                        <div id="home-next-match" class="next-match"></div>
                                        <div id="away-next-match" class="next-match"></div>
                                    </div> 
                                    <!-- Tabs Navigation -->
                                    <div id="events-tabs" class="tab-contentContainer">
                                        <div class="tab-menu">
                                            <button class="tab-button active" data-tab="overall-events">Overall</button>
                                            <button class="tab-button" data-tab="home-vs-away-events">Home vs Away</button>
                                        </div>
                                        <div class="tab-content active" id="overall-events">
                                            <!-- Tab content for Overall Events -->
                                            <div class="form-container flex _F_r _F_jc gT20">
                                                <div class="home-form">
                                                    <h3>Last matches: ${eventData.homeTeam.shortName}</h3>
                                                    <div id="home-team-form"></div>
                                                </div>
                                                <div class="away-form">
                                                    <h3>Last matches: ${eventData.awayTeam.shortName}</h3>
                                                    <div id="away-team-form"></div>
                                                </div>
                                            </div> 
                                            <div class="h2h">
                                                <h3>Head-to-head matches</h3>
                                                <div id="overallH2HContainer"></div>
                                            </div>
                                        </div>
                                        <div class="tab-content" id="home-vs-away-events">
                                            <!-- Tab content for Home vs Away Events -->
                                            <div class="form-container flex _F_r _F_jc gT20">
                                                <div class="atHome-form">
                                                    <h3>Last Home matches: ${eventData.homeTeam.shortName}</h3>
                                                    <div id="at-home-form"></div>
                                                </div>
                                                <div class="atAway-form">
                                                    <h3>Last Away matches: ${eventData.awayTeam.shortName}</h3>
                                                    <div id="at-away-form"></div>
                                                </div>
                                            </div>                                        
                                            <div class="h2h">
                                                <h3>Head-to-head matches</h3>
                                                <div id="homeTeamH2HContainer"></div>
                                            </div>
                                        </div>
                                    </div>           
                                `;
 

                            } catch (error) {
                                console.error('Error displaying event details:', error);
                            }
                        };

                        // Initial display of event details
                        await fetchAndDisplayDetails();
 
                        // Call `clearUpdateInterval` when navigating away or as needed
                        // For example:
                        // document.getElementById('details-container').addEventListener('someEvent', clearUpdateInterval);
                    };

 
            document.addEventListener('DOMContentLoaded', () => {
                const today = new Date();
                let selectedDate = today;
                let selectedHours = '';

                // Function to update the displayed date
                function updateCalendarDisplay(date) {
                    const formattedDate = formatDate(date);
                    const currentDayElem = document.getElementById('current-day');
                    if (currentDayElem) currentDayElem.innerText = formattedDate;
                }

                // Function to format the date to YYYY-MM-DD
                function formatDate(date) {
                    return date.toISOString().split('T')[0]; // Format date as 'YYYY-MM-DD'
                }

                // Fetch and display events for the selected date
                function fetchEventsByDate(date, hours) {
                    //console.log('Fetching events for date:', date, 'with hours:', hours);
                    // Ensure displayCategories can handle optional status argument
                    displayCategories(date, hours);
                }

                // Initial data load: Display today's date and fetch events
                updateCalendarDisplay(today);
                fetchEventsByDate(formatDate(today), selectedHours);

                // Handle 'yesterday' button click
                const yesterdayBtn = document.querySelector('.calendar__navigation--yesterday');
                if (yesterdayBtn) {
                    yesterdayBtn.addEventListener('click', () => {
                        selectedDate.setDate(selectedDate.getDate() - 1); // Move to the previous day
                        updateCalendarDisplay(selectedDate);
                        fetchEventsByDate(formatDate(selectedDate), selectedHours);
                    });
                }

                // Handle 'tomorrow' button click
                const tomorrowBtn = document.querySelector('.calendar__navigation--tomorrow');
                if (tomorrowBtn) {
                    tomorrowBtn.addEventListener('click', () => {
                        selectedDate.setDate(selectedDate.getDate() + 1); // Move to the next day
                        updateCalendarDisplay(selectedDate);
                        fetchEventsByDate(formatDate(selectedDate), selectedHours);
                    });
                }

                // Filter events based on the selected time range
                const filterBtn = document.getElementById('filter-btn');
                if (filterBtn) {
                    filterBtn.addEventListener('click', () => {
                        selectedHours = document.getElementById('time-range').value;
                        fetchEventsByDate(formatDate(selectedDate), selectedHours);
                    });
                }

                document.querySelectorAll('.bottom-nav a').forEach(link => {
                    link.addEventListener('click', async event => {
                        
                    event.preventDefault();
                    const filterType = link.getAttribute('href').replace('#', '');

                    const date = document.getElementById('current-day').innerText;
                    let hours = '';
                    let status = ''; // Define default status as an empty string


                       // Handle different types of game filters
            switch (filterType) {
                case 'all-games':
                    displayCategories(date, hours);
                    break;
                case 'live-games':
                    status = 'live';
                    displayCategories(date, hours, status);
                    break;
                case 'finished-games':
                    status = 'finished';
                    displayCategories(date, hours, status);
                    break;
                case 'scheduled-games':
                    status = 'scheduled';
                    displayCategories(date, hours, status);
                    break;
                default:
                    displayCategories(date, hours);
                    break;
            }


                        // Remove 'active' class from all links
                        document.querySelectorAll('.bottom-nav a').forEach(link => {
                            link.classList.remove('active');
                        });

                        // Add 'active' class to the clicked link
                        event.target.classList.add('active');
                    });
                }); 
                

            });
 

// Helper function to convert fractional odds to decimal
function fractionalToDecimal(fractionalOdds) {
    const [numerator, denominator] = fractionalOdds.split('/');
    return (parseInt(numerator) / parseInt(denominator) + 1).toFixed(2);
}

        </script> 
    </body>
</html>
