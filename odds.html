<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soccer Analysis System</title>
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.0.2/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script> <!-- Add this line -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="chunk.css" rel="stylesheet">
    <style>     
        html {
    font-size: 13px;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}

html { 
    text-size-adjust: 100%;
}

html, body {
    font-family: "UI Sans", Lato, sans-serif;
    -webkit-font-smoothing: antialiased;
    font-synthesis: none;
    font-variant-ligatures: no-common-ligatures;
}

*, ::after, ::before {
    box-sizing: border-box;
}

*, ::before, ::after {
    background-repeat: no-repeat;
    background-position: 50% 50%;
} 
*, ::after, ::before {
    box-sizing: border-box;
} 
*, ::before, ::after {
    background-repeat: no-repeat;
    background-position: 50% 50%;
}
 
::selection {
    background: rgba(0, 0, 0, 0.3);
    color: rgb(255, 255, 255);
}
        body { 
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            overflow-y: hidden; /* Enable vertical scrolling */
        }

        .content-container {  
            padding: 20px; 
            overflow-y: auto; /* Enable vertical scrolling */ 
            width: 80%;
            color: #bababa;
            background-color: #191919;
        }

        h1 {
            text-align: center;
        }

        #odds-container {
            margin-bottom: 20px;
        }

        canvas {
            width: 100%;
            height: 400px;
        }
        /* Categories container */
main {
    height: calc(100vh - 76px); /* Fill the viewport height minus 76px */  
    display: flex;
    position: relative;
}
.logo {
    color: #fff;
    font-weight: 700;
    font-size: 2em;
}
/* Categories container */
.categories {
    width: 20%; /* Fill the viewport height minus 76px */
    overflow-y: auto; /* Enable vertical scrolling */
    padding: 5px; /* Optional padding */ 
    border-right: var(--color-support-3) 1px solid;
    padding-top: 7px; 
    background-color: #222222;
    color: #9c9c9c;
    font-size: 12px;
}
.categories::-webkit-scrollbar, .tab-content::-webkit-scrollbar, .content-container::-webkit-scrollbar {
    width: 2px; /* Set the width of the scrollbar */
}

.categories::-webkit-scrollbar-track, .tab-content::-webkit-scrollbar-track, .content-container::-webkit-scrollbar-track {
    background: transparent; /* Color of the track */
}

.categories::-webkit-scrollbar-thumb, .tab-content::-webkit-scrollbar-thumb, .content-container::-webkit-scrollbar-thumb {
    background: var(--color-support-3); /* Color of the thumb */
    border-radius: 1px; 
    height: 40px;
}

.tournament ul li a {
    background: none;
    border: none;
    cursor: pointer;
    font-weight: normal;
    transition: all 0.3s ease;
    text-decoration: none;
    display: flex;
    width: 100%;
}
.tournament h3 {
    margin: 0;
    padding: 10px;
    background-color: #333333;
    display: flex;
    align-items: center;
}
.categories h3 {
    font-size: 13px;
}
.category-header {
    padding: 10px;
    font-weight: 700;
    font-size: 14px;
    background-color: #2d2d2d;
}
.gT10 {
    gap: 10px;
}
._F_ac {
    align-items: center;
}
.flex {
    display: flex;
}
.tournament a {
    text-decoration: none;
    display: flex;
    justify-content: space-between;
}
.match-card {
    display: flex;
    align-items: center;
    padding: 5px 0;
    width: 100%;
    cursor: pointer;
}
a {
    color: var(--color-support-1);
    text-decoration: none;
} 
li {
    text-align: -webkit-match-parent;
}
.tournament ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    justify-content: space-between;
    flex-direction: column;
}
.match-time-status {
    display: flex;
    flex-direction: column;
    margin-right: 8px;
    padding-right: 8px;
    text-align: center;
    flex: 0 0 45px;
    -webkit-box-flex: 0;
    color: #555;
    border-right: 1px solid rgba(34, 34, 38, 0.5);
}
.team-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #1a1a1a; 
}
/* Adding a slanting background for team-info */
.team-info-data {
    display: flex;
    align-items: center;
    background-color: #002d71;
    padding: 15px 20px;
    clip-path: polygon(0 0, 100% 0, 90% 100%, 0 100%);
    min-width: 500px;
}
.team-info {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    width: calc(100% - 35px);
    margin-left: auto;
}
.teams-info {
    display: flex;
    flex-direction: column;
    overflow-x: clip;
    min-width: 0px;
    margin-left: auto;
    flex: 1 1 140px;
    gap: 3px;
}
.team {
    display: flex;
    align-items: center;
}
.match-odds {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 105px;
    border-right: 1px solid rgba(34, 34, 38, 0.15);
    padding-right: 5px;
}
.odd-choice span:first-child {
    color: rgb(74, 72, 72, 70%);
}

.odds {
    margin: 0 4px;
    font-size: 12px;
    font-weight: 600;
}
.odd-choice {
    display: flex;
    flex-direction: column;
    text-align: center;
    justify-content: space-between;
    gap: 5px;
    flex: 1;
}
.match-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-left: 8px;
    flex: 0 0 20px;
    font-size: 13px;
    font-weight: 600;
    color: var(--color-tabs-secondary-fill-base);
    justify-content: space-around;
    gap: 5px;
} 
.team-name h2 {
  font-size: 1.5em;
  margin-bottom: 5px;
}

.team-name p {
  font-size: 0.9em;
  color: #b3b3b3;
}

.arrow {
  background: none;
  border: none;
  color: white;
  font-size: 2em;
  cursor: pointer;
}

.event-info {
  display: flex;
  align-items: center;
}

.event-date { 
    text-align: right;
    display: flex;
    font-weight: 700;
}
 
.filter-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  background-color: #002865;
}

.date-picker {
  display: flex;
  gap: 10px;
  align-items: center;
}

.date-picker label {
  font-weight: bold;
}

input[type="date"] {
  padding: 5px 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background-color: #fff;
  color: #333;
  font-size: 14px;
}

input[type="date"]::-webkit-calendar-picker-indicator {
  cursor: pointer;
}

.filter-options {
  display: flex;
  gap: 10px;
}

#time-range {
  padding: 5px;
  font-size: 14px; 
  border: 1px solid #ccc;
  background-color: #fff;
  color: #1d1d1d;
  cursor: pointer;
}

#filter-btn {
  padding: 5px 10px;
  border: none; 
  background-color: #00d3ff;
  color: #1d1d1d;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  text-transform: uppercase;
  font-weight: 700;
}

#filter-btn:hover {
  background-color: #45a049;
}

@media (max-width: 600px) {
  .filter-bar {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
}
/* General styling for the calendar container */
.calendar {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5px;
    border-radius: 8px;
}

/* Styling for navigation buttons */
.calendar__navigation {
    background-color: transparent;
    border: none;
    color: #fff;
    font-size: 1.2rem;
    padding: 5px 10px;
    cursor: pointer;
    transition: color 0.2s ease;
}

.calendar__navigation:hover {
    color: #50C878; /* Highlight color on hover (emerald green, from the image) */
}

/* Styling for the date display button */
.calendar__datepicker {
    background-color: transparent;
    border: none;
    color: #fff;
    font-size: 1rem;
    padding: 10px 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}

.calendar__datepicker:focus {
    outline: none;
}

#current-day {
    font-size: 0.9rem;
    color: #B0BEC5; /* Slightly muted text color for the date */
}

/* Styling for the dropdown list */
.calendar__days {
    position: absolute;
    top: 50px; /* Positioned below the button */
    padding: 5px 0;
    border-radius: 8px;
    z-index: 10;
    list-style-type: none;
    margin: 0;
    display: none; /* Initially hidden */
    min-width: 120px; /* Dropdown width */
}

.calendar__days li {
    padding: 10px 15px;
    font-size: 0.9rem;
    color: #fff;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.calendar__days li:hover {
    background-color: #50C878; /* Highlight color (emerald green) on hover */
}

/* Show the dropdown when expanded */
.calendar__datepicker[aria-expanded="true"] ~ .calendar__days {
    display: block;
}

/* Optional: animate dropdown for smooth appearance */
.calendar__days {
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.calendar__datepicker[aria-expanded="true"] ~ .calendar__days {
    opacity: 1;
    transform: translateY(0);
}

/* Buttons styling for accessibility when disabled */
.calendar__navigation[disabled] {
    color: #555; /* Muted color */
    cursor: not-allowed;
}

.calendar__navigation--yesterday,
.calendar__navigation--tomorrow {
    font-size: 1.5rem;
    display: flex;
    align-items: center;
}
/* Date box slanting effect */
.date-box {
    text-align: right;
    background-color: #002d71; /* Dark background like in your screenshot */
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* Subtle shadow */
    padding: 10px 20px;
    clip-path: polygon(20% 0, 100% 0, 100% 100%, 0 100%);
}
.team-stats-container {
    display: flex;
    width: 100%;
}

.team-stats {
    width: 100%;
}
.Data {
        display: flex;
        justify-content: space-between;
}

.Data>div:first-child {
    flex: 2;
    border-right: 1px solid #002d71;
}

.Data>div:not(:first-child) {
    flex: 1;
    border-right: 1px solid #444649;
}

.teams-data {
        display: flex;
        justify-content: space-between; 
        flex-direction: column;
    }
    
.teamInfo {
    display: flex;
    align-items: center;
    gap: 5px; 
}  
.teamInfo h3 {
    padding: 0;
}
    </style>
</head>
<body>
    <header class="team-header" id="superheader">
        <div class="team-info-data">
            <div class="logo">Football Analyzer</div>  
        </div>
        <div class="event-info">
            <div class="event-date">
                <div class="date-box">
                    <div class="calendar">
                        <button class="calendar__navigation calendar__navigation--yesterday" title="Previous day">&#9664;</button>
                        <button id="calendarMenu" aria-expanded="false" class="calendar__datepicker">
                            <span id="current-day">27/09 FR</span> <!-- You can set this dynamically -->
                        </button>
                        <ul aria-labelledby="calendarMenu" class="calendar__days" id="date-list" hidden>
                            <!-- Dates will be appended here dynamically -->
                        </ul>
                        <button class="calendar__navigation calendar__navigation--tomorrow" title="Next day">&#9654;</button>
                    </div>
                </div>
                
            
                <div class="filter-bar">
                    <div>
                        <select id="time-range">
                            <option value="">Select Time</option>
                            <option value="3">3 Hours</option>
                            <option value="6">6 Hours</option>
                            <option value="12">12 Hours</option>
                        </select>
                        <button id="filter-btn">Filter</button>
                    </div> 
                </div>
            </div>
            
        </div>
      </header> 
<main>
    <div id="categories-container" class="categories"></div>
    <div class="content-container">
        <div class="loader" id="loader">Loading data...</div>
        <div id="event-details-div"></div> 
        <div id="odds-container"></div>
        <div id="oddsChart"></div> 
    </div>
</main>
    <script>
        const baseURL = 'https://api.sofascore.com/api/v1';

// Function to fetch JSON data from a URL
async function fetchJson(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Error ${response.status}: ${errorData.message}`);
        }
        return response.json();
    } catch (error) {
        console.error('Fetch error:', error.message);
        return null;
    }
}

// Function to filter events by time
function filterEventsByTime(events, hours) {
    const now = new Date().getTime();
    const timeRange = hours * 60 * 60 * 1000; // Convert hours to milliseconds

    return events.filter(event => {
        const eventTime = new Date(event.startTimestamp * 1000).getTime();
        return eventTime >= now && eventTime <= now + timeRange;
    });
}

const displayCategories = async (startDate, endDate, hours, status) => {
        const topTournamentsUrl = `${baseURL}/config/top-unique-tournaments/UG/football`;
        const scheduledEventsUrl = `${baseURL}/sport/football/scheduled-events/${startDate}`;
        const scheduledEventsUrl2 = `${baseURL}/sport/football/scheduled-events/${startDate}/inverse`;
        const oddsResponse = `${baseURL}/sport/football/odds/1/${startDate}`;

        let filteredEvents = [];
        let odds = {};

        const fetchData = async () => {
            try {
                const topTournamentsData = await fetchJson(topTournamentsUrl);
                const scheduledEventsData = await fetchJson(scheduledEventsUrl);
                const scheduledEventsData2 = await fetchJson(scheduledEventsUrl2);
                const oddsData = await fetchJson(oddsResponse);

                const events = [...scheduledEventsData.events, ...scheduledEventsData2.events];
                odds = oddsData?.odds || {};

                // Filter events
                filteredEvents = events.filter(event => {
                    const eventDate = new Date(event.startTimestamp * 1000).toISOString().split('T')[0];
                    return eventDate >= startDate && eventDate <= endDate;
                });

                if (hours) {
                    filteredEvents = filterEventsByTime(filteredEvents, hours);
                }

                if (status) {
                    filteredEvents = filteredEvents.filter(event => {
                        switch (status) {
                            case 'live':
                                return event.status.type === 'inprogress';
                            case 'finished':
                                return event.status.type === 'finished';
                            case 'scheduled':
                                return event.status.type === 'notstarted';
                            default:
                                return true;
                        }
                    });
                }

                filteredEvents = filteredEvents.filter(event => odds[event.id]);

                const topTournaments = topTournamentsData.uniqueTournaments;
                const topTournamentIds = topTournaments.map(tournament => tournament.id);

                const container = document.getElementById('categories-container');
                container.innerHTML = '';

                const topTournamentsMap = new Map();
                const otherCategoriesMap = new Map();

                filteredEvents.forEach(event => {
                    const homeTeamId = event.homeTeam.id;
                    const awayTeamId = event.awayTeam.id;
                    const categoryName = event.tournament.category.name;
                    const tournamentId = event.tournament.uniqueTournament.id;
                    const tournamentName = event.tournament.name;

                    const targetMap = topTournamentIds.includes(tournamentId) ? topTournamentsMap : otherCategoriesMap;

                    if (!targetMap.has(categoryName)) {
                        targetMap.set(categoryName, new Map());
                    }

                    const tournaments = targetMap.get(categoryName);
                    if (!tournaments.has(tournamentName)) {
                        tournaments.set(tournamentName, {
                            id: tournamentId,
                            events: []
                        });
                    }

                    tournaments.get(tournamentName).events.push(event);
                });

                const createCategorySection = (tournaments, categoryName) => {
                    const categoryItem = document.createElement('div');
                    categoryItem.classList.add('category');

                    const categoryHeader = document.createElement('div');
                    categoryHeader.classList.add('category-header', 'flex', 'gT10', '_F_ac');
                    const categoryImage = tournaments.values().next().value.events[0].tournament.category.alpha2
                        ? tournaments.values().next().value.events[0].tournament.category.alpha2.toLowerCase()
                        : tournaments.values().next().value.events[0].tournament.category.flag;
                    categoryHeader.innerHTML = ` 
                        <img src="https://www.sofascore.com/static/images/flags/${categoryImage}.png" width="20" height="20" loading="lazy" />
                        <span><span class="cat-name">${categoryName}</span></span> 
                    `;
                    categoryHeader.addEventListener('click', () => {
                        categoryItem.classList.toggle('active');
                        const tournamentsContainer = categoryItem.querySelector('.tournaments-container');
                        tournamentsContainer.style.display = categoryItem.classList.contains('active') ? 'block' : 'none';
                    });

                    const tournamentsContainer = document.createElement('div');
                    tournamentsContainer.classList.add('tournaments-container');

                    tournaments.forEach((tournament, tournamentName) => {
                        const tournamentSection = document.createElement('div');
                        tournamentSection.classList.add('tournament');

                        const tournamentHeader = document.createElement('h3');
                        tournamentHeader.classList.add('flex', '_F_ac');
                        const tournamentImage = `${baseURL}/unique-tournament/${tournament.id}/image`;
                        tournamentHeader.innerHTML = `
                            <img class="tourn" src="${tournamentImage}" alt="${tournamentName}" width="16" height="16" loading="lazy" />
                            ${tournamentName}
                        `;
                        tournamentSection.appendChild(tournamentHeader);

                        const eventsList = document.createElement('ul');
                        tournament.events.forEach(event => {
                            const listItem = document.createElement('li');
                            const eventLink = document.createElement('a');
                            eventLink.className = 'match-card';
                            eventLink.dataset.eventId = event.id;
                            eventLink.dataset.customId = event.customId;

                            // Get odds data
                            const oddsData = odds[event.id] || {};
                            const homeFractional = oddsData.choices?.find(choice => choice.name === '1')?.initialFractionalValue;
                            const drawFractional = oddsData.choices?.find(choice => choice.name === 'X')?.initialFractionalValue;
                            const awayFractional = oddsData.choices?.find(choice => choice.name === '2')?.initialFractionalValue;

                            const homeOdds = homeFractional ? fractionalToDecimal(homeFractional) : '-';
                            const drawOdds = drawFractional ? fractionalToDecimal(drawFractional) : '-';
                            const awayOdds = awayFractional ? fractionalToDecimal(awayFractional) : '-';

                            const homeScore = event.homeScore?.current ?? 0;
                            const awayScore = event.awayScore?.current ?? 0;

                            const isHomeTeamWinner = homeScore > awayScore;
                            const isAwayTeamWinner = awayScore > homeScore;

                            const homeTeamName = isHomeTeamWinner ? `<strong>${event.homeTeam.shortName}</strong>` : event.homeTeam.shortName;
                            const awayTeamName = isAwayTeamWinner ? `<strong>${event.awayTeam.shortName}</strong>` : event.awayTeam.shortName;

                            eventLink.innerHTML = `
                                <div class="match-time-status">
                                    <span class="match-time">${new Date(event.startTimestamp * 1000).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }).replace(',', ' ').replace('/', ' ')}</span>
                                    <span class="match-status">${new Date(event.startTimestamp * 1000).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
                                </div>
                                <div class="team-info">
                                    <div class="teams-info">
                                        <div class="team">
                                            <img src="${baseURL}/team/${event.homeTeam.id}/image" width="16" height="16" alt="${event.homeTeam.shortName}" loading="lazy" class="team-logo">
                                            <span class="team-name">${homeTeamName}</span>
                                        </div>
                                        <div class="team">
                                            <img src="${baseURL}/team/${event.awayTeam.id}/image" width="16" height="16" alt="${event.awayTeam.shortName}" loading="lazy" class="team-logo">
                                            <span class="team-name">${awayTeamName}</span>
                                        </div>
                                    </div>
                                    <div class="match-odds">
                                        <div class="odd-choice">
                                            <span class="odds">1</span>
                                            <span class="odds">${homeOdds}</span>
                                        </div>
                                        <div class="odd-choice">
                                            <span class="odds">X</span>
                                            <span class="odds">${drawOdds}</span>
                                        </div>
                                        <div class="odd-choice">
                                            <span class="odds">2</span>
                                            <span class="odds">${awayOdds}</span>
                                        </div>
                                    </div>
                                    <div class="match-score" id="${event.status.type}">
                                        <span class="score" id="homeScore-${event.id}">${event.homeScore?.current ?? ''}</span>
                                        <span class="score" id="awayScore-${event.id}">${event.awayScore?.current ?? ''}</span>
                                    </div>
                                </div> 
                            `; 
                            listItem.appendChild(eventLink);
                            eventsList.appendChild(listItem);
                        });

                        tournamentSection.appendChild(eventsList);
                        tournamentsContainer.appendChild(tournamentSection);
                    });

                    categoryItem.appendChild(categoryHeader);
                    categoryItem.appendChild(tournamentsContainer);
                    return categoryItem;
                };

                topTournamentsMap.forEach((tournaments, categoryName) => {
                    const categoryItem = createCategorySection(tournaments, categoryName);
                    container.appendChild(categoryItem);
                });

                otherCategoriesMap.forEach((tournaments, categoryName) => {
                    const categoryItem = createCategorySection(tournaments, categoryName);
                    container.appendChild(categoryItem);
                });

                if (filteredEvents.length > 0) {
                    loadEventDetails(filteredEvents[0].id, filteredEvents[0].customId);
                    init(filteredEvents[0].id);
                }

                document.querySelectorAll('.match-card').forEach(card => {
                    card.addEventListener('click', async (event) => {
                        const eventId = event.currentTarget.dataset.eventId;
                        const customId = event.currentTarget.dataset.customId;
                        await loadEventDetails(eventId, customId);
                        await init(eventId);
                    });
                });

            } catch (error) {
                console.error('Error displaying categories:', error);
            }
        };
        await fetchData();
    }
        
    document.addEventListener('DOMContentLoaded', () => {
        const dateList = document.getElementById('date-list');
        const currentDay = document.getElementById('current-day');
        let selectedDate = new Date();
        
        const today = new Date().toISOString().split('T')[0];
        let selectedHours = '';
        
        // Display the current selected date at the top
        updateCurrentDateDisplay();

        // Populate the date list with previous, current, and future dates
        generateDateList();

        // Filter and display categories on initial load
        displayCategories(today, today, selectedHours);

        // Filter button click event
        document.getElementById('filter-btn').addEventListener('click', () => {
            const hours = document.getElementById('time-range').value;
            displayCategories(formatSelectedDate(selectedDate), formatSelectedDate(selectedDate), hours);
        });

        // Handle navigation buttons
        document.querySelector('.calendar__navigation--yesterday').addEventListener('click', () => {
            selectedDate.setDate(selectedDate.getDate() - 1);
            updateCurrentDateDisplay();
            generateDateList();
            displayCategories(formatSelectedDate(selectedDate), formatSelectedDate(selectedDate), selectedHours);
        });

        document.querySelector('.calendar__navigation--tomorrow').addEventListener('click', () => {
            selectedDate.setDate(selectedDate.getDate() + 1);
            updateCurrentDateDisplay();
            generateDateList();
            displayCategories(formatSelectedDate(selectedDate), formatSelectedDate(selectedDate), selectedHours);
        });

        function updateCurrentDateDisplay() {
            currentDay.textContent = formatDate(selectedDate);
        }

        function generateDateList() {
            dateList.innerHTML = ''; // Clear existing dates
            for (let i = -5; i <= 7; i++) {
                const date = new Date(selectedDate);
                date.setDate(selectedDate.getDate() + i);

                const li = document.createElement('li');
                li.classList.add('calendar__listItem');
                
                const button = document.createElement('button');
                button.classList.add('calendar__day');
                button.textContent = formatDate(date);

                if (i === 0) {
                    button.classList.add('calendar__day--active');
                }

                // Attach click event to each date button
                button.addEventListener('click', () => {
                    selectedDate = date;
                    updateCurrentDateDisplay();
                    generateDateList();
                    displayCategories(formatSelectedDate(selectedDate), formatSelectedDate(selectedDate), selectedHours);
                });

                li.appendChild(button);
                dateList.appendChild(li);
            }
        }

        function formatDate(date) {
            const options = { day: '2-digit', month: '2-digit', weekday: 'short' };
            return date.toLocaleDateString('en-GB', options);
        }

        function formatSelectedDate(date) {
            return date.toISOString().split('T')[0]; // 'yyyy-mm-dd' format
        }

            });


// Initialize team IDs
let teamIds = {
    homeTeamId: null,
    awayTeamId: null
};


// Function to fetch team names
async function fetchTeamNames(teamIds) {
    const teamNames = {};
    const nameFetchPromises = [
        fetch(`https://api.sofascore.com/api/v1/team/${teamIds.homeTeamId}`)
            .then(response => {
                if (!response.ok) throw new Error(`Failed to fetch team name for ID ${teamIds.homeTeamId}`);
                return response.json();
            })
            .then(data => {
                teamNames.home = data.team.name;
            }),
        fetch(`https://api.sofascore.com/api/v1/team/${teamIds.awayTeamId}`)
            .then(response => {
                if (!response.ok) throw new Error(`Failed to fetch team name for ID ${teamIds.awayTeamId}`);
                return response.json();
            })
            .then(data => {
                teamNames.away = data.team.name;
            })
    ];

    await Promise.all(nameFetchPromises);
    return teamNames;
}

let customId = {
    customId: null
}

// Function to fetch head-to-head data
async function fetchHeadToHead(customId) {
    const response = await fetch(`https://api.sofascore.com/api/v1/event/${customId}/h2h/events`);
    if (!response.ok) throw new Error(`Failed to fetch head-to-head data for event ${customId}`);
    const data = await response.json();

    return data.events.slice(-2); // Get the last 2 head-to-head events
}


// Function to fetch and display team details
async function fetchAndDisplayDetails(teamIds, customId, container) {
    if (!teamIds || !teamIds.homeTeamId || !teamIds.awayTeamId) {
        console.error('Team IDs are required');
        return;
    }

    if (!container) {
        console.error('Container not found!');
        return;
    }

    const loader = document.getElementById('loader');
    loader.style.display = 'block';
    container.innerHTML = '';

    try {
        // Fetch team names
        const teamNames = await fetchTeamNames(teamIds);

        // Check if teamNames object has required properties
        if (!teamNames || !teamNames.home || !teamNames.away) {
            console.error('Invalid team names response:', teamNames);
            return;
        }

        // Fetch team performance data for both home and away teams
        const endpoints = [
            `https://api.sofascore.com/api/v1/team/${teamIds.homeTeamId}/performance`,
            `https://api.sofascore.com/api/v1/team/${teamIds.awayTeamId}/performance`
        ];
        const results = await Promise.all(endpoints.map(fetchAndCheck));

        // Fetch head-to-head data once
        const headToHeadData = await fetchHeadToHead(customId);

        // Display stats for both teams
        const homeData = results[0];
        const homeTeamStats = processTeamStats(homeData.events);
        const homeLast3GamesStats = processLast3GamesStats(homeData.events, true);
        const homeCorrectScores = calculateCorrectScores(homeData.events, true);

        const awayData = results[1];
        const awayTeamStats = processTeamStats(awayData.events);
        const awayLast3GamesStats = processLast3GamesStats(awayData.events, false);
        const awayCorrectScores = calculateCorrectScores(awayData.events, false);

        displayStats(homeTeamStats, homeLast3GamesStats, homeCorrectScores, 
             awayTeamStats, awayLast3GamesStats, awayCorrectScores, 
             teamNames.home, teamIds.homeTeamId, teamNames.away, teamIds.awayTeamId, container, headToHeadData);

        // After displaying both team stats, display the H2H data only once
        displayHeadToHead(headToHeadData, container);

    } catch (error) {
        console.error('Fetch error:', error);
        container.innerHTML = `<p>Error fetching data. Please try again later.</p>`;
    } finally {
        loader.style.display = 'none';
    }
}

// Function to display head-to-head data
function displayHeadToHead(headToHeadData, container) {
    if (!headToHeadData || headToHeadData.length === 0) {
        container.innerHTML += `<p>No Head-to-Head data available.</p>`;
        return;
    }

    const h2hDiv = document.createElement('div');
    h2hDiv.classList.add('head-to-head');
    h2hDiv.innerHTML = `
        <h3>Head-to-Head</h3>
        ${headToHeadData.map((event, index) => `
            <p>Match ${index + 1}: ${event.homeTeam.name} ${event.homeScore.current} - ${event.awayScore.current} ${event.awayTeam.name}</p>
        `).join('')}
    `;
    container.appendChild(h2hDiv);
}


// Function to fetch team IDs by event ID
async function fetchTeamIdsByEvent(eventId) {
    const response = await fetch(`https://api.sofascore.com/api/v1/event/${eventId}`);
    if (!response.ok) throw new Error(`Failed to fetch team IDs for event ${eventId}`);
    const data = await response.json(); 
    
    return {
        homeTeamId: data.event.homeTeam.id,
        awayTeamId: data.event.awayTeam.id
    };
}

// Function to load event details
async function loadEventDetails(eventId, customId) {
    const eventDetailsDiv = document.getElementById('event-details-div');
    if (!eventDetailsDiv) {
        console.error('Event details div not found!');
        return;
    }

    eventDetailsDiv.innerHTML = ''; 

    try {
        teamIds = await fetchTeamIdsByEvent(eventId);
        await fetchAndDisplayDetails(teamIds, customId, eventDetailsDiv);
        await fetchOdds(eventId); // Pass eventId to fetchOdds

    } catch (error) {
        console.error('Error loading event details:', error);
        eventDetailsDiv.innerHTML = `<p>Error loading event details. Please try again later.</p>`;
    }
}

// Function to fetch and check data
async function fetchAndCheck(endpoint) {
    const response = await fetch(endpoint);
    if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);
        return response.json();
}

    function processTeamStats(events) {
    let totalGoalsScored = 0, totalGoalsConceded = 0, wins = 0, draws = 0, losses = 0;
    let over1_5 = 0, over2_5 = 0, over3_5 = 0, under2_5 = 0, btts = 0;
    let drawsHalfTime = 0, cleanSheets = 0, scoredBothHalves = 0, bttsWin = 0, bttsOver2_5 = 0;
    let totalFirstHalfGoals = 0, totalSecondHalfGoals = 0;
    let totalFirstHalfConceded = 0, totalSecondHalfConceded = 0;
    let winAndOver2_5 = 0; // New variable for "Win & Over 2.5"

    const gamesPlayed = events.length;

    events.forEach(event => {
        const { homeScore, awayScore } = event;
        const isHomeTeam = event.homeTeam.id === teamIds.home; 
        const totalScore = homeScore.current + awayScore.current;

        totalGoalsScored += isHomeTeam ? homeScore.current : awayScore.current;
        totalGoalsConceded += isHomeTeam ? awayScore.current : homeScore.current;

        // First and Second Half Goals
        totalFirstHalfGoals += isHomeTeam ? (homeScore.period1 || 0) : (awayScore.period1 || 0);
        totalFirstHalfConceded += isHomeTeam ? (awayScore.period1 || 0) : (homeScore.period1 || 0);
        totalSecondHalfGoals += isHomeTeam ? (homeScore.period2 || 0) : (awayScore.period2 || 0);
        totalSecondHalfConceded += isHomeTeam ? (awayScore.period2 || 0) : (homeScore.period2 || 0);

        // Win/Draw/Loss Logic
        const teamWon = (isHomeTeam && homeScore.current > awayScore.current) || 
                        (!isHomeTeam && awayScore.current > homeScore.current);
        if (teamWon) {
            wins++;
            if (totalScore > 2.5) winAndOver2_5++; // Track "Win & Over 2.5"
        } else if (homeScore.current === awayScore.current) {
            draws++;
        } else {
            losses++;
        }

        // Over/Under, BTTS, Half-time, Clean Sheets, etc.
        if (totalScore > 1.5) over1_5++;
        if (totalScore > 2.5) over2_5++;
        if (totalScore > 3.5) over3_5++;
        if (totalScore < 2.5) under2_5++; 
        if (homeScore.period1 === awayScore.period1) drawsHalfTime++;
        if ((isHomeTeam && awayScore.current === 0) || (!isHomeTeam && homeScore.current === 0)) cleanSheets++;
        if ((isHomeTeam && homeScore.period1 > 0 && homeScore.period2 > 0) || 
            (!isHomeTeam && awayScore.period1 > 0 && awayScore.period2 > 0)) scoredBothHalves++;
        if (homeScore.current > 0 && awayScore.current > 0) { 
            btts++; 
            if (teamWon) {
                bttsWin++; 
            }
            if (totalScore > 2.5) {
                bttsOver2_5++; 
            }
        }
    });

    return {
        gamesPlayed, totalGoalsScored, totalGoalsConceded, wins, draws, losses,
        over1_5, over2_5, over3_5, under2_5, btts, drawsHalfTime, cleanSheets,
        scoredBothHalves, bttsWin, bttsOver2_5, totalFirstHalfGoals, totalSecondHalfGoals,
        totalFirstHalfConceded, totalSecondHalfConceded, winAndOver2_5 // Return the new stat
    };
}


function processLast3GamesStats(events, isHomeTeam) {
    const filteredEvents = events.filter(event => 
        isHomeTeam ? event.homeScore.current != null && event.awayScore.current != null : event.awayScore.current != null && event.homeScore.current != null
    );

    const last3Games = filteredEvents.slice(-3).reverse();

    let gamesScoredIn = 0, goalsScored = 0, over2_5 = 0, lastMatchTotalGoals = 0;
    let firstHalfGoals = 0, secondHalfGoals = 0, lastMatchBTTS = false, lastMatchOver2_5 = false;

    last3Games.forEach((event, i) => {
        const { homeScore, awayScore } = event;

        // Ensure home and away scores are available, default to 0 if undefined
        const homeGoals = homeScore && homeScore.current != null ? homeScore.current : 0;
        const awayGoals = awayScore && awayScore.current != null ? awayScore.current : 0;

        const totalScore = homeGoals + awayGoals;

        const teamGoals = isHomeTeam ? homeGoals : awayGoals;
        if (teamGoals > 0) gamesScoredIn++;
        goalsScored += teamGoals;

        // First Half and Second Half Goals
        firstHalfGoals += isHomeTeam ? (homeScore.period1 || 0) : (awayScore.period1 || 0);
        secondHalfGoals += isHomeTeam ? (homeScore.period2 || 0) : (awayScore.period2 || 0);

        if (totalScore > 2.5) over2_5++;

        if (i === 0) { // Process the last match
            console.log("Last match - Home Goals:", homeScore.current, "Away Goals:", awayScore.current);
            console.log("Home Goals:", homeGoals, "Away Goals:", awayGoals);
            console.log("Total Score:", totalScore);
            lastMatchTotalGoals = totalScore;

            // Check BTTS only if both home and away teams scored
            console.log("BTTS Condition:", homeGoals > 0, awayGoals > 0);
            lastMatchBTTS = homeGoals > 0 && awayGoals > 0;
            console.log("Over 2.5 Condition:", totalScore > 2.5);
            lastMatchOver2_5 = totalScore > 2.5;
        }
    });

    return {
        gamesScoredIn,
        goalsScored,
        over2_5,
        lastMatchTotalGoals,
        firstHalfGoals,
        secondHalfGoals,
        lastMatchBTTS,
        lastMatchOver2_5
    };
}


function displayStats(teamStats1, last3GamesStats1, correctScores1, 
                     teamStats2, last3GamesStats2, correctScores2, 
                     teamName1, teamId1, teamName2, teamId2, container, headToHeadData) {
    // Process stats for both teams
    const {
        gamesPlayed: gamesPlayed1, totalGoalsScored: totalGoalsScored1, totalGoalsConceded: totalGoalsConceded1, 
        wins: wins1, draws: draws1, losses: losses1, 
        over1_5: over1_5_1, over2_5: over2_5_1, over3_5: over3_5_1, under2_5: under2_5_1, 
        btts: btts_1, drawsHalfTime: drawsHalfTime_1, cleanSheets: cleanSheets_1, 
        scoredBothHalves: scoredBothHalves_1, bttsWin: bttsWin_1, bttsOver2_5: bttsOver2_5_1,
        totalFirstHalfGoals: totalFirstHalfGoals_1, totalSecondHalfGoals: totalSecondHalfGoals_1,
        totalFirstHalfConceded: totalFirstHalfConceded_1, totalSecondHalfConceded: totalSecondHalfConceded_1,
    } = teamStats1;

    const {
        gamesPlayed: gamesPlayed2, totalGoalsScored: totalGoalsScored2, totalGoalsConceded: totalGoalsConceded2, 
        wins: wins2, draws: draws2, losses: losses2, 
        over1_5: over1_5_2, over2_5: over2_5_2, over3_5: over3_5_2, under2_5: under2_5_2, 
        btts: btts_2, drawsHalfTime: drawsHalfTime_2, cleanSheets: cleanSheets_2, 
        scoredBothHalves: scoredBothHalves_2, bttsWin: bttsWin_2, bttsOver2_5: bttsOver2_5_2,
        totalFirstHalfGoals: totalFirstHalfGoals_2, totalSecondHalfGoals: totalSecondHalfGoals_2,
        totalFirstHalfConceded: totalFirstHalfConceded_2, totalSecondHalfConceded: totalSecondHalfConceded_2,
    } = teamStats2;

    const {
        gamesScoredIn: gamesScoredIn1, goalsScored: goalsScored1, 
        over2_5: last3GamesOver2_5_1, lastMatchTotalGoals: lastMatchTotalGoals1,
        firstHalfGoals: firstHalfGoals1, secondHalfGoals: secondHalfGoals1, 
        lastMatchBTTS: lastMatchBTTS1, lastMatchOver2_5: lastMatchOver2_51 
    } = last3GamesStats1;

    const {
        gamesScoredIn: gamesScoredIn2, goalsScored: goalsScored2, 
        over2_5: last3GamesOver2_5_2, lastMatchTotalGoals: lastMatchTotalGoals2,
        firstHalfGoals: firstHalfGoals2, secondHalfGoals: secondHalfGoals2, 
        lastMatchBTTS: lastMatchBTTS2, lastMatchOver2_5: lastMatchOver2_52 
    } = last3GamesStats2;

    const averageScored1 = totalGoalsScored1 / gamesPlayed1;
    const averageConceded1 = totalGoalsConceded1 / gamesPlayed1;
    const points1 = (wins1 * 3 + draws1);
    const pointsPerGame1 = points1 / gamesPlayed1;

    const averageScored2 = totalGoalsScored2 / gamesPlayed2;
    const averageConceded2 = totalGoalsConceded2 / gamesPlayed2;
    const points2 = (wins2 * 3 + draws2);
    const pointsPerGame2 = points2 / gamesPlayed2;

    const safeTeamName1 = teamName1.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
    const safeTeamName2 = teamName2.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();

    const teamStatsDiv = document.createElement('div');
    teamStatsDiv.classList.add('team-stats-container');

    // Team 1
    const teamDiv = document.createElement('div');
    teamDiv.classList.add('team-stats');
    teamDiv.innerHTML = ` 
            <div class="Data">
                <div class="teams-data"> 
                    <div class="teamInfo">
                    <div class="team-logo">
                        <img src='${baseURL}/team/${teamId1}/image/small' alt='${teamName1} width="20" height="20" loading="lazy" '>
                    </div>
                    <h3>${teamName1}</h3> 
                    </div> 
                    
                    <div class="teamInfo">
                        <div class="team-logo">
                            <img src='${baseURL}/team/${teamId2}/image/small' alt='${teamName2} width="20" height="20" loading="lazy" '>
                        </div>
                        <h3>${teamName2}</h3> 
                    </div>  
                </div>
            <div class="teams">
                
            </div>
            <div class="teams">
                
            </div>
            <div class="teams">
                
            </div>
        </div>

        <div class="team-stats-block">
            <h3>Goals</h3>
            <p>${over1_5_1}Over 1.5 Goals: ${over1_5_2}</p>
            <p>${over2_5_1}Over 2.5 Goals: ${over2_5_2}</p>
            <p>${over3_5_1}Over 3.5 Goals: ${over3_5_2}</p>
            <p>${under2_5_1}Under 2.5 Goals: ${under2_5_2}</p>
            <p>${cleanSheets_1}Clean Sheets: ${cleanSheets_2}</p>
            <p>${bttsWin_1}Win & Over 2.5 Goals: ${bttsWin_2}</p>
        </div>

        <div class="team-stats-block">
            <h3>BTTS (Both Teams to Score)</h3>
            <p>${btts_1}BTTS: ${btts_2}</p>
            <p>${bttsWin_1}BTTS & Win: ${bttsWin_2}</p>
            <p>${bttsOver2_5_1}BTTS & Over 2.5 Goals: ${bttsOver2_5_2}</p>
        </div>

        <div class="team-stats-block">
            <h3>Halves</h3>
            <p>${drawsHalfTime_1}Draws at Half-Time: ${drawsHalfTime_2}</p>
            <p>${scoredBothHalves_1}Scored in Both Halves: ${scoredBothHalves_2}</p>
            <p>${(totalFirstHalfGoals_1 / gamesPlayed1).toFixed(2)}First Half Goals Scored: ${(totalFirstHalfGoals_2 / gamesPlayed2).toFixed(2)}</p>
            <p>${(totalFirstHalfConceded_1 / gamesPlayed1).toFixed(2)}First Half Goals Conceded: ${(totalFirstHalfConceded_2 / gamesPlayed2).toFixed(2)}</p>
            <p>${(totalSecondHalfGoals_1 / gamesPlayed1).toFixed(2)}Second Half Goals Scored: ${(totalSecondHalfGoals_2 / gamesPlayed2).toFixed(2)}</p>
            <p>${(totalSecondHalfConceded_1 / gamesPlayed1).toFixed(2)}Second Half Goals Conceded: ${(totalSecondHalfConceded_2 / gamesPlayed2).toFixed(2)}</p>
        </div>

        <div class="team-stats-block">
            <h3>Last 3 Home Games</h3>
            <p>${gamesScoredIn1}Games Scored In: ${gamesScoredIn2}</p>
            <p>${goalsScored1}Goals Scored: ${goalsScored2}</p>
            <p>${firstHalfGoals1}First Half Goals: ${firstHalfGoals2}</p>
            <p>${secondHalfGoals1}Second Half Goals: ${secondHalfGoals2}</p>
            <p>${last3GamesOver2_5_1}Over 2.5 Goals in Last 3 Games: ${last3GamesOver2_5_2}</p> 
        </div>
 
        <div class="team-stats-block">
            <h3>Correct Scores</h3>
            <ul id="${safeTeamName1}-correct-scores">
                ${Object.keys(correctScores1).map(score => `<li>${score} - ${correctScores1[score]}</li>`).join('')}
            </ul>
            <ul id="${safeTeamName2}-correct-scores">
                ${Object.keys(correctScores2).map(score => `<li>${score} - ${correctScores2[score]}</li>`).join('')}
            </ul>
        </div> 
    `; 
 
    teamStatsDiv.appendChild(teamDiv); 

    container.appendChild(teamStatsDiv);
}




function calculateCorrectScores(events, isHomeTeam) {
    const scoreCounts = {};

    events.forEach(event => {
        const { homeScore, awayScore } = event;

        // Ensure valid scores
        if (!homeScore || !awayScore || homeScore.normaltime == null || awayScore.normaltime == null) {
            return;
        }

        const homeGoals = homeScore.normaltime || 0;
        const awayGoals = awayScore.normaltime || 0;

        const scoreline = `${homeGoals}:${awayGoals}`;

        if (!scoreCounts[scoreline]) {
            scoreCounts[scoreline] = 0;
        }

        scoreCounts[scoreline]++;
    });

    return scoreCounts;
}


        const fractionalToDecimal = (fractional) => {
            const [numerator, denominator] = fractional.split('/').map(Number);
            return (numerator / denominator + 1).toFixed(2);
        };

        async function fetchOdds(eventId) {
            try {
                const response = await fetch(`https://www.sofascore.com/api/v1/event/${eventId}/odds/1/changes`);
                const data = await response.json();
                return data.changedOdds;
            } catch (error) {
                console.error('Error fetching odds:', error);
            }
        }

        function displayOdds(odds) {
            const container = document.getElementById('odds-container');
            container.innerHTML = '';

            odds.forEach(entry => {
                const timestamp = new Date(entry.timestamp * 1000).toLocaleString();
                const oddsInfo = `
                    <div>
                        <strong>${timestamp}</strong>: 
                        1: ${fractionalToDecimal(entry.choice1.fractionalValue)}, 
                        X: ${fractionalToDecimal(entry.choice2.fractionalValue)}, 
                        2: ${fractionalToDecimal(entry.choice3.fractionalValue)}
                    </div>
                `;
                container.innerHTML += oddsInfo;
            });
        }

        // Function to render chart
function renderChart(odds) {
    // Remove existing chart
    const existingChart = document.querySelector("#oddsChart");
    if (existingChart) {
        existingChart.innerHTML = '';
    }

    const timestamps = '.';
    const choice1 = odds.map(entry => fractionalToDecimal(entry.choice1.fractionalValue));
    const choice2 = odds.map(entry => fractionalToDecimal(entry.choice2.fractionalValue));
    const choice3 = odds.map(entry => fractionalToDecimal(entry.choice3.fractionalValue));

    const options = {
        chart: {
            type: 'line',
            toolbar: { show: false }, // Hide the toolbar
        },
        series: [
            { name: 'Home', data: choice1 },
            { name: 'Draw', data: choice2 },
            { name: 'Away', data: choice3 }
        ],
        xaxis: {
            categories: timestamps,
            labels: { show: true }, // Show x-axis labels
        },
        yaxis: {
            labels: {
                show: true, // Show y-axis labels
                style: {
                    color: '#000' // Change color of y-axis labels if needed
                }
            }
        },
        grid: {
            borderColor: '#1c1c1c', // Change this to your desired grid line color 
        },
        legend: {
            show: true, // Show the legend
            position: 'top',
        },
        stroke: {
            width: 2 // Set the thickness of the lines (default is 2)
        },
        dataLabels: { enabled: false }, // Remove data labels
        tooltip: {
            enabled: false, // Disable tooltips
        },
    };


    const chart = new ApexCharts(document.querySelector("#oddsChart"), options);
    chart.render();
}

        async function init(eventId) {
            const odds = await fetchOdds(eventId);
            if (odds) {
                displayOdds(odds);
                renderChart(odds);
            }
        }
     

    </script>
</body>
</html>
 